<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GridWorks - Backoffice</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.0.1/build/global/luxon.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        :root {
            /* Dark mode colors (default) */
            --primary-color: #3a86ff;
            --primary-hover: #2667cc;
            --background-color: #141414;
            --card-background: #1b1b1c;
            --datetime-background: #d4d4d4;
            --datetime-text: #1b1b1c;
            --text-color: #d4d4d4;
            --text-muted: #858585;
            --border-color: rgba(47, 47, 47, 0.5);
            --hover-color: rgb(32, 32, 32);
            --success-color: #28a745;
            --danger-color: #ff4444;
            --scrollbar-width: 10px;
            --table-header-bg: var(--card-background);
            --table-row-border: rgba(60, 60, 60, 0.3);
            --detail-table-bg: rgba(33, 33, 33, 0.9);
            --brand-text-color: #e5e7eb;
            --input-bg: var(--text-color);
            --input-text: var(--card-background);
            --selected-house-bg: rgba(56, 77, 164, 0.2);
            --selected-house-text: var(--text-color);
        }

        :root[data-theme="light"] {
            /* Light mode colors */
            --primary-color: #3a86ff;
            --primary-hover: #2667cc;
            --background-color: #f8f9fa;
            --card-background: #ffffff;
            --datetime-background: #f1f3f5;
            --datetime-text: #1b1b1c;
            --text-color: #212529;
            --text-muted: #6c757d;
            --border-color: rgba(0, 0, 0, 0.1);
            --hover-color: #f1f3f5;
            --success-color: #28a745;
            --danger-color: #ff4444;
            --scrollbar-width: 10px;
            --table-header-bg: #f8f9fa;
            --table-row-border: rgba(0, 0, 0, 0.1);
            --detail-table-bg: rgba(248, 249, 250, 0.9);
            --brand-text-color: #212529;
            --input-bg: #ffffff;
            --input-text: var(--text-color);
            --selected-house-bg: rgba(56, 77, 164, 0.1);
            --selected-house-text: var(--text-color);
        }
        
        html {
            overflow-y: scroll;
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) var(--background-color);
        }
        
        body {
            font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            color: var(--text-color);
            background-color: var(--background-color);
            line-height: 1.5;
            min-height: 150vh;
            display: flex;
            flex-direction: column;
        }
        
        .navbar {
            background-color: var(--background-color);
            padding: 1rem 0;
            /* border-bottom: 1px solid var(--border-color); */
        }
        
        .navbar-brand {
            font-weight: 600;
            color: var(--text-color);
            letter-spacing: -0.5px;
            text-decoration: none;
            font-family: 'Menlo', 'Montserrat', sans-serif;
            display: flex;
            align-items: center;
            padding-top: 15px;
            gap: 0.5rem;
        }
        
        @media (max-width: 992px) {
            .navbar-brand {
                justify-content: center;
                width: 100%;
            }
            
            .navbar .container {
                justify-content: center;
            }
        }
        
        .navbar-brand:hover {
            color: var(--text-color);
        }
        
        .brand-text {
            font-weight: 400;
            font-size: 1.3rem;
            color: var(--brand-text-color);
            letter-spacing: -0.5px;
        }
        
        .brand-subtitle {
            color: var(--text-muted);
            font-weight: 500;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        
        .navbar-brand i {
            color: var(--primary-color);
        }
        
        .main-container {
            max-width: 1000px;
            min-height: 100vh;
            margin: 3rem auto 2rem auto;
            padding: 0 1.5rem;
            flex: 1;
        }
        
        .card {
            background-color: var(--card-background);
            border-radius: 0.25rem;
            border: 1px solid var(--border-color);
            overflow: hidden;
            margin-bottom: 3rem;
            transition: all 0.3s ease;
        }

        .card.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            margin: 0;
            z-index: 1000;
            border-radius: 0;
            overflow-y: auto;
        }

        .card.fullscreen .p-4 {
            border-bottom: solid 1px var(--border-color);
        }

        .card.fullscreen #plot-container {
            border: none;
        }

        /* TODO */
        /* .card.fullscreen .card-header {
            position: sticky;
            top: 0;
            z-index: 1001;
        } */

        .card.fullscreen #plot-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-left: auto;
            margin-right: auto;
        }

        .fullscreen-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            background-color: var(--hover-color);
        }

        .fullscreen-btn:hover {
            background-color: var(--hover-color);
            color: var(--text-color);
        }

        .snapshot-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            background-color: var(--hover-color);
            margin-right: 0.5rem;
        }

        .snapshot-btn:hover {
            background-color: var(--hover-color);
            color: var(--text-color);
        }
        
        .card-header {
            background-color: var(--card-background);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 1.5rem;
        }
        
        .card-title {
            margin: 0;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-color);
        }
        
        .status-badges {
            display: flex;
            gap: 0.75rem;
            margin-left: auto;
            align-items: center;
        }
        
        .filter-toggle {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            background-color: var(--hover-color);
            /* border: 1px solid var(--border-color); */
        }

        #filter-toggle {
            background-color: var(--card-background);
        }
        
        .filter-toggle:hover {
            /* background-color: var(--hover-color); */
            color: var(--text-color);
        }
        
        .filter-toggle i {
            font-size: 0.875rem;
            transition: transform 0.3s ease;
        }
        
        .status-badge {
            display: flex;
            align-items: center;
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 0.25rem;
        }
        
        .status-badge-count {
            padding: 0.425rem 0.7rem;
            border-radius: 0.25rem;
            font-weight: 600;
        }
        
        .status-badge.ok {
            background-color: rgba(40, 167, 69, 0.2);
            color: var(--success-color);
        }
        
        .status-badge.offline {
            background-color: rgba(220, 53, 69, 0.2);
            color: var(--danger-color);
        }
        
        .search-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin: 1.5rem 0 0 0;
            padding: 0 1.5rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1.5rem;
            display: none;
        }
        
        .search-container.visible {
            display: flex;
        }
        
        .search-group {
            display: flex;
            flex-direction: column;
            position: relative;
            width: 150px;
            flex: none;
        }
        
        .search-input-wrapper {
            position: relative;
            width: 100%;
        }
        
        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 0.75rem;
            pointer-events: none;
            z-index: 1;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .search-input {
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 0.5rem 0.75rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            width: 100%;
            padding-left: 2rem;
            height: 2.5rem;
            line-height: 1.5;
        }
        
        .search-group.alias {
            flex: none;
        }
        
        .search-group.city {
            flex: none;
        }
        
        .search-group.status {
            flex: none;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #ff6b6b;
            box-shadow: none;
            background-color: rgba(255, 107, 107, 0.05);
        }
        
        .search-input::placeholder {
            color: var(--text-muted);
        }
        
        .search-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }
        
        .search-group {
            display: flex;
            flex-direction: column;
        }
        
        /* Main table styling */
        .table-responsive > .table {
            margin-bottom: 0;
            color: var(--text-color);
            width: 100%;
            table-layout: fixed;
        }
        
        .table-responsive > .table > thead > tr > th {
            font-weight: 500;
            color: var(--text-muted);
            background-color: var(--table-header-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 0.75rem 1.5rem;
            font-size: 0.875rem;
            cursor: pointer;
            position: relative;
            user-select: none;
        }
        
        .table-responsive > .table > thead > tr > th:hover {
            background-color: var(--hover-color);
        }
        
        .table-responsive > .table > thead > tr > th::after {
            content: '';
            position: absolute;
            right: 0.5rem;
            opacity: 0.3;
        }
        
        .table-responsive > .table > thead > tr > th.sort-asc::after {
            content: '↓';
            opacity: 1;
        }
        
        .table-responsive > .table > thead > tr > th.sort-desc::after {
            content: '↑';
            opacity: 1;
        }
        
        .table-responsive > .table > tbody > tr > td {
            padding: 0.75rem 1.5rem;
            vertical-align: middle;
            border-bottom: 0.5px solid var(--table-row-border);
            font-size: 0.875rem;
        }
        @media (max-width: 800px) {
            .table-responsive > .table > thead > tr > th:first-child,
            .table-responsive > .table > tbody > tr > td:first-child {
                width: 27%;
            }
            
            .table-responsive > .table > thead > tr > th:nth-child(2),
            .table-responsive > .table > tbody > tr > td:nth-child(2) {
                width: 36%;
            }
            
            .table-responsive > .table > thead > tr > th:nth-child(3),
            .table-responsive > .table > tbody > tr > td:nth-child(3) {
                width: 36%;
            }
            
            /* TODO: Add back in later when ready */
            /* .table-responsive > .table > thead > tr > th:nth-child(4),
            .table-responsive > .table > tbody > tr > td:nth-child(4) {
                width: 20%;
            } */
        }

        @media (min-width: 800px) {
            .table-responsive > .table > thead > tr > th:first-child,
            .table-responsive > .table > tbody > tr > td:first-child {
                width: 30%;
            }
            
            .table-responsive > .table > thead > tr > th:nth-child(2),
            .table-responsive > .table > tbody > tr > td:nth-child(2) {
                width: 35%;
            }
            
            .table-responsive > .table > thead > tr > th:nth-child(3),
            .table-responsive > .table > tbody > tr > td:nth-child(3) {
                width: 35%;
            }
            
            /* TODO: Add back in later when ready */
            /* .table-responsive > .table > thead > tr > th:nth-child(4),
            .table-responsive > .table > tbody > tr > td:nth-child(4) {
                width: 25%;
            } */
        }
        
        .table-responsive > .table > tbody > tr.expandable-row {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .table-responsive > .table > tbody > tr.expandable-row.expanded {
            background-color: rgba(56, 77, 164, 0.2);
        }
        
        .table-responsive > .table > tbody > tr.expandable-row:hover {
            background-color: var(--hover-color);
        }
        
        .table-responsive > .table > tbody > tr.expandable-row.expanded:hover {
            background-color: rgba(56, 77, 164, 0.2);
        }
        
        .table-responsive > .table > tbody > tr:last-child > td {
            border-bottom: none;
        }
        
        .json-cell {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .badge {
            font-weight: 500;
            padding: 0.25em 0.5em;
            border-radius: 0.25rem;
            font-size: 0.75rem;
        }
        
        .bg-success {
            font-weight: 600;
            background-color: rgba(40, 167, 69, 0.2) !important;
            color: var(--success-color);
        }
        
        .bg-danger {
            background-color: rgba(220, 53, 69, 0.2) !important;
            color: var(--danger-color);
        }
        
        .bg-warning {
            background-color: rgba(255, 193, 7, 0.2) !important;
            color: #ffc107;
        }
        
        .bg-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .empty-state {
            padding: 2rem 1.5rem;
            text-align: center;
            color: var(--text-muted);
        }
        
        .empty-state i {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: var(--text-muted);
        }
        
        .empty-state h3 {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }
        
        .empty-state p {
            margin-bottom: 1.5rem;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            font-size: 0.875rem;
            padding: 0.375rem 0.75rem;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-hover);
            border-color: var(--primary-hover);
        }
        
        .footer {
            text-align: center;
            padding: 2rem 0;
            color: var(--text-muted);
            font-size: 0.75rem;
            /* border-top: 1px solid var(--border-color); */
            margin-top: auto;
            background-color: var(--background-color);
        }
        
        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }
        
        .footer-links {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        @media (max-width: 768px) {
            .footer-links {
                flex-direction: column;
                align-items: left;
            }
        }
        
        .footer-link {
            color: var(--text-muted);
            text-decoration: none;
            transition: color 0.2s ease;
        }
        
        .footer-link:hover {
            color: var(--text-color);
        }
        
        .footer-copyright {
            color: var(--text-muted);
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: var(--scrollbar-width);
            height: var(--scrollbar-width);
        }
        
        ::-webkit-scrollbar-track {
            background: var(--background-color);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
        
        /* Code-like styling for JSON cells */
        .json-cell {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.8rem;
        }
        
        /* Expanded row details */
        .row-details {
            display: none;
            padding: 1.5rem;
            background-color: var(--card-background);
            border-top: 0.5px solid rgba(60, 60, 60, 0.3);
        }
        
        .row-details.expanded {
            display: block;
        }
        
        .details-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .detail-item {
            margin-bottom: -0.25rem;
        }
        
        .detail-item.full-width {
            grid-column: 1 / -1;
        }
        
        .detail-label {
            font-weight: 500;
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-bottom: 0.25rem;
        }
        
        .detail-value {
            color: var(--text-color);
            font-size: 0.9rem;
            word-break: break-word;
        }
        
        .json-detail {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.8rem;
            white-space: pre-wrap;
            background-color: rgba(0, 0, 0, 0.2);
            padding: 0.5rem;
            border-radius: 0.25rem;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .no-results {
            padding: 2rem 1.5rem;
            text-align: center;
            color: var(--text-muted);
        }
        
        .no-results i {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--text-muted);
        }
        
        .no-results h3 {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }
        
        .no-results p {
            margin-bottom: 1rem;
        }
        
        .no-results-row {
            text-align: center;
            color: var(--text-muted);
            background-color: var(--card-background);
            height: 120px;
        }
        
        .no-results-row td {
            padding: 0;
            border-bottom: none;
            text-align: center;
            vertical-align: middle;
            color: var(--text-muted);
            font-style: italic;
            font-size: 0.875rem;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .no-results-row td span {
            padding: 0.5rem 1rem;
        }
        
        .no-results-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            width: 100%;
        }
        
        .no-results-icon {
            font-size: 2rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }
        
        .no-results-text {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text-color);
        }
        
        .table td:focus,
        .table th:focus {
            outline: none;
        }
        
        .search-input.active {
            border-color: #ff6b6b;
            background-color: rgba(255, 107, 107, 0.05);
        }
        
        .clear-filters-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            font-size: 0.75rem;
            padding: 0.5rem 0.75rem;
            border-radius: 0.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            height: 2.5rem;
            transition: all 0.2s ease;
        }
        
        .clear-filters-btn:hover {
            background-color: var(--hover-color);
            color: var(--text-color);
        }
        
        /* Override table hover styles */
        .table tbody tr.expandable-row:hover {
            background-color: var(--hover-color);
        }

        .table tbody tr:not(.expandable-row):hover {
            background-color: transparent;
        }
        
        /* Detail table styling */
        .detail-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 0.25rem;
            table-layout: fixed;
        }

        .detail-table th,
        .detail-table td {
            padding: 0.5rem 1rem;
            text-align: left;
            font-size: 0.875rem;
            word-wrap: break-word;
            white-space: normal;
        }

        .detail-table th {
            font-weight: 500;
            color: var(--text-muted);
            width: 120px;
            background-color: var(--detail-table-bg);
            border-radius: 4px 0 0 4px;
        }

        .detail-table td {
            color: var(--text-color);
            background-color: var(--detail-table-bg);
            border-radius: 0 4px 4px 0;
            width: auto;
        }

        .detail-table th::after {
            content: none !important;
        }

        .detail-table tr {
            margin-bottom: 0.25rem;
        }

        @media (max-width: 768px) {
            .detail-table th {
                width: 100px;
            }
        }

        @media (max-width: 480px) {
            .detail-table th {
                width: 80px;
            }
        }

        .username {
            color: var(--text-color);
            padding-right: 1rem;
        }
        
        .btn-outline-secondary {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            background-color: var(--hover-color);
        }
        
        .btn-outline-secondary:hover {
            background-color: var(--hover-color);
            color: var(--text-color);
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            padding: 1rem 1.5rem;
            background-color: var(--card-background);
        }

        .action-buttons .btn {
            font-size: 0.875rem;
            padding: 0.375rem 0.75rem;
        }

        /* Map card styling */
        .map-card {
            height: 400px;
            margin-bottom: 3rem;
        }

        .map-container {
            height: 100%;
            width: 100%;
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
            border-radius: 0 0 0.25rem 0.25rem;
        }

        .map-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text-muted);
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .map-loading i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Plot container styling */
        #plot-container {
            margin-top: 0.5rem;
            padding: 0;
            padding-top: 1rem;
            background-color: var(--card-background);
            border-top: 1px solid var(--border-color);
        }

        .plot-div {
            margin-bottom: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }

        .plot-div:last-child {
            margin-bottom: 0;
        }

        /* Loader styling */
        .loader {
            display: none;
            width: 20px;
            height: 20px;
            border: 4px solid var(--text-muted);
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.75s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #plot-btn:disabled + .loader {
            display: inline-block;
        }

        /* Options styling */
        .options-container {
            display: none;
            margin-bottom: 3rem;
            padding: 0.5rem 2rem;
            max-height: 2000px;
            overflow-y: scroll;
        }

        .options-content {
            max-width: 400px;
        }

        .options-section {
            margin-bottom: 1.5rem;
        }

        .options-section h6 {
            font-weight: 500;
            font-size: 0.875rem;
            color: var(--text-color);
            margin-bottom: 0.75rem;
        }

        .options-section input[type="checkbox"] {
            appearance: none;
            width: 22px;
            height: 22px;
            border: 2px solid var(--text-muted);
            border-radius: 4px;
            background-color: transparent;
            position: relative;
            cursor: pointer;
            margin-right: 10px;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            vertical-align: middle;
        }

        .options-section input[type="checkbox"]:checked {
            background-color: var(--text-muted);
            border-color: var(--text-muted);
        }

        .options-section label {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
            color: var(--text-color);
            padding-left: 0.5rem;
            cursor: pointer;
        }

        #selected-house,
        #info-selected-house,
        #electricity-selected-house,
        #data-download-selected-house {
            border: none;
            cursor: pointer;
            background-color: var(--selected-house-bg) !important;
            color: var(--selected-house-text) !important;
        }
        
        /* Placeholder styling */
        #selected-house::placeholder,
        #info-selected-house::placeholder,
        #electricity-selected-house::placeholder,
        #data-download-selected-house::placeholder {
            color: var(--text-muted) !important;
            font-size: 0.875rem;
            opacity: 0.7;
        }
        
        input[type="date"],
        input[type="time"] {
            background-color: var(--datetime-background);
            color: var(--datetime-text);
            border: 1px solid var(--border-color) !important;
            font-size: 0.875rem !important;
            padding: 0.25rem 0.5rem !important;
            height: auto !important;
        }

        /* Add these styles */
        .theme-selector {
            display: flex;
            align-items: center;
            background-color: var(--hover-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 2px;
        }

        .theme-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            border: none;
            background: none;
            color: var(--text-muted);
            border-radius: 4px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
        }

        .theme-btn:hover {
            color: var(--text-color);
        }

        .theme-btn.active {
            color: var(--text-color);
            background-color: var(--card-background);
        }

        .footer-links {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        #morning-checkboxDiv input[type="checkbox"] {
            appearance: none;
            width: 22px;
            height: 22px;
            border: 2px solid var(--text-muted);
            border-radius: 4px;
            background-color: transparent;
            position: relative;
            cursor: pointer;
            margin-right: 10px;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        #morning-checkboxDiv input[type="checkbox"]:checked {
            background-color: var(--text-muted);
            border-color: var(--text-muted);
        }
        #morning-checkboxDiv label {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
            color: var(--text-muted);
            font-size: 0.875rem;
            padding-left: 0.5rem;
            cursor: pointer;
        }

        /* Card visibility controls styling */
        .card-visibility-controls {
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            justify-content: center;
        }

        .card-toggle-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 0.875rem;
            padding: 0.375rem 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 0;
            border-radius: 0.25rem;
        }

        .card-toggle-btn:hover {
            color: var(--text-color);
        }

        .card-toggle-btn.active {
            background-color: var(--hover-color) !important;
            color: var(--text-color);
        }

        .card-toggle-btn.active:hover {
            background-color: var(--hover-color) !important;
        }

        /* Hide cards by default */
        .card.hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="#">
                <div>
                    <span class="brand-text">GridWorks</span>
                </div>
            </a>
            <div class="d-flex align-items-center gap-3">
                <span class="username" style="font-size: 0.9rem;" id="username-display">User</span>
                <a href="#" class="btn btn-outline-secondary btn-sm" id="logout-button">Logout</a>
            </div>
        </div>
    </nav>
    
    <div class="main-container">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title">Houses</h5>
                <div class="status-badges">
                    <button class="filter-toggle" id="filter-toggle" title="Filter table">
                        <i class="bi bi-funnel fs-6"></i>
                    </button>
                    <!-- TODO: Add back in later when ready -->
                    <!-- <button class="btn btn-sm btn-outline-secondary" id="add-house-btn" title="Listen to ATN">
                        <i class="bi bi-headphones fs-6"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" id="remove-house-btn" title="Don't listen to ATN">
                        <i class="bi bi-incognito fs-6"></i>
                    </button> -->
                    <button class="btn btn-sm btn-outline-secondary" id="update-scada-btn" title="Update SCADA code">
                        <i class="bi bi-cloud-download fs-6"></i>
                    </button>
                    <div class="status-badge ok">
                        <span class="status-badge-count">0</span>
                    </div>
                    <div class="status-badge offline">
                        <span class="status-badge-count">0</span>
                    </div>
                </div>
            </div>
            
            <div class="search-container">
                <div class="search-group alias">
                    <div class="search-input-wrapper">
                        <i class="bi bi-search search-icon"></i>
                        <input type="text" class="search-input" id="search-alias" placeholder="Alias">
                    </div>
                </div>
                <div class="search-group city">
                    <div class="search-input-wrapper">
                        <i class="bi bi-search search-icon"></i>
                        <input type="text" class="search-input" id="search-city" placeholder="Location">
                    </div>
                </div>
                <div class="search-group commit">
                    <div class="search-input-wrapper">
                        <i class="bi bi-search search-icon"></i>
                        <input type="text" class="search-input" id="search-commit" placeholder="Commit">
                    </div>
                </div>
                <!-- TODO: Add back in later when ready -->
                <!-- <div class="search-group status">
                    <div class="search-input-wrapper">
                        <i class="bi bi-search search-icon"></i>
                        <input type="text" class="search-input" id="search-status" placeholder="Status">
                    </div>
                </div> -->
                <button class="clear-filters-btn" id="clear-filters">
                    <i class="bi bi-x-lg"></i>
                    Clear
                </button>
            </div>
            
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th data-sort="short_alias">Alias</th>
                            <th data-sort="address">Location</th>
                            <th data-sort="commit">Commit</th>
                            <!-- TODO: Add back in later when ready -->
                            <!-- <th data-sort="status">Status</th> -->
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <!-- Houses will be loaded dynamically -->
                    </tbody>
                </table>
            </div>
            <div class="empty-state" style="display: none;">
                <h3>No homes found</h3>
                <p>There are no homes in the database yet.</p>
            </div>
            
            <div class="no-results" style="display: none;">
                <h3>No results found</h3>
                <button class="btn btn-primary" id="clear-search">Clear Search</button>
            </div>
        </div>

        <!-- Card Visibility Controls -->
        <div class="card-visibility-controls" style="margin-top:-0rem; margin-bottom:2.5rem;">
            <button type="button" class="card-toggle-btn active" id="show-dashboard" data-card="dashboard-card">Dashboard</button>
            <button type="button" class="card-toggle-btn" id="show-visualizer" data-card="visualizer-card">Visualizer</button>
            <button type="button" class="card-toggle-btn" id="show-data-download" data-card="data-download-card">Channel data</button>
            <button type="button" class="card-toggle-btn" id="show-electricity" data-card="electricity-card">Hourly data</button>
            <button type="button" class="card-toggle-btn" id="show-information" data-card="information-card">Information</button>
            <button type="button" class="card-toggle-btn" id="show-morning-report" data-card="morning-report-card">Morning report</button>
            <button type="button" class="card-toggle-btn" id="show-map" data-card="map-card" style="display: none;">Map</button>
        </div>

        <!-- Dashboard Card -->
        <div class="card" id="dashboard-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title">Dashboard</h5>
                <div class="status-badges">
                    <button class="snapshot-btn" id="dashboard-snapshot-btn" title="Request Snapshot">
                        <i class="bi bi-camera"></i>
                    </button>
                    <button class="fullscreen-btn" id="dashboard-fullscreen-btn">
                        <i class="bi bi-arrows-fullscreen"></i>
                    </button>
                </div>
            </div>
            <div class="p-4">
                <!-- Dashboard Status Bar -->
                <div id="dashboard-status" style="text-align: center; padding: 8px 20px;">
                    <div id="dashboard-status-left" style="font-size: 1em;">Connecting...</div>
                    <div id="dashboard-status-right" style="font-size: 0.9em;"></div>
                </div>
                
                <!-- Last Snapshot Timestamp -->
                <div id="dashboard-snapshot-timestamp" style="text-align: center; margin-top: 0rem; color: var(--text-muted); font-size: 0.8rem;">
                    Last snapshot: <span id="dashboard-snapshot-time">-</span>

                    <!-- Loader -->
                    <div id="dashboard-loader" style="text-align: center; margin-top: 0.5rem; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <span style="color: var(--text-muted); font-size: 0.8rem;">Next snapshot:</span>
                        <div id="loader-bar" style="width: 120px; height: 3px; background-color: var(--border-color); border-radius: 2px; position: relative; overflow: hidden;">
                            <div id="loader-progress" style="width: 0%; height: 100%; background-color: var(--primary-color); border-radius: 2px;"></div>
                        </div>
                    </div>
                    
                </div>        
                
                <!-- System Diagram -->
                <div id="dashboard-system-diagram" style="text-align: center; max-width: 100%; margin: 0 auto 2rem auto;">
                    <svg id="dashboard-diagram-svg" viewBox="0 0 1000 500" style="width: 100%; height: auto; max-width: 1000px;">
                        <defs>
                            <!-- Dynamic gradient for heat pump animation (EWT to LWT) -->
                            <linearGradient id="dashboardHeatGradient" x1="0%" y1="100%" x2="0%" y2="0%">
                                <stop id="dashboard-ewt-stop" offset="25%" style="stop-color:#888; stop-opacity:1" />
                                <stop id="dashboard-lwt-stop" offset="75%" style="stop-color:#888; stop-opacity:1" />
                            </linearGradient>
                            
                            <!-- Dynamic gradient for house animation (dist-rwt to dist-swt, left to right) -->
                            <linearGradient id="dashboardHouseHeatGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop id="dashboard-dist-rwt-stop" offset="25%" style="stop-color:#888; stop-opacity:1" />
                                <stop id="dashboard-dist-swt-stop" offset="75%" style="stop-color:#888; stop-opacity:1" />
                            </linearGradient>
                            
                            <!-- Flow pattern for HpOffStoreDischarge top horizontal pipe -->
                            <pattern id="dashboardFlowPattern" x="0" y="0" width="90" height="15" patternUnits="userSpaceOnUse">
                                <rect width="90" height="15" fill="#4CAF50"/>
                                <rect x="0" y="0" width="15" height="15" fill="#66BB6A"/>
                                <rect x="30" y="0" width="15" height="15" fill="#66BB6A"/>
                                <rect x="60" y="0" width="15" height="15" fill="#66BB6A"/>
                                <animateTransform
                                    attributeName="patternTransform"
                                    type="translate"
                                    values="0 0; 90 0"
                                    dur="1.2s"
                                    repeatCount="indefinite"/>
                            </pattern>
                            
                            <!-- Flow pattern for HpOffStoreDischarge vertical pipe (upward flow) -->
                            <pattern id="dashboardVerticalFlowPattern" x="0" y="0" width="15" height="90" patternUnits="userSpaceOnUse">
                                <rect width="15" height="90" fill="#4CAF50"/>
                                <rect x="0" y="0" width="15" height="15" fill="#66BB6A"/>
                                <rect x="0" y="30" width="15" height="15" fill="#66BB6A"/>
                                <rect x="0" y="60" width="15" height="15" fill="#66BB6A"/>
                                <animateTransform
                                    attributeName="patternTransform"
                                    type="translate"
                                    values="0 0; 0 -90"
                                    dur="1.2s"
                                    repeatCount="indefinite"/>
                            </pattern>
                            
                            <!-- Flow pattern for HpOffStoreDischarge vertical pipe (downward flow) -->
                            <pattern id="dashboardVerticalDownFlowPattern" x="0" y="0" width="15" height="90" patternUnits="userSpaceOnUse">
                                <rect width="15" height="90" fill="#4CAF50"/>
                                <rect x="0" y="0" width="15" height="15" fill="#66BB6A"/>
                                <rect x="0" y="30" width="15" height="15" fill="#66BB6A"/>
                                <rect x="0" y="60" width="15" height="15" fill="#66BB6A"/>
                                <animateTransform
                                    attributeName="patternTransform"
                                    type="translate"
                                    values="0 0; 0 90"
                                    dur="1.2s"
                                    repeatCount="indefinite"/>
                            </pattern>
                            
                            <!-- Flow pattern for HpOffStoreDischarge horizontal pipe (leftward flow) -->
                            <pattern id="dashboardLeftFlowPattern" x="0" y="0" width="90" height="15" patternUnits="userSpaceOnUse">
                                <rect width="90" height="15" fill="#4CAF50"/>
                                <rect x="0" y="0" width="15" height="15" fill="#66BB6A"/>
                                <rect x="30" y="0" width="15" height="15" fill="#66BB6A"/>
                                <rect x="60" y="0" width="15" height="15" fill="#66BB6A"/>
                                <animateTransform
                                    attributeName="patternTransform"
                                    type="translate"
                                    values="0 0; -90 0"
                                    dur="1.2s"
                                    repeatCount="indefinite"/>
                            </pattern>
                            
                            <!-- Moving heat lines pattern -->
                            <pattern id="dashboardHeatLinesPattern" x="0" y="0" width="20" height="120" patternUnits="userSpaceOnUse">
                                <path d="M 3,10 Q 10,7 17,10 Q 10,13 3,10" fill="#999" opacity="0.12"/>
                                <path d="M 3,30 Q 10,27 17,30 Q 10,33 3,30" fill="#999" opacity="0.12"/>
                                <path d="M 3,50 Q 10,47 17,50 Q 10,53 3,50" fill="#999" opacity="0.12"/>
                                <path d="M 3,70 Q 10,67 17,70 Q 10,73 3,70" fill="#999" opacity="0.12"/>
                                <path d="M 3,90 Q 10,87 17,90 Q 10,93 3,90" fill="#999" opacity="0.12"/>
                                <path d="M 3,110 Q 10,107 17,110 Q 10,113 3,110" fill="#999" opacity="0.12"/>
                                <animateTransform
                                    attributeName="patternTransform"
                                    type="translate"
                                    values="0 0; 0 -120"
                                    dur="3s"
                                    repeatCount="indefinite"/>
                            </pattern>
                            
                            <!-- Buffer heat lines pattern - top to bottom flow -->
                            <pattern id="dashboardBufferHeatLinesTopToBottom" x="0" y="0" width="20" height="120" patternUnits="userSpaceOnUse">
                                <path d="M 3,10 Q 10,7 17,10 Q 10,13 3,10" fill="#999" opacity="0.12"/>
                                <path d="M 3,30 Q 10,27 17,30 Q 10,33 3,30" fill="#999" opacity="0.12"/>
                                <path d="M 3,50 Q 10,47 17,50 Q 10,53 3,50" fill="#999" opacity="0.12"/>
                                <path d="M 3,70 Q 10,67 17,70 Q 10,73 3,70" fill="#999" opacity="0.12"/>
                                <path d="M 3,90 Q 10,87 17,90 Q 10,93 3,90" fill="#999" opacity="0.12"/>
                                <path d="M 3,110 Q 10,107 17,110 Q 10,113 3,110" fill="#999" opacity="0.12"/>
                                <animateTransform
                                    attributeName="patternTransform"
                                    type="translate"
                                    values="0 0; 0 120"
                                    dur="3s"
                                    repeatCount="indefinite"/>
                            </pattern>
                            
                            <!-- Buffer heat lines pattern - bottom to top flow -->
                            <pattern id="dashboardBufferHeatLinesBottomToTop" x="0" y="0" width="20" height="120" patternUnits="userSpaceOnUse">
                                <path d="M 3,10 Q 10,7 17,10 Q 10,13 3,10" fill="#999" opacity="0.12"/>
                                <path d="M 3,30 Q 10,27 17,30 Q 10,33 3,30" fill="#999" opacity="0.12"/>
                                <path d="M 3,50 Q 10,47 17,50 Q 10,53 3,50" fill="#999" opacity="0.12"/>
                                <path d="M 3,70 Q 10,67 17,70 Q 10,73 3,70" fill="#999" opacity="0.12"/>
                                <path d="M 3,90 Q 10,87 17,90 Q 10,93 3,90" fill="#999" opacity="0.12"/>
                                <path d="M 3,110 Q 10,107 17,110 Q 10,113 3,110" fill="#999" opacity="0.12"/>
                                <animateTransform
                                    attributeName="patternTransform"
                                    type="translate"
                                    values="0 120; 0 0"
                                    dur="3s"
                                    repeatCount="indefinite"/>
                            </pattern>
                            
                            <!-- Moving heat lines pattern for house (uniform, seamless) -->
                            <pattern id="dashboardHouseHeatLinesPattern" x="0" y="0" width="120" height="20" patternUnits="userSpaceOnUse">
                                <path d="M 10,3 Q 7,10 10,17 Q 13,10 10,3" fill="#999" opacity="0.12"/>
                                <path d="M 30,3 Q 27,10 30,17 Q 33,10 30,3" fill="#999" opacity="0.12"/>
                                <path d="M 50,3 Q 47,10 50,17 Q 53,10 50,3" fill="#999" opacity="0.12"/>
                                <path d="M 70,3 Q 67,10 70,17 Q 73,10 70,3" fill="#999" opacity="0.12"/>
                                <path d="M 90,3 Q 87,10 90,17 Q 93,10 90,3" fill="#999" opacity="0.12"/>
                                <path d="M 110,3 Q 107,10 110,17 Q 113,10 110,3" fill="#999" opacity="0.12"/>
                                <animateTransform
                                    attributeName="patternTransform"
                                    type="translate"
                                    values="0 0; -120 0"
                                    dur="3s"
                                    repeatCount="indefinite"/>
                            </pattern>
                            
                            <!-- Tank heat lines pattern - top to bottom flow -->
                            <pattern id="dashboardTankHeatLinesTopToBottom" x="0" y="0" width="20" height="120" patternUnits="userSpaceOnUse">
                                <path d="M 3,10 Q 10,7 17,10 Q 10,13 3,10" fill="#999" opacity="0.12"/>
                                <path d="M 3,30 Q 10,27 17,30 Q 10,33 3,30" fill="#999" opacity="0.12"/>
                                <path d="M 3,50 Q 10,47 17,50 Q 10,53 3,50" fill="#999" opacity="0.12"/>
                                <path d="M 3,70 Q 10,67 17,70 Q 10,73 3,70" fill="#999" opacity="0.12"/>
                                <path d="M 3,90 Q 10,87 17,90 Q 10,93 3,90" fill="#999" opacity="0.12"/>
                                <path d="M 3,110 Q 10,107 17,110 Q 10,113 3,110" fill="#999" opacity="0.12"/>
                                <animateTransform
                                    attributeName="patternTransform"
                                    type="translate"
                                    values="0 0; 0 120"
                                    dur="3s"
                                    repeatCount="indefinite"/>
                            </pattern>
                            
                            <!-- Tank heat lines pattern - bottom to top flow -->
                            <pattern id="dashboardTankHeatLinesBottomToTop" x="0" y="0" width="20" height="120" patternUnits="userSpaceOnUse">
                                <path d="M 3,10 Q 10,7 17,10 Q 10,13 3,10" fill="#999" opacity="0.12"/>
                                <path d="M 3,30 Q 10,27 17,30 Q 10,33 3,30" fill="#999" opacity="0.12"/>
                                <path d="M 3,50 Q 10,47 17,50 Q 10,53 3,50" fill="#999" opacity="0.12"/>
                                <path d="M 3,70 Q 10,67 17,70 Q 10,73 3,70" fill="#999" opacity="0.12"/>
                                <path d="M 3,90 Q 10,87 17,90 Q 10,93 3,90" fill="#999" opacity="0.12"/>
                                <path d="M 3,110 Q 10,107 17,110 Q 10,113 3,110" fill="#999" opacity="0.12"/>
                                <animateTransform
                                    attributeName="patternTransform"
                                    type="translate"
                                    values="0 120; 0 0"
                                    dur="3s"
                                    repeatCount="indefinite"/>
                            </pattern>
                        </defs>

                        <!-- Heat pump -->
                        <rect x="20" y="50" width="120" height="200" rx="10" fill="#888"/>
                        <g id="dashboard-hp-animation" style="display: none;">
                            <rect x="20" y="50" width="120" height="200" rx="10" fill="url(#dashboardHeatGradient)"/>
                            <rect x="20" y="50" width="120" height="200" rx="10" fill="url(#dashboardHeatLinesPattern)"/>
                        </g>
                        <text x="80" y="270" text-anchor="middle" fill="var(--text-color)" font-family="Montserrat, sans-serif" font-size="14" font-weight="600">Heat pump</text>
                        <text id="dashboard-hp-lift" x="80" y="150" text-anchor="middle" fill="white" font-family="Montserrat, sans-serif" font-size="16" font-weight="600">Lift<tspan x="80" dy="1.2em">-°F</tspan>
                        </text>
                        
                        <!-- Buffer -->
                        <rect x="860" y="50" width="120" height="200" rx="10" fill="transparent"/>
                        <!-- Buffer sections -->
                        <path id="dashboard-buffer-section1" d="M 860,60 Q 860,50 870,50 L 970,50 Q 980,50 980,60 L 980,116 L 860,116 Z" fill="#444"/>
                        <rect id="dashboard-buffer-section2" x="860" y="116" width="120" height="66" fill="#444"/>
                        <path id="dashboard-buffer-section3" d="M 860,182 L 980,182 L 980,240 Q 980,250 970,250 L 870,250 Q 860,250 860,240 Z" fill="#444"/>
                        <text id="dashboard-buffer-depth1" x="920" y="90" text-anchor="middle" fill="white" font-family="Montserrat, sans-serif" font-size="14" font-weight="600">-</text>
                        <text id="dashboard-buffer-depth2" x="920" y="156" text-anchor="middle" fill="white" font-family="Montserrat, sans-serif" font-size="14" font-weight="600">-</text>
                        <text id="dashboard-buffer-depth3" x="920" y="222" text-anchor="middle" fill="white" font-family="Montserrat, sans-serif" font-size="14" font-weight="600">-</text>
                        <text x="920" y="270" text-anchor="middle" fill="var(--text-color)" font-family="Montserrat, sans-serif" font-size="14" font-weight="600">Buffer</text>
                        <g id="dashboard-buffer-animation" style="display: none;">
                            <rect x="860" y="50" width="120" height="200" rx="10" fill="url(#dashboardBufferHeatLinesTopToBottom)"/>
                        </g>
                        
                        <!-- House (bottom right, left of buffer) -->
                        <rect x="660" y="280" width="120" height="200" rx="10" fill="#888"/>
                        <text x="720" y="500" text-anchor="middle" fill="var(--text-color)" font-family="Montserrat, sans-serif" font-size="14" font-weight="600">House</text>
                        <text id="dashboard-house-drop" x="720" y="380" text-anchor="middle" fill="white" font-family="Montserrat, sans-serif" font-size="16" font-weight="600">Drop<tspan x="720" dy="1.2em">-°F</tspan>
                        </text>
                        
                        <!-- Tank 3 (bottom left) -->
                        <rect x="200" y="280" width="120" height="200" rx="10" fill="transparent"/>
                        <!-- Tank 3 sections -->
                        <path id="dashboard-tank3-section1" d="M 200,290 Q 200,280 210,280 L 310,280 Q 320,280 320,290 L 320,346 L 200,346 Z" fill="#444"/>
                        <rect id="dashboard-tank3-section2" x="200" y="346" width="120" height="66" fill="#444"/>
                        <path id="dashboard-tank3-section3" d="M 200,412 L 320,412 L 320,470 Q 320,480 310,480 L 210,480 Q 200,480 200,470 Z" fill="#444"/>
                        <text id="dashboard-tank3-depth1" x="260" y="320" text-anchor="middle" fill="white" font-family="Montserrat, sans-serif" font-size="14" font-weight="600">-</text>
                        <text id="dashboard-tank3-depth2" x="260" y="386" text-anchor="middle" fill="white" font-family="Montserrat, sans-serif" font-size="14" font-weight="600">-</text>
                        <text id="dashboard-tank3-depth3" x="260" y="452" text-anchor="middle" fill="white" font-family="Montserrat, sans-serif" font-size="14" font-weight="600">-</text>
                        <text x="260" y="500" text-anchor="middle" fill="var(--text-color)" font-family="Montserrat, sans-serif" font-size="14" font-weight="600">Tank 3</text>
                        <g id="dashboard-tank3-animation" style="display: none;">
                            <rect x="200" y="280" width="120" height="200" rx="10" fill="url(#dashboardTankHeatLinesTopToBottom)"/>
                        </g>
                        
                        <!-- Tank 2 (bottom center) -->
                        <rect x="330" y="280" width="120" height="200" rx="10" fill="transparent"/>
                        <!-- Tank 2 sections -->
                        <path id="dashboard-tank2-section1" d="M 330,290 Q 330,280 340,280 L 440,280 Q 450,280 450,290 L 450,346 L 330,346 Z" fill="#444"/>
                        <rect id="dashboard-tank2-section2" x="330" y="346" width="120" height="66" fill="#444"/>
                        <path id="dashboard-tank2-section3" d="M 330,412 L 450,412 L 450,470 Q 450,480 440,480 L 340,480 Q 330,480 330,470 Z" fill="#444"/>
                        <text id="dashboard-tank2-depth1" x="390" y="320" text-anchor="middle" fill="white" font-family="Montserrat, sans-serif" font-size="14" font-weight="600">-</text>
                        <text id="dashboard-tank2-depth2" x="390" y="386" text-anchor="middle" fill="white" font-family="Montserrat, sans-serif" font-size="14" font-weight="600">-</text>
                        <text id="dashboard-tank2-depth3" x="390" y="452" text-anchor="middle" fill="white" font-family="Montserrat, sans-serif" font-size="14" font-weight="600">-</text>
                        <text x="390" y="500" text-anchor="middle" fill="var(--text-color)" font-family="Montserrat, sans-serif" font-size="14" font-weight="600">Tank 2</text>
                        <g id="dashboard-tank2-animation" style="display: none;">
                            <rect x="330" y="280" width="120" height="200" rx="10" fill="url(#dashboardTankHeatLinesTopToBottom)"/>
                        </g>
                        
                        <!-- Tank 1 (bottom right) -->
                        <rect x="460" y="280" width="120" height="200" rx="10" fill="transparent"/>
                        <!-- Tank 1 sections -->
                        <path id="dashboard-tank1-section1" d="M 460,290 Q 460,280 470,280 L 570,280 Q 580,280 580,290 L 580,346 L 460,346 Z" fill="#444"/>
                        <rect id="dashboard-tank1-section2" x="460" y="346" width="120" height="66" fill="#444"/>
                        <path id="dashboard-tank1-section3" d="M 460,412 L 580,412 L 580,470 Q 580,480 570,480 L 470,480 Q 460,480 460,470 Z" fill="#444"/>
                        <text id="dashboard-tank1-depth1" x="520" y="320" text-anchor="middle" fill="white" font-family="Montserrat, sans-serif" font-size="14" font-weight="600">-</text>
                        <text id="dashboard-tank1-depth2" x="520" y="386" text-anchor="middle" fill="white" font-family="Montserrat, sans-serif" font-size="14" font-weight="600">-</text>
                        <text id="dashboard-tank1-depth3" x="520" y="452" text-anchor="middle" fill="white" font-family="Montserrat, sans-serif" font-size="14" font-weight="600">-</text>
                        <text x="520" y="500" text-anchor="middle" fill="var(--text-color)" font-family="Montserrat, sans-serif" font-size="14" font-weight="600">Tank 1</text>
                        <g id="dashboard-tank1-animation" style="display: none;">
                            <rect x="460" y="280" width="120" height="200" rx="10" fill="url(#dashboardTankHeatLinesTopToBottom)"/>
                        </g>
                        
                        <!-- Store hot pipe temperature label (above Tank 1) -->
                        <text id="dashboard-store-hot-pipe" x="560" y="260" text-anchor="middle" fill="#888" font-family="Montserrat, sans-serif" font-size="14" font-weight="600">-</text>
                        
                        <!-- Store cold pipe temperature label (left of Tank 3) -->
                        <text id="dashboard-store-cold-pipe" x="145" y="430" text-anchor="middle" fill="#888" font-family="Montserrat, sans-serif" font-size="14" font-weight="600">-</text>
                        
                        <!-- Top pipe (from top of heat pump to top of buffer) -->
                        <rect id="dashboard-hp-buffer-top-pipe" x="140" y="75" width="720" height="15" fill="#888"/>
                        <text id="dashboard-hp-lwt" x="170" y="70" text-anchor="middle" fill="#888" font-family="Montserrat, sans-serif" font-size="14" font-weight="600">-</text>

                        <!-- Bottom pipe (from bottom of heat pump to bottom of buffer) -->
                        <rect id="dashboard-hp-buffer-bottom-pipe" x="140" y="215" width="720" height="15" fill="#888"/>
                        <text id="dashboard-hp-ewt" x="170" y="210" text-anchor="middle" fill="#888" font-family="Montserrat, sans-serif" font-size="14" font-weight="600">-</text>

                        <!-- Horizontal pipe from Tank1 vertical pipe to heat pump top (HpOnStoreCharge) -->
                        <rect id="dashboard-tank1-hp-horizontal-pipe-charge" x="140" y="75" width="465" height="15" fill="#888"/>
                        
                        <!-- Horizontal pipe from Tank3 vertical pipe to heat pump bottom (HpOnStoreCharge) -->
                        <rect id="dashboard-tank3-hp-horizontal-pipe-charge" x="140" y="215" width="50" height="15" fill="#888"/>

                        <!-- Vertical pipe from Tank 1 to heat pump top pipe (HpOffStoreDischarge) -->
                        <rect id="dashboard-tank1-hp-vertical-pipe" x="590" y="90" width="15" height="205" fill="#888"/>
                        
                        <!-- Horizontal pipe from Tank1-HP vertical pipe to buffer top (HpOffStoreDischarge) -->
                        <rect id="dashboard-tank1-buffer-horizontal-pipe" x="590" y="75" width="270" height="15" fill="#888"/>
                        
                        <!-- Small horizontal pipe from bottom of vertical pipe to top of Tank1 (HpOffStoreDischarge) -->
                        <rect id="dashboard-tank1-connection-pipe" x="580" y="295" width="25" height="15" fill="#888"/>
                        
                        <!-- Vertical pipe from bottom left of Tank3 to HP-Buffer bottom pipe (HpOffStoreDischarge) -->
                        <rect id="dashboard-tank3-hp-vertical-pipe" x="175" y="220" width="15" height="220" fill="#888"/>
                        
                        <!-- Horizontal pipe from top of Tank3 vertical pipe to bottom of buffer (HpOffStoreDischarge) -->
                        <rect id="dashboard-tank3-buffer-horizontal-pipe" x="175" y="215" width="685" height="15" fill="#888"/>
                        
                        <!-- Small horizontal pipe from Tank3 vertical pipe to bottom of Tank3 (HpOffStoreDischarge) -->
                        <rect id="dashboard-tank3-connection-pipe" x="175" y="440" width="25" height="15" fill="#888"/>
                        
                        <!-- Vertical pipe from Tank1 to heat pump top pipe (HpOnStoreCharge) -->
                        <rect id="dashboard-tank1-hp-vertical-pipe-charge" x="590" y="90" width="15" height="205" fill="#888"/>
                        
                        <!-- Vertical pipe from bottom left of Tank3 to HP-Buffer bottom pipe (HpOnStoreCharge) -->
                        <rect id="dashboard-tank3-hp-vertical-pipe-charge" x="175" y="220" width="15" height="220" fill="#888"/>
                        
                        <!-- Small horizontal pipe from Tank1 vertical pipe to top of Tank1 (HpOnStoreCharge) -->
                        <rect id="dashboard-tank1-connection-pipe-charge" x="580" y="295" width="25" height="15" fill="#888"/>

                        <!-- Small horizontal pipe from Tank3 vertical pipe to bottom of Tank3 (HpOnStoreCharge) -->
                        <rect id="dashboard-tank3-connection-pipe-charge" x="175" y="440" width="25" height="15" fill="#888"/>
                        
                        <!-- Vertical pipe from House to heat pump top pipe -->
                        <rect id="dashboard-house-hp-vertical-pipe" x="790" y="90" width="15" height="280" fill="#888"/>
                        
                        <!-- Small horizontal pipe from House vertical pipe to top of House -->
                        <rect id="dashboard-house-connection-pipe" x="780" y="370" width="25" height="15" fill="#888"/>
                        
                        <!-- Vertical pipe from House bottom to heat pump bottom pipe -->
                        <rect id="dashboard-house-hp-vertical-pipe-bottom" x="635" y="230" width="15" height="140" fill="#888"/>
                        
                        <!-- Small horizontal pipe from House vertical pipe to bottom of House -->
                        <rect id="dashboard-house-connection-pipe-bottom" x="635" y="370" width="25" height="15" fill="#888"/>
                        
                        <!-- Dist system labels -->
                        <text id="dashboard-dist-swt" x="810" y="405" text-anchor="middle" fill="#888" font-family="Montserrat, sans-serif" font-size="14" font-weight="600">-</text>
                        <text id="dashboard-dist-rwt" x="630" y="405" text-anchor="middle" fill="#888" font-family="Montserrat, sans-serif" font-size="14" font-weight="600">-</text>
                        
                        <!-- Horizontal pipe from top of right House vertical to buffer top -->
                        <rect id="dashboard-house-buffer-top-pipe" x="790" y="75" width="70" height="15" fill="#888"/>
                        
                        <!-- Horizontal pipe from top of left House vertical to buffer bottom -->
                        <rect id="dashboard-house-buffer-bottom-pipe" x="635" y="215" width="225" height="15" fill="#888"/>
                        
                        <!-- Buffer pipe temperature labels -->
                        <text id="dashboard-buffer-hot-pipe" x="830" y="70" text-anchor="middle" fill="#888" font-family="Montserrat, sans-serif" font-size="14" font-weight="600">-</text>
                        <text id="dashboard-buffer-cold-pipe" x="830" y="210" text-anchor="middle" fill="#888" font-family="Montserrat, sans-serif" font-size="14" font-weight="600">-</text>
                        
                        <!-- House animation group (moved to end to ensure visibility) -->
                        <g id="dashboard-house-animation" style="display: none;">
                            <rect x="660" y="280" width="120" height="200" rx="10" fill="url(#dashboardHouseHeatGradient)"/>
                            <rect x="660" y="280" width="120" height="200" rx="10" fill="url(#dashboardHouseHeatLinesPattern)"/>
                        </g>
                        
                    </svg>
                </div>

                <!-- System Monitoring Tables -->
                <div id="dashboard-monitoring-tables" style="max-width: 100%; margin: 50px auto 20px auto; display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;">
                    <!-- Thermostats and Hot Water Table -->
                    <div>
                        <table id="dashboard-thermostat-table" style="border: 1px solid var(--border-color); border-collapse: collapse; border-radius: 0.25rem; background-color: var(--card-background); margin: 0 auto; font-size: 0.75rem; color: var(--text-muted);">
                            <thead>
                                <tr style="background-color: var(--hover-color);">
                                    <th style="border: 1px solid var(--border-color); padding: 6px; text-align: left; font-weight: bold; font-size: 0.75rem; color: var(--text-muted);">Thermostats</th>
                                    <th style="border: 1px solid var(--border-color); padding: 6px; text-align: left; font-weight: bold; font-size: 0.75rem; color: var(--text-muted);">Setpoint</th>
                                    <th style="border: 1px solid var(--border-color); padding: 6px; text-align: left; font-weight: bold; font-size: 0.75rem; color: var(--text-muted);">Temperature</th>
                                    <th style="border: 1px solid var(--border-color); padding: 6px; text-align: left; font-weight: bold; font-size: 0.75rem; color: var(--text-muted);">State</th>
                                </tr>
                            </thead>
                            <tbody id="dashboard-thermostat-tbody">
                                <tr>
                                    <td style="border: 1px solid var(--border-color); padding: 6px; font-size: 0.75rem; color: var(--text-muted);">Loading...</td>
                                    <td style="border: 1px solid var(--border-color); padding: 6px; font-size: 0.75rem; color: var(--text-muted);">Loading...</td>
                                    <td style="border: 1px solid var(--border-color); padding: 6px; font-size: 0.75rem; color: var(--text-muted);">Loading...</td>
                                    <td style="border: 1px solid var(--border-color); padding: 6px; font-size: 0.75rem; color: var(--text-muted);">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- HP Power Table -->
                    <div>
                        <table id="dashboard-hp-power-table" style="border: 1px solid var(--border-color); border-collapse: collapse; border-radius: 0.25rem; background-color: var(--card-background); margin: 0 auto; font-size: 0.8rem; color: var(--text-muted);">
                            <thead>
                                <tr style="background-color: var(--hover-color);">
                                    <th style="border: 1px solid var(--border-color); padding: 6px; text-align: left; font-weight: bold; font-size: 0.8rem; color: var(--text-muted);">Heat pump</th>
                                    <th style="border: 1px solid var(--border-color); padding: 6px; text-align: left; font-weight: bold; font-size: 0.8rem; color: var(--text-muted);">kW</th>
                                </tr>
                            </thead>
                            <tbody id="dashboard-hp-power-tbody">
                                <tr>
                                    <td style="border: 1px solid var(--border-color); padding: 6px; font-size: 0.8rem; color: var(--text-muted);">Loading...</td>
                                    <td style="border: 1px solid var(--border-color); padding: 6px; font-size: 0.8rem; color: var(--text-muted);">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pump Table -->
                    <div>
                        <table id="dashboard-pump-table" style="border: 1px solid var(--border-color); border-collapse: collapse; border-radius: 0.25rem; background-color: var(--card-background); margin: 0 auto; font-size: 0.8rem; color: var(--text-muted);">
                            <thead>
                                <tr style="background-color: var(--hover-color);">
                                    <th style="border: 1px solid var(--border-color); padding: 6px; text-align: left; font-weight: bold; font-size: 0.8rem; color: var(--text-muted);">Pumps</th>
                                    <th style="border: 1px solid var(--border-color); padding: 6px; text-align: left; font-weight: bold; font-size: 0.8rem; color: var(--text-muted);">GPM</th>
                                    <th style="border: 1px solid var(--border-color); padding: 6px; text-align: left; font-weight: bold; font-size: 0.8rem; color: var(--text-muted);">W</th>
                                </tr>
                            </thead>
                            <tbody id="dashboard-pump-tbody">
                                <tr>
                                    <td style="border: 1px solid var(--border-color); padding: 6px; font-size: 0.8rem; color: var(--text-muted);">Loading...</td>
                                    <td style="border: 1px solid var(--border-color); padding: 6px; font-size: 0.8rem; color: var(--text-muted);">Loading...</td>
                                    <td style="border: 1px solid var(--border-color); padding: 6px; font-size: 0.8rem; color: var(--text-muted);">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Map Card -->
        <div class="card map-card" id="map-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title">Map</h5>
                <div class="status-badges">
                    <button class="filter-toggle" id="map-reset-btn">
                        <span>Reset</span>
                    </button>
                </div>
            </div>
            <div class="map-container">
                <div id="map"></div>
                <div class="map-loading">
                    <i class="bi bi-arrow-repeat"></i>
                    <span>Loading map...</span>
                </div>
            </div>
        </div>

        <!-- Electricity Use Card -->
        <div class="card" id="electricity-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title">Download hourly data</h5>
                <div class="status-badges">
                    <button class="fullscreen-btn" id="electricity-fullscreen-btn">
                        <i class="bi bi-arrows-fullscreen"></i>
                    </button>
                    <button class="filter-toggle" id="electricity-clear-btn">
                        <span>Clear</span>
                    </button>
                </div>
            </div>
            <div class="p-4" style="border-bottom: 1px solid var(--border-color);">
                <div class="mb-4">
                    <label class="form-label" style="font-size: 0.875rem; color: var(--text-muted);">Selected House(s)</label>
                    <input type="text" class="form-control text-light border-secondary" style="background-color: rgba(56, 77, 164, 0.2);" id="electricity-selected-house" placeholder="Aggregate of all houses in the table" readonly>
                </div>
                <table class="table table-borderless mb-4" style="max-width: 400px;">
                    <tbody>
                        <tr>
                            <td style="width: 80px; font-size: 0.875rem; color: var(--text-muted); vertical-align: middle;">Start</td>
                            <td style="width: 200px;">
                                <input type="date" class="form-control text-light" style="color: var(--datetime-text) !important; background-color: var(--datetime-background) !important; border: 1px solid var(--border-color);" id="electricity-start-date">
                            </td>
                            <td style="width: 150px;">
                                    <input type="time" class="form-control text-light" style="color: var(--datetime-text) !important; background-color: var(--datetime-background) !important; border: 1px solid var(--border-color);" id="electricity-start-time">
                            </td>
                        </tr>
                        <tr>
                            <td style="width: 80px; font-size: 0.875rem; color: var(--text-muted); vertical-align: middle;">End</td>
                            <td style="width: 200px;">
                                <input type="date" class="form-control text-light" style="color: var(--datetime-text) !important; background-color: var(--datetime-background) !important; border: 1px solid var(--border-color);" id="electricity-end-date">
                            </td>
                            <td style="width: 150px;">
                                <input type="time" class="form-control text-light" style="color: var(--datetime-text) !important; background-color: var(--datetime-background) !important; border: 1px solid var(--border-color);" id="electricity-end-time">
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="d-flex gap-2 align-items-center">
                    <button class="btn btn-sm btn-outline-secondary" id="electricity-plot-btn">Plot</button>
                    <button class="btn btn-sm btn-outline-secondary" id="electricity-csv-btn">CSV</button>
                    <button class="btn btn-sm btn-outline-secondary" id="electricity-now-btn">Now</button>
                </div>
            </div>
            <div id="electricity-plot-container" style="display: none;">
                <div id="electricity-plot" class="plot-div"></div>
            </div>
        </div>

        <!-- Information Card -->
        <div class="card" id="information-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title">Information</h5>
                <div class="status-badges">
                    <button class="filter-toggle" id="info-reset-btn">
                        <span>Clear</span>
                    </button>
                </div>
            </div>
            <div class="p-4">
                <div class="mb-4">
                    <label class="form-label" style="font-size: 0.875rem; color: var(--text-muted);">Selected House</label>
                    <input type="text" class="form-control text-light border-secondary" style="background-color: rgba(56, 77, 164, 0.2);" id="info-selected-house" placeholder="Select a house in the table" readonly>
                </div>
                <div class="d-flex gap-2 mb-4" style="margin-bottom: 0rem !important;">
                    <button class="btn btn-sm btn-outline-secondary" id="show-address-btn">Address</button>
                    <button class="btn btn-sm btn-outline-secondary" id="show-contact-btn">Contact</button>
                    <button class="btn btn-sm btn-outline-secondary" id="show-status-btn">Status</button>
                    <button class="btn btn-sm btn-outline-secondary" id="show-hardware-btn">Hardware</button>
                </div>
                <div id="info-details" class="details-grid" style="display: none;">
                    <div class="detail-item" id="address-section" style="display: none;">
                        <div class="detail-label">Address</div>
                        <div class="detail-value" id="info-address">
                            None
                        </div>
                    </div>
                    <div class="detail-item" id="contact-section" style="display: none;">
                        <div class="detail-value" id="info-contact">
                            None
                        </div>
                    </div>
                    <div class="detail-item" id="status-section" style="display: none;">
                        <div class="detail-label">Status</div>
                        <div class="detail-value" id="info-status">
                            None
                        </div>
                    </div>
                    <div class="detail-item" id="hardware-section" style="display: none;">
                        <div class="detail-label">Hardware</div>
                        <div class="detail-value" id="info-hardware">
                            None
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Visualizer Card -->
        <div class="card" id="visualizer-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title">Visualizer</h5>
                <div class="status-badges">
                    <div class="loader" style="display: none;"></div>
                    <div class="form-check form-check-inline me-3 d-flex align-items-center">
                        <input class="form-check-input" type="checkbox" id="auto-refresh-checkbox" style="margin-top: 0; margin-right:6px">
                        <label class="form-check-label" for="auto-refresh-checkbox" style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0;">
                            Auto-refresh
                        </label>
                    </div>
                    <button class="fullscreen-btn" id="fullscreen-btn">
                        <i class="bi bi-arrows-fullscreen"></i>
                    </button>
                    <button class="filter-toggle" id="clear-btn">
                        <span>Clear</span>
                    </button>
                </div>
            </div>
            <div class="p-4">
                <div class="mb-4">
                    <label class="form-label" style="font-size: 0.875rem; color: var(--text-muted);">Selected House</label>
                    <input type="text" class="form-control text-light border-secondary" style="background-color: rgba(56, 77, 164, 0.2);" id="selected-house" placeholder="Select a house in the table" readonly>
                </div>
                <table class="table table-borderless mb-4" style="max-width: 400px;">
                    <tbody>
                        <tr>
                            <td style="width: 80px; font-size: 0.875rem; color: var(--text-muted); vertical-align: middle;">Start</td>
                            <td style="width: 200px;">
                                <input type="date" class="form-control text-light" style="color: var(--datetime-text) !important; background-color: var(--datetime-background) !important; border: 1px solid var(--border-color);" id="start-date">
                            </td>
                            <td style="width: 150px;">
                                    <input type="time" class="form-control text-light" style="color: var(--datetime-text) !important; background-color: var(--datetime-background) !important; border: 1px solid var(--border-color);" id="start-time">
                            </td>
                        </tr>
                        <tr>
                            <td style="width: 80px; font-size: 0.875rem; color: var(--text-muted); vertical-align: middle;">End</td>
                            <td style="width: 200px;">
                                <input type="date" class="form-control text-light" style="color: var(--datetime-text) !important; background-color: var(--datetime-background) !important; border: 1px solid var(--border-color);" id="end-date">
                            </td>
                            <td style="width: 150px;">
                                <input type="time" class="form-control text-light" style="color: var(--datetime-text) !important; background-color: var(--datetime-background) !important; border: 1px solid var(--border-color);" id="end-time">
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="d-flex gap-2 align-items-center">
                    <button class="btn btn-sm btn-outline-secondary" id="plot-btn">Plot</button>
                    <button class="btn btn-sm btn-outline-secondary" id="csv-btn" style="display: none;">CSV</button>
                    <button class="btn btn-sm btn-outline-secondary" id="now-btn">8pm-Now</button>
                    <button class="btn btn-sm btn-outline-secondary" id="flo-btn">FLO</button>
                    <button class="btn btn-sm btn-outline-secondary" id="options-btn">Options</button>
                </div>
            </div>
            <div id="options-div" class="options-container" style="border-top: 1px solid var(--border-color); margin-bottom:0rem">
                <div class="options-content">
                    <div class="options-section" style="margin-top: 1rem;">
                        <h6>Plot settings</h6>
                        <label><input type="checkbox" name="channels" value="show-points">Show points</label>
                    </div>
                    <div class="options-section">
                        <h6>Heat pump</h6>
                        <label><input type="checkbox" name="channels" value="hp-lwt" checked>Leaving water temperature</label>
                        <label><input type="checkbox" name="channels" value="hp-ewt" checked>Entering water temperature</label>
                        <label><input type="checkbox" name="channels" value="hp-odu-pwr" checked>Outdoor unit power</label>
                        <label><input type="checkbox" name="channels" value="hp-idu-pwr" checked>Indoor unit power</label>
                        <label><input type="checkbox" name="channels" value="primary-flow" checked>Primary pump flow rate</label>
                        <label><input type="checkbox" name="channels" value="primary-pump-pwr" checked>Primary pump power</label>
                        <label><input type="checkbox" name="channels" value="oil-boiler-pwr" checked>Oil boiler power</label>
                    </div>
                    <div class="options-section">
                        <h6>Distribution</h6>
                        <label><input type="checkbox" name="channels" value="dist-swt" checked>Source water temperature</label>
                        <label><input type="checkbox" name="channels" value="dist-rwt" checked>Return water temperature</label>
                        <label><input type="checkbox" name="channels" value="dist-flow" checked>Distribution pump flow rate</label>
                        <label><input type="checkbox" name="channels" value="dist-pump-pwr" checked>Distribution pump power</label>
                    </div>
                    <div class="options-section">
                        <h6>Zones</h6>
                        <label><input type="checkbox" name="channels" value="zone-heat-calls" checked>Heat calls</label>
                        <label><input type="checkbox" name="channels" value="oat" checked>Outside air temperature</label>
                    </div>
                    <div class="options-section">
                        <h6>Buffer</h6>
                        <label><input type="checkbox" name="channels" value="buffer-depths" checked>Buffer depths</label>
                        <label><input type="checkbox" name="channels" value="buffer-hot-pipe">Hot pipe</label>
                        <label><input type="checkbox" name="channels" value="buffer-cold-pipe">Cold pipe</label>
                    </div>
                    <div class="options-section">
                        <h6>Storage</h6>
                        <label><input type="checkbox" name="channels" value="storage-depths" checked>Storage depths</label>
                        <label><input type="checkbox" name="channels" value="store-hot-pipe">Hot pipe</label>
                        <label><input type="checkbox" name="channels" value="store-cold-pipe">Cold pipe</label>
                        <label><input type="checkbox" name="channels" value="store-flow" checked>Storage pump flow rate</label>
                        <label><input type="checkbox" name="channels" value="store-pump-pwr" checked>Storage pump power</label>
                        <label><input type="checkbox" name="channels" value="store-energy" checked>Available and required energy</label>
                    </div>
                </div>
            </div>
            <div id="plot-container" style="display: none;">
                <div id="plot1" class="plot-div"></div>
                <div id="plot2" class="plot-div"></div>
                <div id="plot3" class="plot-div"></div>
                <div id="plot4" class="plot-div"></div>
                <div id="plot5" class="plot-div"></div>
                <div id="plot6" class="plot-div"></div>
                <div id="plot7" class="plot-div"></div>
                <div id="plot8" class="plot-div"></div>
                <div id="plot9" class="plot-div"></div>
                <div id="plot10" class="plot-div"></div>
                <div id="plot11" class="plot-div"></div>
                <div id="plot-png" class="plot-div"></div>
            </div>
        </div>

        <!-- Data Download Card -->
        <div class="card" id="data-download-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title">Download channel data</h5>
                <div class="status-badges">
                    <div class="loader" style="display: none;"></div>
                    <button class="fullscreen-btn" id="data-download-fullscreen-btn">
                        <i class="bi bi-arrows-fullscreen"></i>
                    </button>
                    <button class="filter-toggle" id="data-download-clear-btn" style="display: none;">
                        <span>Clear</span>
                    </button>
                </div>
            </div>
            <div class="p-4">
                <div class="mb-4">
                    <label class="form-label" style="font-size: 0.875rem; color: var(--text-muted);">Selected House</label>
                    <input type="text" class="form-control text-light border-secondary" id="data-download-selected-house" placeholder="Select a house in the table" readonly>
                </div>
                <table class="table table-borderless mb-4" style="max-width: 400px;">
                    <tbody>
                        <tr>
                            <td style="width: 80px; font-size: 0.875rem; color: var(--text-muted); vertical-align: middle;">Start</td>
                            <td style="width: 200px;">
                                <input type="date" class="form-control text-light" style="color: var(--datetime-text) !important; background-color: var(--datetime-background) !important; border: 1px solid var(--border-color);" id="data-download-start-date">
                            </td>
                            <td style="width: 150px;">
                                    <input type="time" class="form-control text-light" style="color: var(--datetime-text) !important; background-color: var(--datetime-background) !important; border: 1px solid var(--border-color);" id="data-download-start-time">
                            </td>
                        </tr>
                        <tr>
                            <td style="width: 80px; font-size: 0.875rem; color: var(--text-muted); vertical-align: middle;">End</td>
                            <td style="width: 200px;">
                                <input type="date" class="form-control text-light" style="color: var(--datetime-text) !important; background-color: var(--datetime-background) !important; border: 1px solid var(--border-color);" id="data-download-end-date">
                            </td>
                            <td style="width: 150px;">
                                <input type="time" class="form-control text-light" style="color: var(--datetime-text) !important; background-color: var(--datetime-background) !important; border: 1px solid var(--border-color);" id="data-download-end-time">
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="d-flex gap-2 align-items-center">
                    <button class="btn btn-sm btn-outline-secondary" id="data-download-csv-btn">CSV</button>
                    <button class="btn btn-sm btn-outline-secondary" id="data-download-now-btn">Now</button>
                    <button class="btn btn-sm btn-outline-secondary" id="data-download-options-btn">Options</button>
                </div>
            </div>
            <div id="data-download-options-div" class="options-container" style="border-top: 1px solid var(--border-color); margin-bottom:0rem">
                <div class="options-content">
                    <div class="options-section">
                        <div class="mt-3" style="margin-top: -1rem;">
                            <h6>Time step (seconds):</h6>
                            <input type="number" class="form-control border-secondary" style="margin-left: 10px; margin-bottom: 2rem; width: 100px;" id="data-download-csv-timestep" value="1">
                        </div>
                        <div class="mt-3">
                            <h6>Channel selection</h6>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="data-download-select-all-btn">Select all</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="data-download-unselect-all-btn">Unselect all</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="options-section">
                        <h6>Heat pump</h6>
                        <label><input type="checkbox" name="data-download-channels" value="hp-lwt" checked>Leaving water temperature</label>
                        <label><input type="checkbox" name="data-download-channels" value="hp-ewt" checked>Entering water temperature</label>
                        <label><input type="checkbox" name="data-download-channels" value="hp-odu-pwr" checked>Outdoor unit power</label>
                        <label><input type="checkbox" name="data-download-channels" value="hp-idu-pwr" checked>Indoor unit power</label>
                        <label><input type="checkbox" name="data-download-channels" value="primary-flow" checked>Primary pump flow rate</label>
                        <label><input type="checkbox" name="data-download-channels" value="primary-pump-pwr" checked>Primary pump power</label>
                        <label><input type="checkbox" name="data-download-channels" value="primary-010v" checked>Primary pump 0-10V</label>
                    </div>
                    <div class="options-section">
                        <h6>Distribution</h6>
                        <label><input type="checkbox" name="data-download-channels" value="dist-swt" checked>Source water temperature</label>
                        <label><input type="checkbox" name="data-download-channels" value="dist-rwt" checked>Return water temperature</label>
                        <label><input type="checkbox" name="data-download-channels" value="dist-flow" checked>Distribution pump flow rate</label>
                        <label><input type="checkbox" name="data-download-channels" value="dist-pump-pwr" checked>Distribution pump power</label>
                        <label><input type="checkbox" name="data-download-channels" value="dist-010v" checked>Distribution pump 0-10V</label>
                    </div>
                    <div class="options-section">
                        <h6>Zones</h6>
                        <label><input type="checkbox" name="data-download-channels" value="zone-heat-calls" checked>Heat calls</label>
                        <label><input type="checkbox" name="data-download-channels" value="white-wires" checked>White wire power</label>
                    </div>
                    <div class="options-section">
                        <h6>Buffer</h6>
                        <label><input type="checkbox" name="data-download-channels" value="buffer-depths" checked>Buffer depths</label>
                        <label><input type="checkbox" name="data-download-channels" value="buffer-hot-pipe" checked>Buffer hot pipe</label>
                        <label><input type="checkbox" name="data-download-channels" value="buffer-cold-pipe" checked>Buffer cold pipe</label>
                    </div>
                    <div class="options-section">
                        <h6>Storage</h6>
                        <label><input type="checkbox" name="data-download-channels" value="storage-depths" checked>Storage depths</label>
                        <label><input type="checkbox" name="data-download-channels" value="store-hot-pipe" checked>Storage hot pipe</label>
                        <label><input type="checkbox" name="data-download-channels" value="store-cold-pipe" checked>Storage cold pipe</label>
                        <label><input type="checkbox" name="data-download-channels" value="store-flow" checked>Storage pump flow rate</label>
                        <label><input type="checkbox" name="data-download-channels" value="store-pump-pwr" checked>Storage pump power</label>
                        <label><input type="checkbox" name="data-download-channels" value="storage-010v" checked>Storage pump 0-10V</label>
                    </div>
                    <div class="options-section">
                        <h6>Other</h6>
                        <label><input type="checkbox" name="data-download-channels" value="oil-boiler-pwr" checked>Oil boiler power</label>
                        <label><input type="checkbox" name="data-download-channels" value="oat" checked>Outside air temperature</label>
                        <label><input type="checkbox" name="data-download-channels" value="relays" checked>Relays</label>
                        <label><input type="checkbox" name="data-download-channels" value="all-data" checked>All other channels</label>
                    </div>
                    
                </div>
            </div>
        </div>

        <!-- Morning Report Card -->
        <div class="card" id="morning-report-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title">Morning report</h5>
                <div class="status-badges">
                    <div class="loader" id="morning-loader-spinner" style="display: none;"></div>
                    <button class="filter-toggle" id="morning-clear-btn">
                        <span>Clear</span>
                    </button>
                </div>
            </div>
            <div class="p-4" style="padding-bottom: 0px !important;">
                <form id="morning-form">
                    <div class="mb-4">
                        <label class="form-label" style="font-size: 0.875rem; color: var(--text-muted);">Selected House(s)</label>
                        <input type="text" class="form-control text-light border-secondary" style="background-color: rgba(56, 77, 164, 0.2);" id="morning-selected-house" placeholder="All houses in the table" readonly>
                    </div>
                    <table class="table table-borderless mb-4" style="max-width: 400px;">
                        <tbody>
                            <tr>
                                <td style="width: 80px; font-size: 0.875rem; color: var(--text-muted); vertical-align: middle;">Start</td>
                                <td style="width: 200px;">
                                    <input type="date" class="form-control text-light" style="color: var(--datetime-text) !important; background-color: var(--datetime-background) !important; border: 1px solid var(--border-color);" id="morning-start-date">
                                </td>
                                <td style="width: 150px;">
                                    <input type="time" class="form-control text-light" style="color: var(--datetime-text) !important; background-color: var(--datetime-background) !important; border: 1px solid var(--border-color);" id="morning-start-time">
                                </td>
                            </tr>
                            <tr>
                                <td style="width: 80px; font-size: 0.875rem; color: var(--text-muted); vertical-align: middle;">End</td>
                                <td style="width: 200px;">
                                    <input type="date" class="form-control text-light" style="color: var(--datetime-text) !important; background-color: var(--datetime-background) !important; border: 1px solid var(--border-color);" id="morning-end-date">
                                </td>
                                <td style="width: 150px;">
                                    <input type="time" class="form-control text-light" style="color: var(--datetime-text) !important; background-color: var(--datetime-background) !important; border: 1px solid var(--border-color);" id="morning-end-time">
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="mb-3">
                        <label class="form-label" style="font-size: 0.875rem; color: var(--text-muted);">Message types</label>
                        <div id="morning-checkboxDiv">
                            <label><input type="checkbox" name="morning-channels" value="gridworks.event.problem" checked>gridworks.event.problem</label>
                            <label style="margin-bottom: 1.75rem;"><input type="checkbox" name="morning-channels" value="glitch" checked>glitch</label>
                        </div>
                    </div>
                    <div class="d-flex gap-2 align-items-center">
                        <button type="submit" class="btn btn-sm btn-outline-secondary" id="morning-submit-btn">Get messages</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="morning-now-btn">Now</button>
                    </div>
                </form>
                <div id="morning-table-container" style="margin-top: 1.5rem;"></div>
            </div>
            <!-- Modal for details -->
            <div id="morning-details-overlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:2000;">
                <div id="morning-details-container" style="background:var(--card-background); border-radius:8px; padding:30px 50px; max-width:80vw; min-width:60vw; max-height:80vh; overflow-y:auto; box-shadow:0 4px 8px rgba(0,0,0,0.2); position:relative;">
                    <button id="morning-close-btn" class="btn btn-sm btn-outline-secondary" style="position:absolute; top:10px; right:10px;">X</button>
                    <div id="morning-details-content"></div>
                </div>
            </div>
        </div>
        <style>
            #morning-table-container table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 1.5rem;
            }
            #morning-table-container th, #morning-table-container td {
                border: 1px solid var(--border-color);
                padding: 8px;
                text-align: left;
                font-size: 0.9rem;
                background: var(--card-background);
                color: var(--text-color);
            }
            #morning-table-container th {
                background: var(--table-header-bg);
                color: var(--text-muted);
            }
            #morning-table-container tr:hover {
                background: var(--hover-color);
                cursor: pointer;
            }
            #morning-table-container .summary-table {
                max-width: 500px;
                margin-bottom: 40px;
            }
            #morning-selected-house {
                border: none;
                cursor: pointer;
                background-color: var(--selected-house-bg) !important;
                color: var(--selected-house-text) !important;
            }
            #morning-selected-house::placeholder {
                color: var(--text-muted) !important;
                font-size: 0.875rem;
                opacity: 0.7;
            }
        </style>
        <script>
        (function() {
            const getAuthToken = window.getAuthToken;
            let darkmode_tf = false;

            function getDefaultDate(start) {
                const nyDate = new Date(new Date().toLocaleString("en-US", { timeZone: "America/New_York" }));
                if (start) {
                    nyDate.setDate(nyDate.getDate() - 1);
                    nyDate.setHours(20, 0, 0, 0);
                } else {
                    nyDate.setMinutes(nyDate.getMinutes() + 1);
                }
                const year = nyDate.getFullYear();
                const month = String(nyDate.getMonth() + 1).padStart(2, '0');
                const day = String(nyDate.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            function getDefaultTime(start) {
                const nyDate = new Date(new Date().toLocaleString("en-US", { timeZone: "America/New_York" }));
                if (start) {
                    nyDate.setDate(nyDate.getDate() - 1);
                    nyDate.setHours(20, 0, 0, 0);
                } else {
                    nyDate.setMinutes(nyDate.getMinutes() + 1);
                }
                const hours = String(nyDate.getHours()).padStart(2, '0');
                const minutes = String(nyDate.getMinutes()).padStart(2, '0');
                return `${hours}:${minutes}`;
            }
            function setNow() {
                const nyDate = new Date(new Date().toLocaleString("en-US", { timeZone: "America/New_York" }));
                nyDate.setMinutes(nyDate.getMinutes() + 1);
                document.getElementById('morning-end-date').value = nyDate.toISOString().split('T')[0];
                document.getElementById('morning-end-time').value = nyDate.toTimeString().split(' ')[0].substring(0, 5);
            }
            function enable_plot_buttons() {
                const btn = document.getElementById('morning-submit-btn');
                btn.disabled = false;
                btn.style.opacity = '1';
                document.getElementById('morning-loader-spinner').style.display = 'none';
            }
            function disable_plot_buttons() {
                const btn = document.getElementById('morning-submit-btn');
                btn.disabled = true;
                btn.style.opacity = '0.5';
                document.getElementById('morning-loader-spinner').style.display = 'inline-block';
            }
            function showLoader() {
                document.getElementById('morning-loader-spinner').style.display = 'inline-block';
            }
            function hideLoader() {
                document.getElementById('morning-loader-spinner').style.display = 'none';
            }
            function renderTable(data) {
                const tableContainer = document.getElementById('morning-table-container');
                tableContainer.innerHTML = '';
                if (data.SummaryTable) {
                    const summaryTable = document.createElement('table');
                    summaryTable.classList.add('summary-table');
                    const summaryHeaderRow = document.createElement('tr');
                    const th1 = document.createElement('th'); th1.textContent = "Log level"; summaryHeaderRow.appendChild(th1);
                    const th2 = document.createElement('th'); th2.textContent = "Count"; summaryHeaderRow.appendChild(th2);
                    summaryTable.appendChild(summaryHeaderRow);
                    Object.keys(data.SummaryTable).forEach(logLevel => {
                        const row = document.createElement('tr');
                        const logLevelCell = document.createElement('td'); logLevelCell.textContent = logLevel;
                        const countCell = document.createElement('td'); countCell.textContent = data.SummaryTable[logLevel];
                        row.appendChild(logLevelCell); row.appendChild(countCell); summaryTable.appendChild(row);
                    });
                    tableContainer.appendChild(summaryTable);
                }
                const table = document.createElement('table');
                table.classList.add('data-table');
                const headerRow = document.createElement('tr');
                Object.keys(data).forEach(key => {
                    if (key !== "Details" && key !== "SummaryTable") {
                        const th = document.createElement('th'); th.textContent = key; headerRow.appendChild(th);
                    }
                });
                table.appendChild(headerRow);
                const numRows = data[Object.keys(data)[0]].length;
                for (let i = 0; i < numRows; i++) {
                    const row = document.createElement('tr');
                    row.dataset.index = i;
                    Object.keys(data).forEach(key => {
                        if (key !== "Details" && key !== "SummaryTable") {
                            const td = document.createElement('td');
                            td.textContent = data[key][i];
                            row.appendChild(td);
                        }
                    });
                    row.addEventListener('click', function() {
                        displayDetails(data, i);
                    });
                    table.appendChild(row);
                }
                tableContainer.appendChild(table);
            }
            function displayDetails(data, index) {
                const details = data["Details"][index];
                const timeCreated = data["Time created"][index];
                const fromNode = data["From node"][index];
                const logLevel = data["Log level"][index];
                const summary = data["Summary"][index];
                const detailsContainer = document.getElementById('morning-details-container');
                const overlay = document.getElementById('morning-details-overlay');
                const detailsContent = document.getElementById('morning-details-content');
                if (detailsContainer && overlay && detailsContent) {
                    let detailsHTML = `
                    <b>Log level:</b> ${logLevel}<br>
                    <b>From node:</b> ${fromNode}<br>
                    <b>Summary:</b> ${summary}<br>
                    <b>Time created:</b> ${timeCreated}<br><br>
                    <b>Details:</b><br><p>${details}</p>`;
                    detailsContent.innerHTML = detailsHTML;
                    overlay.style.display = 'flex';
                    detailsContainer.classList.add('show');
                }
            }
            function closeModal() {
                document.getElementById('morning-details-overlay').style.display = 'none';
                document.getElementById('morning-details-container').classList.remove('show');
            }
            function getSelectedHouseAliases() {
                const selectedHouseInput = document.getElementById('morning-selected-house');
                const selectedHouse = selectedHouseInput.value.trim();
                if (selectedHouse && selectedHouse !== 'All houses in the table') {
                    return [selectedHouse];
                }
                const visibleRows = Array.from(document.querySelectorAll('.expandable-row'))
                    .filter(row => row.style.display !== 'none');
                return visibleRows.map(row => row.cells[0].textContent.trim());
            }
            document.addEventListener('DOMContentLoaded', function() {
                document.getElementById('morning-start-date').value = getDefaultDate(true);
                document.getElementById('morning-start-time').value = getDefaultTime(true);
                document.getElementById('morning-end-date').value = getDefaultDate(false);
                document.getElementById('morning-end-time').value = getDefaultTime(false);
                // Set initial value
                function updateMorningSelectedHouse() {
                    const selectedRow = document.querySelector('.expandable-row.expanded');
                    const input = document.getElementById('morning-selected-house');
                    if (selectedRow) {
                        input.value = selectedRow.cells[0].textContent.trim();
                    } else {
                        input.value = '';
                    }
                }
                updateMorningSelectedHouse();
                // Update on row click (same as other cards)
                document.querySelectorAll('.expandable-row').forEach(row => {
                    row.addEventListener('click', function() {
                        setTimeout(updateMorningSelectedHouse, 10);
                    });
                });
                // Also update on .visualize-btn and .show-info-btn click
                document.querySelectorAll('.visualize-btn, .show-info-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        setTimeout(updateMorningSelectedHouse, 10);
                    });
                });
                // Clicking the input scrolls to the table and exits fullscreen if needed
                document.getElementById('morning-selected-house').addEventListener('click', function() {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
                // Now button
                document.getElementById('morning-now-btn').addEventListener('click', setNow);
                // Clear button
                document.getElementById('morning-clear-btn').addEventListener('click', function() {
                    document.getElementById('morning-table-container').innerHTML = '';
                });
                // Modal close
                document.getElementById('morning-close-btn').addEventListener('click', closeModal);
                document.getElementById('morning-details-overlay').addEventListener('click', function(event) {
                    if (event.target === this) closeModal();
                });
                // Form submit
                document.getElementById('morning-form').addEventListener('submit', async function(event) {
                    event.preventDefault();
                    
                    // Clear the morning report card first
                    document.getElementById('morning-table-container').innerHTML = '';
                    
                    const selectedMessageTypes = Array.from(document.querySelectorAll('input[name="morning-channels"]:checked')).map(cb => cb.value);
                    const selectedAliases = getSelectedHouseAliases();
                    let house_alias = '';
                    if (selectedAliases.length === 1) {
                        house_alias = selectedAliases[0];
                    }
                    const startDate = document.getElementById('morning-start-date').value;
                    const startTime = document.getElementById('morning-start-time').value;
                    const endDate = document.getElementById('morning-end-date').value;
                    const endTime = document.getElementById('morning-end-time').value;
                    const startDateTime = luxon.DateTime.fromFormat(`${startDate} ${startTime}`, 'yyyy-MM-dd HH:mm', { zone: 'America/New_York' });
                    const endDateTime = luxon.DateTime.fromFormat(`${endDate} ${endTime}`, 'yyyy-MM-dd HH:mm', { zone: 'America/New_York' });
                    const startUnixMilliseconds = startDateTime.toUTC().toMillis();
                    const endUnixMilliseconds = endDateTime.toUTC().toMillis();
                    disable_plot_buttons();
                    showLoader();
                    try {
                        const response = await fetch(`${api_host}/messages`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${window.getAuthToken()}`
                            },
                            body: JSON.stringify({
                                house_alias: house_alias,
                                password: '',
                                selected_channels: [],
                                selected_message_types: selectedMessageTypes,
                                start_ms: startUnixMilliseconds,
                                end_ms: endUnixMilliseconds,
                                darkmode: darkmode_tf,
                            })
                        });
                        const contentType = response.headers.get("Content-Type");
                        if (contentType && contentType.includes("application/json")) {
                            const data = await response.json();
                            if ('success' in data && data.success === false) {
                                alert(data.message);
                                if (data.reload) {
                                    location.reload();
                                }
                                return;
                            }
                            renderTable(data);
                        }
                    } catch (error) {
                        console.error('Error fetching messages:', error);
                        alert(`Error fetching messages.`);
                    } finally {
                        enable_plot_buttons();
                        hideLoader();
                    }
                });
            });

            // Card visibility controls
            function initializeCardVisibility() {
                const buttons = {
                    'show-dashboard': 'dashboard-card',
                    'show-map': 'map-card',
                    'show-electricity': 'electricity-card', 
                    'show-information': 'information-card',
                    'show-visualizer': 'visualizer-card',
                    'show-data-download': 'data-download-card',
                    'show-morning-report': 'morning-report-card'
                };

                // Set initial visibility based on button states
                Object.entries(buttons).forEach(([buttonId, cardId]) => {
                    const button = document.getElementById(buttonId);
                    const card = document.getElementById(cardId);
                    
                    if (button && card) {
                        // Set initial visibility
                        if (!button.classList.contains('active')) {
                            card.classList.add('hidden');
                        }
                        
                        // Add event listener
                        button.addEventListener('click', function() {
                            // Remove active class from all buttons
                            Object.keys(buttons).forEach(otherButtonId => {
                                const otherButton = document.getElementById(otherButtonId);
                                const otherCard = document.getElementById(buttons[otherButtonId]);
                                if (otherButton && otherCard) {
                                    otherButton.classList.remove('active');
                                    otherCard.classList.add('hidden');
                                }
                            });
                            
                            // Hide map card when switching away from information card
                            if (cardId !== 'information-card') {
                                const mapCard = document.getElementById('map-card');
                                if (mapCard) {
                                    mapCard.classList.add('hidden');
                                }
                            }
                            
                            // Add active class to clicked button and show its card
                            this.classList.add('active');
                            card.classList.remove('hidden');
                            
                            // Special case: when information card is selected, also show map card
                            if (cardId === 'information-card') {
                                const mapCard = document.getElementById('map-card');
                                if (mapCard) {
                                    mapCard.classList.remove('hidden');
                                }
                            }
                            
                            // Initialize dashboard when it becomes visible
                            if (cardId === 'dashboard-card') {
                                initializeDashboard();
                            }
                        });
                    }
                });
            }

            // Initialize card visibility when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeCardVisibility);
            } else {
                initializeCardVisibility();
            }

            // Auto-refresh functionality
            let autoRefreshInterval = null;
            let isPageFocused = true;

            // Check if page is actively focused and visualizer card is visible
            function checkPageFocus() {
                isPageFocused = document.hasFocus();
                const visualizerCard = document.getElementById('visualizer-card');
                const isVisualizerVisible = visualizerCard && !visualizerCard.classList.contains('hidden');
                // console.log("isPageFocused", isPageFocused, "isVisualizerVisible", isVisualizerVisible);
                
                // If page becomes focused and auto-refresh is enabled and visualizer is visible, restart the interval
                if (isPageFocused && document.getElementById('auto-refresh-checkbox').checked && isVisualizerVisible) {
                    startAutoRefresh();
                }
                // If page loses focus or visualizer becomes hidden, clear the interval and uncheck the checkbox
                else if (!isPageFocused || !isVisualizerVisible) {
                    clearAutoRefresh();
                    // Uncheck the auto-refresh checkbox
                    document.getElementById('auto-refresh-checkbox').checked = false;
                }
            }

            // Listen for focus and blur events to detect when user actively clicks on/off the page
            window.addEventListener('focus', checkPageFocus);
            window.addEventListener('blur', checkPageFocus);
            
            // Also listen for visibility changes as a backup
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    // When tab becomes visible, check if it's also focused
                    setTimeout(checkPageFocus, 100); // Small delay to ensure focus state is updated
                } else {
                    // When tab becomes hidden, definitely not focused
                    isPageFocused = false;
                    clearAutoRefresh();
                }
            });

            // Listen for card visibility changes using MutationObserver
            const visualizerCard = document.getElementById('visualizer-card');
            if (visualizerCard) {
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                            const target = mutation.target;
                            const oldClasses = mutation.oldValue || '';
                            const newClasses = target.className;
                            
                            // Only trigger if the 'hidden' class was added or removed
                            const wasHidden = oldClasses.includes('hidden');
                            const isHidden = newClasses.includes('hidden');
                            
                            if (wasHidden !== isHidden) {
                                // console.log('Visualizer card visibility changed, checking focus...');
                                checkPageFocus();
                            }
                        }
                    });
                });
                
                observer.observe(visualizerCard, {
                    attributes: true,
                    attributeFilter: ['class'],
                    attributeOldValue: true // This allows us to see the old class value
                });
            }

            // Auto-refresh checkbox event listener
            document.getElementById('auto-refresh-checkbox').addEventListener('change', function() {
                const visualizerCard = document.getElementById('visualizer-card');
                const isVisualizerVisible = visualizerCard && !visualizerCard.classList.contains('hidden');
                
                if (this.checked && isPageFocused && isVisualizerVisible) {
                    startAutoRefresh();
                } else {
                    clearAutoRefresh();
                }
            });

            function startAutoRefresh() {
                // Clear any existing interval first
                clearAutoRefresh();
                
                // Run setVisualizerNow() after 500ms if page is focused and visualizer is visible
                setTimeout(function() {
                    const visualizerCard = document.getElementById('visualizer-card');
                    const isVisualizerVisible = visualizerCard && !visualizerCard.classList.contains('hidden');
                    
                    if (isPageFocused && document.getElementById('auto-refresh-checkbox').checked && isVisualizerVisible) {
                        setVisualizerNow();
                    }
                }, 10);
                
                // Set up new interval to run setVisualizerNow() every minute
                autoRefreshInterval = setInterval(function() {
                    const visualizerCard = document.getElementById('visualizer-card');
                    const isVisualizerVisible = visualizerCard && !visualizerCard.classList.contains('hidden');
                    
                    if (isPageFocused && document.getElementById('auto-refresh-checkbox').checked && isVisualizerVisible) {
                        setVisualizerNow();
                    }
                }, 30000);
            }

            function clearAutoRefresh() {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        })();
        </script>

    </div>
    
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-links">
                <a href="#" class="footer-link">Documentation</a>
                <a href="https://github.com/thegridelectric" class="footer-link">GitHub</a>
                <a href="#" class="footer-link">Contact</a>
                <div class="theme-selector">
                    <button class="btn btn-sm btn-outline-secondary theme-btn" data-theme="system">
                        <i class="bi bi-display"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary theme-btn" data-theme="dark">
                        <i class="bi bi-moon-fill"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary theme-btn" data-theme="light">
                        <i class="bi bi-sun-fill"></i>
                    </button>
                </div>
            </div>
            <div class="footer-copyright">
                &copy; 2025 GridWorks. All rights reserved.
            </div>
        </div>
    </footer>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Authentication functions
        function getAuthToken() {
            return localStorage.getItem('token');
        }

        function isAuthenticated() {
            return !!getAuthToken();
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = 'login.html';
        }

        // Function to fetch user info
        async function fetchUserInfo() {
            try {
                const response = await fetch(`${api_host}/me`, {
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });
                
                if (response.ok) {
                    const userData = await response.json();
                    const usernameDisplay = document.getElementById('username-display');
                    if (usernameDisplay) {
                        usernameDisplay.textContent = userData.username;
                    }
                } else {
                    console.error('Failed to fetch user info:', response.status);
                }
            } catch (error) {
                console.error('Error fetching user info:', error);
            }
        }

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', function() {
            if (!isAuthenticated()) {
                window.location.href = 'login.html';
                return;
            }

            // Fetch user info
            fetchUserInfo();

            // Fetch and display houses
            fetchHouses();

            // Setup logout button
            const logoutButton = document.getElementById('logout-button');
            if (logoutButton) {
                logoutButton.addEventListener('click', logout);
            }

            // Initialize button states
            updateInfoButtonStates();
            updateVisualizerButtonStates();
            updateDataDownloadButtonStates();
            initializeDashboard();

            // Add event listener for the electricity plot button
            const electricityPlotBtn = document.getElementById('electricity-plot-btn');
            if (electricityPlotBtn) {
                electricityPlotBtn.addEventListener('click', fetchElectricityPlots);
            }

            // Add event listener for the update SCADA button
            const updateScadaBtn = document.getElementById('update-scada-btn');
            if (updateScadaBtn) {
                updateScadaBtn.addEventListener('click', updateScadaCode);
            }

            // Fullscreen toggle functionality
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            const visualizerCard = document.querySelector('.card:has(#plot-container)');

            fullscreenBtn.addEventListener('click', function() {
                const wasFullscreen = visualizerCard.classList.contains('fullscreen');
                visualizerCard.classList.toggle('fullscreen');
                const icon = this.querySelector('i');
                if (visualizerCard.classList.contains('fullscreen')) {
                    icon.classList.remove('bi-arrows-fullscreen');
                    icon.classList.add('bi-arrows-angle-contract');
                } else {
                    icon.classList.remove('bi-arrows-angle-contract');
                    icon.classList.add('bi-arrows-fullscreen');
                    if (wasFullscreen) {
                        visualizerCard.scrollIntoView({ behavior: 'instant', block: 'start' });
                    }
                }
            });

            // Data download card fullscreen toggle functionality
            const dataDownloadFullscreenBtn = document.getElementById('data-download-fullscreen-btn');
            const dataDownloadCard = document.getElementById('data-download-card');

            dataDownloadFullscreenBtn.addEventListener('click', function() {
                const wasFullscreen = dataDownloadCard.classList.contains('fullscreen');
                dataDownloadCard.classList.toggle('fullscreen');
                const icon = this.querySelector('i');
                if (dataDownloadCard.classList.contains('fullscreen')) {
                    icon.classList.remove('bi-arrows-fullscreen');
                    icon.classList.add('bi-arrows-angle-contract');
                } else {
                    icon.classList.remove('bi-arrows-angle-contract');
                    icon.classList.add('bi-arrows-fullscreen');
                    if (wasFullscreen) {
                        dataDownloadCard.scrollIntoView({ behavior: 'instant', block: 'start' });
                    }
                }
            });
        });

        // Fetch houses from API
        async function fetchHouses() {
            try {
                const token = getAuthToken();
                
                const response = await fetch(`${api_host}/homes`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const houses = await response.json();
                    window.houses = houses; // Store houses data globally
                    displayHouses(houses);
                } else {
                    console.error('Failed to fetch houses:', response.status, response.statusText);
                    // If unauthorized, redirect to login
                    if (response.status === 401) {
                        console.log('Unauthorized, redirecting to login page');
                        window.location.href = "login.html";
                    } else if (response.status === 0 || response.status >= 500) {
                        console.error('Server error or network issue. This may be due to CORS restrictions on GitHub Pages.');
                        // Show a user-friendly error message
                        const tableBody = document.getElementById('table-body');
                        if (tableBody) {
                            tableBody.innerHTML = `
                                <tr>
                                    <td colspan="6" class="text-center text-muted">
                                        <i class="bi bi-exclamation-triangle"></i>
                                        Unable to connect to server. This may be due to CORS restrictions when running on GitHub Pages.
                                    </td>
                                </tr>
                            `;
                        }
                    }
                }
            } catch (error) {
                console.error('Error fetching houses:', error);
                // Show a user-friendly error message
                const tableBody = document.getElementById('table-body');
                if (tableBody) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-muted">
                                <i class="bi bi-exclamation-triangle"></i>
                                Network error: ${error.message}
                            </td>
                        </tr>
                    `;
                }
            }
        }

        // Function to display houses in the table
        function displayHouses(houses) {
            const tableBody = document.getElementById('table-body');
            if (!tableBody) {
                console.error('Table body element not found');
                return;
            }
            
            // Clear existing rows
            tableBody.innerHTML = '';
            
            if (!houses || houses.length === 0) {
                // Show empty state
                const emptyState = document.querySelector('.empty-state');
                if (emptyState) {
                    emptyState.style.display = 'block';
                }
                return;
            }
                        
            // Hide empty state
            const emptyState = document.querySelector('.empty-state');
            if (emptyState) {
                emptyState.style.display = 'none';
            }
            
            // Add houses to table
            houses.forEach(house => {
                // Create main row
                const mainRow = document.createElement('tr');
                mainRow.className = 'expandable-row';
                mainRow.setAttribute('data-home-id', house.unique_id);
                
                // Add cells
                mainRow.innerHTML = `
                    <td>
                        <span class="badge ${house.alert_status && house.alert_status.status === 'ok' ? 'bg-success' : house.alert_status && house.alert_status.status === 'alert' ? 'bg-danger' : 'bg-secondary'}">
                            ${house.short_alias || 'N/A'}
                        </span>
                    </td>
                    <td>
                        ${house.address && house.address.city ? 
                            `${house.address.city}${house.address.state ? ', ' + house.address.state : ''}` : 
                            'N/A'}
                    </td>
                    <td>${house.scada_git_commit || 'N/A'}</td>
                    <!-- TODO: Add back in later when ready 
                    <td>
                        <span class="badge ${house.representation_status === 'ListeningToAtn' ? 'bg-primary' : house.representation_status === 'NotListeningToAtn' ? 'bg-warning' : house.representation_status === 'ok' ? 'bg-success' : house.representation_status === 'alert' ? 'bg-danger' : 'bg-secondary'}">
                            ${house.representation_status === 'ListeningToAtn' ? '<i class="bi bi-headphones fs-6" title="ListeningToAtn"></i>' : house.representation_status === 'NotListeningToAtn' ? '<i class="bi bi-incognito fs-6" title="NotListeningToAtn"></i>' : house.representation_status || 'N/A'}
                        </span>
                    </td>
                    -->
                `;
                
                // Create action row
                const actionRow = document.createElement('tr');
                actionRow.className = 'action-row';
                actionRow.setAttribute('data-home-id', house.unique_id);
                actionRow.style.display = 'none';
                
                actionRow.innerHTML = `
                    <td colspan="4">
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-outline-secondary map-btn">Show on map</button>
                            <button class="btn btn-sm btn-outline-secondary visualize-btn">Visualize data</button>
                            <button class="btn btn-sm btn-outline-secondary show-info-btn">Get information</button>
                        </div>
                    </td>
                `;
                
                // Create details row
                const detailsRow = document.createElement('tr');
                detailsRow.className = 'details-row';
                detailsRow.setAttribute('data-home-id', house.unique_id);
                
                // Build address table HTML
                let addressTableHtml = '';
                if (house.address) {
                    addressTableHtml = '<table class="detail-table">';
                    if (house.address.street) {
                        addressTableHtml += `<tr><th>Street</th><td>${house.address.street}</td></tr>`;
                    }
                    if (house.address.city) {
                        addressTableHtml += `<tr><th>City</th><td>${house.address.city}</td></tr>`;
                    }
                    if (house.address.state) {
                        addressTableHtml += `<tr><th>State</th><td>${house.address.state}</td></tr>`;
                    }
                    if (house.address.zip) {
                        addressTableHtml += `<tr><th>ZIP</th><td>${house.address.zip}</td></tr>`;
                    }
                    if (house.address.country) {
                        addressTableHtml += `<tr><th>Country</th><td>${house.address.country}</td></tr>`;
                    }
                    if (house.address.latitude && house.address.longitude) {
                        addressTableHtml += `<tr><th>Coordinates</th><td>${house.address.latitude}, ${house.address.longitude}</td></tr>`;
                    }
                    addressTableHtml += '</table>';
                }
                
                // Build contact table HTML
                let contactTableHtml = '';
                if (house.primary_contact) {
                    contactTableHtml = '<div class="contact-section"><div class="detail-label">Primary Contact</div><table class="detail-table">';
                    if (house.primary_contact.first_name) {
                        contactTableHtml += `<tr><th>First name</th><td>${house.primary_contact.first_name}</td></tr>`;
                    }
                    if (house.primary_contact.last_name) {
                        contactTableHtml += `<tr><th>Last name</th><td>${house.primary_contact.last_name}</td></tr>`;
                    }
                    if (house.primary_contact.email) {
                        contactTableHtml += `<tr><th>Email</th><td>${house.primary_contact.email}</td></tr>`;
                    }
                    if (house.primary_contact.phone) {
                        contactTableHtml += `<tr><th>Phone</th><td>${house.primary_contact.phone}</td></tr>`;
                    }
                    contactTableHtml += '</table></div>';
                }
                if (house.secondary_contact) {
                    contactTableHtml += '<div class="contact-section"><div class="detail-label" style="margin-top: 2rem">Secondary Contact</div><table class="detail-table">';
                    if (house.secondary_contact.first_name) {
                        contactTableHtml += `<tr><th>First name</th><td>${house.secondary_contact.first_name}</td></tr>`;
                    }
                    if (house.secondary_contact.last_name) {
                        contactTableHtml += `<tr><th>Last name</th><td>${house.secondary_contact.last_name}</td></tr>`;
                    }
                    if (house.secondary_contact.email) {
                        contactTableHtml += `<tr><th>Email</th><td>${house.secondary_contact.email}</td></tr>`;
                    }
                    if (house.secondary_contact.phone) {
                        contactTableHtml += `<tr><th>Phone</th><td>${house.secondary_contact.phone}</td></tr>`;
                    }
                    contactTableHtml += '</table></div>';
                }   
                
                detailsRow.innerHTML = `
                    <td colspan="4" class="p-0">
                        <div class="row-details">
                            <div class="details-grid">
                                <div class="detail-item">
                                    <div class="detail-label">Address</div>
                                    <div class="detail-value">
                                        ${addressTableHtml || 'None'}
                                    </div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Contact</div>
                                    <div class="detail-value">
                                        ${contactTableHtml || 'None'}
                                    </div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Status</div>
                                    <div class="detail-value">
                                        ${house.alert_status ? 
                                            `<span class="badge ${house.alert_status.status === 'ok' ? 'bg-success' : house.alert_status.status === 'alert' ? 'bg-danger' : 'bg-secondary'}">
                                                ${house.alert_status.status}
                                                ${house.alert_status.message && house.alert_status.status !== 'alert' ? `<br><small>${house.alert_status.message}</small>` : ''}
                                            </span>` : 
                                            'None'}
                                    </div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Hardware</div>
                                    <div class="detail-value">${house.hardware_layout || 'None'}</div>
                                </div>
                            </div>
                        </div>
                    </td>
                `;
                
                // Add rows to table
                tableBody.appendChild(mainRow);
                tableBody.appendChild(actionRow);
                tableBody.appendChild(detailsRow);
            });
            
            // Initial sort by house alias
            const rows = Array.from(tableBody.querySelectorAll('tr.expandable-row'));
            rows.sort((a, b) => {
                const aValue = a.cells[0].textContent.trim();
                const bValue = b.cells[0].textContent.trim();
                return aValue.localeCompare(bValue);
            });
            
            // Reorder the rows and their corresponding detail rows
            rows.forEach(row => {
                const homeId = row.getAttribute('data-home-id');
                const actionRow = document.querySelector(`.action-row[data-home-id="${homeId}"]`);
                const detailsRow = document.querySelector(`.details-row[data-home-id="${homeId}"]`);
                
                tableBody.appendChild(row);
                tableBody.appendChild(actionRow);
                tableBody.appendChild(detailsRow);
            });
            
            // Update status badges
            updateStatusBadges(houses);
            
            // Add event listeners to the new rows
            addRowEventListeners();
            
            // Update map markers after houses are displayed
            // Use setTimeout to ensure the map is initialized
            setTimeout(() => {
                updateMapMarkers();
                // Fetch electricity plots after table is loaded
                // fetchElectricityPlots(); // Commented out - only plot when Plot button is clicked
            }, 500);
        }

        // Function to update status badges
        function updateStatusBadges(houses) {
            if (!houses || houses.length === 0) {
                return;
            }
            
            const okCount = houses.filter(house => house.alert_status && house.alert_status.status === 'ok').length;
            const alertCount = houses.filter(house => house.alert_status && house.alert_status.status === 'alert').length;
                        
            const okBadge = document.querySelector('.status-badge.ok .status-badge-count');
            const alertBadge = document.querySelector('.status-badge.offline .status-badge-count');
            
            if (okBadge) okBadge.textContent = okCount;
            if (alertBadge) alertBadge.textContent = alertCount;
        }

        // Function to add event listeners to rows
        function addRowEventListeners() {
            const expandableRows = document.querySelectorAll('.expandable-row');
            
            expandableRows.forEach(row => {
                row.addEventListener('click', function(e) {
                    // Prevent default behavior and stop propagation
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const homeId = this.getAttribute('data-home-id');
                    const actionRow = document.querySelector(`.action-row[data-home-id="${homeId}"]`);
                    const detailsRow = document.querySelector(`.details-row[data-home-id="${homeId}"]`);
                    const detailsContent = detailsRow.querySelector('.row-details');
                    
                    // Check which card is currently visible
                    const dashboardCard = document.getElementById('dashboard-card');
                    const visualizerCard = document.getElementById('visualizer-card');
                    const informationCard = document.getElementById('information-card');
                    
                    const isSingleSelectionCard = (dashboardCard && !dashboardCard.classList.contains('hidden')) ||
                                                (visualizerCard && !visualizerCard.classList.contains('hidden')) ||
                                                (informationCard && !informationCard.classList.contains('hidden'));
                    
                    // If this is a single-selection card, unselect all other rows first
                    if (isSingleSelectionCard) {
                        // Unselect all other rows
                        document.querySelectorAll('.expandable-row.expanded').forEach(otherRow => {
                            if (otherRow !== this) {
                                otherRow.classList.remove('expanded');
                                const otherHomeId = otherRow.getAttribute('data-home-id');
                                const otherDetailsRow = document.querySelector(`.details-row[data-home-id="${otherHomeId}"]`);
                                if (otherDetailsRow) {
                                    otherDetailsRow.style.display = 'none';
                                }
                            }
                        });
                    }
                    
                    // Clear previous content in both cards
                    clearPlots();
                    document.getElementById('info-details').style.display = 'none';
                    
                    // Toggle expanded class on the main row
                    this.classList.toggle('expanded');
                    
                    // Update selected house inputs based on all selected rows
                    updateSelectedHouseInputs();
                    
                    // Update button states
                    updateInfoButtonStates();
                    updateVisualizerButtonStates();
                    updateDataDownloadButtonStates();
                    
                    // Reconnect WebSocket with new house selection
                    if (dashboardWebsocket) {
                        dashboardWebsocket.close();
                        dashboardWebsocket = null;
                    }
                    
                    // If dashboard card is currently visible, reconnect WebSocket immediately
                    const currentDashboardCard = document.getElementById('dashboard-card');
                    if (currentDashboardCard && !currentDashboardCard.classList.contains('hidden')) {
                        // Small delay to ensure the input values are updated
                        setTimeout(() => {
                            const selectedHouse = document.getElementById('selected-house').value;
                            if (selectedHouse && selectedHouse.trim() !== '' && 
                                !selectedHouse.includes('Select a single house in the table')) {
                                connectDashboardWebSocket();
                            } else {
                            }
                        }, 10);
                    }
                    
                    // Update map focus based on selection
                    updateMapFocusForMultiSelection();
                    
                    // Fetch electricity plots after selection change
                    // fetchElectricityPlots(); // Commented out - only plot when Plot button is clicked
                });
            });
            
            // Add event listeners for the action buttons
            document.querySelectorAll('.map-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const homeId = this.closest('.action-row').getAttribute('data-home-id');
                    const row = document.querySelector(`.expandable-row[data-home-id="${homeId}"]`);
                    
                    // Hide the details row in the table
                    const detailsRow = document.querySelector(`.details-row[data-home-id="${homeId}"]`);
                    const detailsContent = detailsRow.querySelector('.row-details');
                    if (detailsContent) {
                        detailsContent.classList.remove('expanded');
                    }

                    // Scroll to the Map card
                    const mapCard = document.querySelector('.map-card');
                    mapCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
            });
            
            // Add other event listeners as needed...
        }

        // Replace the theme toggle functionality with this new version
        const themeButtons = document.querySelectorAll('.theme-btn');
        const root = document.documentElement;

        // Function to set theme
        function setTheme(theme) {
            if (theme === 'system') {
                const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
                root.setAttribute('data-theme', systemTheme);
            } else {
                root.setAttribute('data-theme', theme);
            }
            localStorage.setItem('theme-preference', theme);
            updateActiveButton(theme);
        }

        // Function to update active button
        function updateActiveButton(theme) {
            themeButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-theme') === theme) {
                    btn.classList.add('active');
                }
            });
        }

        // Initialize theme
        const savedPreference = localStorage.getItem('theme-preference') || 'system';
        setTheme(savedPreference);

        // Add click handlers to theme buttons
        themeButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const theme = btn.getAttribute('data-theme');
                setTheme(theme);
            });
        });

        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            if (localStorage.getItem('theme-preference') === 'system') {
                setTheme('system');
            }
        });

        // Global variables for map functionality
        let map;
        let markers = [];
        let bounds;

        // Initialize map when the API is loaded
        window.initMap = function() {
            const mapElement = document.getElementById('map');
            if (!mapElement) {
                console.warn('Map element not found');
                return;
            }
            
            if (!isRunningLocally) {
                map = new google.maps.Map(mapElement, {
                    mapId: 'faa6e2dd4dd456ec',
                    disableDefaultUI: true,
                    mapTypeControl: false,
                    streetViewControl: false,
                    fullscreenControl: false,
                    zoomControl: false,
                    rotateControl: false,
                    scaleControl: false,
                    clickableIcons: false,
                    minZoom: 2
                });
            
                // Hide loading indicator
                const loadingIndicator = document.querySelector('.map-loading');
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                updateMapMarkers();
            }
        };

        async function updateMapMarkers() {
            if (!map) {
                console.warn('Map not initialized');
                return;
            }

            // Clear existing markers
            markers.forEach(marker => marker.map = null);
            markers = [];
            bounds = new google.maps.LatLngBounds();

            // Get all visible rows
            const visibleRows = Array.from(document.querySelectorAll('.expandable-row')).filter(
                row => row.style.display !== 'none'
            );

            for (const row of visibleRows) {
                const homeId = row.getAttribute('data-home-id');
                const detailsRow = document.querySelector(`.details-row[data-home-id="${homeId}"]`);
                
                // Skip if details row or address table not found
                if (!detailsRow) {
                    console.warn(`Details row not found for home ID: ${homeId}`);
                    continue;
                }
                
                const addressTable = detailsRow.querySelector('.detail-table');
                if (!addressTable) {
                    console.warn(`Address table not found for home ID: ${homeId}`);
                    continue;
                }
                
                if (addressTable) {
                    const rows = addressTable.querySelectorAll('tr');
                    let lat = null;
                    let lng = null;
                    
                    rows.forEach(row => {
                        const cells = row.querySelectorAll('th, td');
                        if (cells[0].textContent === 'Coordinates') {
                            const coords = cells[1].textContent.split(',').map(coord => parseFloat(coord.trim()));
                            if (coords.length === 2 && !isNaN(coords[0]) && !isNaN(coords[1])) {
                                lat = coords[0];
                                lng = coords[1];
                            }
                        }
                    });

                    if (lat !== null && lng !== null) {
                        const position = { lat, lng };
                        
                        // Create marker element
                        const markerView = new google.maps.marker.AdvancedMarkerElement({
                            map,
                            position,
                            title: row.cells[0].textContent.trim(),
                        });

                        // Create custom marker content
                        const markerContent = document.createElement('div');
                        markerContent.className = 'custom-marker';
                        markerContent.style.width = '16px';
                        markerContent.style.height = '16px';
                        markerContent.style.borderRadius = '50%';
                        markerContent.style.position = 'relative';
                        markerContent.style.overflow = 'hidden';
                        markerContent.style.border = '2px solid #ffffff';
                        
                        // Create the left half (alert status)
                        const leftHalf = document.createElement('div');
                        leftHalf.style.position = 'absolute';
                        leftHalf.style.left = '0';
                        leftHalf.style.top = '0';
                        leftHalf.style.width = '50%';
                        leftHalf.style.height = '100%';
                        // Add null check for cells[0] and badge element
                        const alertStatusBadge = row.cells[0]?.querySelector('.badge');
                        leftHalf.style.backgroundColor = alertStatusBadge?.classList.contains('bg-success') ? '#28a745' : '#ff4444';
                        
                        // Create the right half (representation status)
                        const rightHalf = document.createElement('div');
                        rightHalf.style.position = 'absolute';
                        rightHalf.style.right = '0';
                        rightHalf.style.top = '0';
                        rightHalf.style.width = '50%';
                        rightHalf.style.height = '100%';
                        // Add null check for cells[3] and badge element
                        const repStatusBadge = row.cells[3]?.querySelector('.badge');
                        rightHalf.style.backgroundColor = repStatusBadge?.classList.contains('bg-warning') ? '#ffc107' : '#3a86ff';
                        
                        markerContent.appendChild(leftHalf);
                        markerContent.appendChild(rightHalf);
                        markerContent.style.cursor = 'pointer';
                        
                        markerView.content = markerContent;

                        // Add click listener to marker using gmp-click
                        markerView.addEventListener('gmp-click', () => {
                            const infoWindow = new google.maps.InfoWindow({
                                content: `
                                    <div style="padding: 8px;">
                                        <strong>${row.cells[0].textContent.trim()}</strong><br>
                                        ${row.cells[1].textContent.trim()}<br>
                                        Status: ${row.cells[2].textContent.trim()}
                                    </div>
                                `,
                            });
                            infoWindow.open(map, markerView);
                        });

                        markers.push(markerView);
                        bounds.extend(position);
                    }
                }
            }

            // Fit map to show all markers if there are any
            if (markers.length > 0) {
                // Add padding to bounds
                const ne = bounds.getNorthEast();
                const sw = bounds.getSouthWest();
                const latPadding = (ne.lat() - sw.lat()) * 1.5; // 150% padding
                const lngPadding = (ne.lng() - sw.lng()) * 1.5;
                
                bounds.extend(new google.maps.LatLng(ne.lat() + latPadding, ne.lng() + lngPadding));
                bounds.extend(new google.maps.LatLng(sw.lat() - latPadding, sw.lng() - lngPadding));
                
                map.fitBounds(bounds);

                // If there's only one marker, ensure we stay zoomed out
                if (markers.length === 1) {
                    // Set a minimum zoom level for single markers
                    const listener = google.maps.event.addListener(map, 'idle', function() {
                        if (map.getZoom() > 15) {
                            map.setZoom(15);
                        }
                        google.maps.event.removeListener(listener);
                    });
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const expandableRows = document.querySelectorAll('.expandable-row');
            
            // Initialize date and time fields
            document.getElementById('start-date').value = getDefaultDate(true, false);
            document.getElementById('start-time').value = getDefaultTime(true, false);
            document.getElementById('end-date').value = getDefaultDate(false, false);
            document.getElementById('end-time').value = getDefaultTime(false, false);
            
            // Initialize electricity card date and time fields
            document.getElementById('electricity-start-date').value = getDefaultDate(true, true);
            document.getElementById('electricity-start-time').value = getDefaultTime(true, true);
            document.getElementById('electricity-end-date').value = getDefaultDate(false, true);
            document.getElementById('electricity-end-time').value = getDefaultTime(false, true);
            
            // Initialize data download card date and time fields
            document.getElementById('data-download-start-date').value = getDefaultDate(true, false);
            document.getElementById('data-download-start-time').value = getDefaultTime(true, false);
            document.getElementById('data-download-end-date').value = getDefaultDate(false, false);
            document.getElementById('data-download-end-time').value = getDefaultTime(false, false);
            
            // Add click event listeners to selected house inputs
            document.getElementById('selected-house').addEventListener('click', function() {
                const visualizerCard = document.querySelector('.card:has(#plot-container)');
                if (visualizerCard.classList.contains('fullscreen')) {
                    visualizerCard.classList.remove('fullscreen');
                    const fullscreenBtn = document.getElementById('fullscreen-btn');
                    const icon = fullscreenBtn.querySelector('i');
                    icon.classList.remove('bi-arrows-angle-contract');
                    icon.classList.add('bi-arrows-fullscreen');
                }
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
            
            document.getElementById('electricity-selected-house').addEventListener('click', function() {
                const electricityCard = document.querySelector('.card:has(#electricity-plot-container)');
                if (electricityCard.classList.contains('fullscreen')) {
                    electricityCard.classList.remove('fullscreen');
                    const fullscreenBtn = document.getElementById('electricity-fullscreen-btn');
                    const icon = fullscreenBtn.querySelector('i');
                    icon.classList.remove('bi-arrows-angle-contract');
                    icon.classList.add('bi-arrows-fullscreen');
                }
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
            
            document.getElementById('info-selected-house').addEventListener('click', function() {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
            
            document.getElementById('data-download-selected-house').addEventListener('click', function() {
                const dataDownloadCard = document.getElementById('data-download-card');
                if (dataDownloadCard.classList.contains('fullscreen')) {
                    dataDownloadCard.classList.remove('fullscreen');
                    const fullscreenBtn = document.getElementById('data-download-fullscreen-btn');
                    const icon = fullscreenBtn.querySelector('i');
                    icon.classList.remove('bi-arrows-angle-contract');
                    icon.classList.add('bi-arrows-fullscreen');
                }
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
            
            // Filter toggle functionality
            const filterToggle = document.getElementById('filter-toggle');
            const searchContainer = document.querySelector('.search-container');
            
            if (filterToggle && searchContainer) {
                filterToggle.addEventListener('click', function() {
                    this.classList.toggle('active');
                    
                    // Toggle the search container's display
                    if (searchContainer.style.display === 'flex') {
                        searchContainer.style.display = 'none';
                    } else {
                        searchContainer.style.display = 'flex';
                    }
                });
            }
            
            // Map reset button functionality
            const mapResetBtn = document.getElementById('map-reset-btn');
            mapResetBtn.addEventListener('click', function() {
                // Reset map to show all visible markers without changing UI state
                updateMapMarkers();
            });
            
            // Now button functionality
            const nowBtn = document.getElementById('now-btn');
            nowBtn.addEventListener('click', function() {
                setVisualizerNow();
            });

            // Data download card now button functionality
            const dataDownloadNowBtn = document.getElementById('data-download-now-btn');
            dataDownloadNowBtn.addEventListener('click', function() {
                setDataDownloadNow();
            });
            
            expandableRows.forEach(row => {
                row.addEventListener('click', function(e) {
                    // Prevent default behavior and stop propagation
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const homeId = this.getAttribute('data-home-id');
                    const actionRow = document.querySelector(`.action-row[data-home-id="${homeId}"]`);
                    
                    // Clear previous content in both cards
                    clearPlots();
                    document.getElementById('info-details').style.display = 'none';
                    
                    // Update selected house inputs
                    const selectedHouseInput = document.getElementById('selected-house');
                    const infoSelectedHouseInput = document.getElementById('info-selected-house');
                    const electricitySelectedHouseInput = document.getElementById('electricity-selected-house');
                    selectedHouseInput.value = this.cells[0].textContent.trim();
                    infoSelectedHouseInput.value = this.cells[0].textContent.trim();
                    electricitySelectedHouseInput.value = this.cells[0].textContent.trim();
                    
                    // Update button states
                    updateInfoButtonStates();
                    updateVisualizerButtonStates();
                    updateDataDownloadButtonStates();
                    initializeDashboard();
                    
                    // Toggle expanded class on the main row
                    this.classList.toggle('expanded');
                    
                    // Close other expanded rows
                    expandableRows.forEach(otherRow => {
                        if (otherRow !== this && otherRow.classList.contains('expanded')) {
                            const otherId = otherRow.getAttribute('data-home-id');
                            const otherActionRow = document.querySelector(`.action-row[data-home-id="${otherId}"]`);
                            const otherDetailsRow = document.querySelector(`.details-row[data-home-id="${otherId}"]`);
                            const otherDetailsContent = otherDetailsRow.querySelector('.row-details');
                            
                            otherRow.classList.remove('expanded');
                            otherActionRow.style.display = 'none';
                            otherDetailsContent.classList.remove('expanded');
                        }
                    });
                    
                    // Update map focus based on row expansion state
                    updateMapFocus(this);
                    
                    // Fetch electricity plots after selection change
                    // fetchElectricityPlots(); // Commented out - only plot when Plot button is clicked
                });
            });

            // Add event listeners for the action buttons
            document.querySelectorAll('.map-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const homeId = this.closest('.action-row').getAttribute('data-home-id');
                    const row = document.querySelector(`.expandable-row[data-home-id="${homeId}"]`);
                    
                    // Hide the details row in the table
                    const detailsRow = document.querySelector(`.details-row[data-home-id="${homeId}"]`);
                    const detailsContent = detailsRow.querySelector('.row-details');
                    if (detailsContent) {
                        detailsContent.classList.remove('expanded');
                    }

                    // Scroll to the Map card
                    const mapCard = document.querySelector('.map-card');
                    mapCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
            });

            document.querySelectorAll('.visualize-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const homeId = this.closest('.action-row').getAttribute('data-home-id');
                    const row = document.querySelector(`.expandable-row[data-home-id="${homeId}"]`);
                    
                    // Update selected house input
                    const selectedHouseInput = document.getElementById('selected-house');
                    selectedHouseInput.value = row.cells[0].textContent.trim();
                    
                    // Hide the details row in the table
                    const detailsRow = document.querySelector(`.details-row[data-home-id="${homeId}"]`);
                    const detailsContent = detailsRow.querySelector('.row-details');
                    if (detailsContent) {
                        detailsContent.classList.remove('expanded');
                    }

                    // Scroll to the Visualizer card
                    const visualizerCard = document.querySelector('.card:nth-last-child(2)');
                    visualizerCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
            });

            document.querySelectorAll('.show-info-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const homeId = this.closest('.action-row').getAttribute('data-home-id');
                    const row = document.querySelector(`.expandable-row[data-home-id="${homeId}"]`);
                    const detailsRow = document.querySelector(`.details-row[data-home-id="${homeId}"]`);
                    
                    // Update selected house inputs
                    const selectedHouseInput = document.getElementById('selected-house');
                    const infoSelectedHouseInput = document.getElementById('info-selected-house');
                    const electricitySelectedHouseInput = document.getElementById('electricity-selected-house');
                    selectedHouseInput.value = row.cells[0].textContent.trim();
                    infoSelectedHouseInput.value = row.cells[0].textContent.trim();
                    electricitySelectedHouseInput.value = row.cells[0].textContent.trim();
                    
                    // Update button states
                    updateInfoButtonStates();
                    updateVisualizerButtonStates();
                    updateDataDownloadButtonStates();
                    initializeDashboard();
                    
                    // Show information details
                    document.getElementById('info-details').style.display = 'grid';
                    
                    // Update information card
                    const addressTable = detailsRow.querySelector('.detail-table');
                    const ownerContactTable = detailsRow.querySelector('.detail-item:nth-child(2) .detail-value');
                    const statusBadge = detailsRow.querySelector('.detail-item:nth-child(3) .detail-value .badge');
                    const hardwareLayout = detailsRow.querySelector('.detail-item:nth-child(4) .detail-value');
                    
                    // Update address
                    const infoAddress = document.getElementById('info-address');
                    if (addressTable) {
                        infoAddress.innerHTML = addressTable.outerHTML;
                        const googleMapsLink = detailsRow.querySelector('a[href*="google.com/maps"]');
                        if (googleMapsLink) {
                            infoAddress.appendChild(googleMapsLink.cloneNode(true));
                        }
                    } else {
                        infoAddress.textContent = 'None';
                    }
                    
                    // Update contact
                    const infoContact = document.getElementById('info-contact');
                    if (ownerContactTable) {
                        // Get all contact sections from the details row
                        const contactSections = detailsRow.querySelectorAll('.detail-item:nth-child(2) .detail-value .contact-section');
                        let contactHtml = '';
                        contactSections.forEach(section => {
                            contactHtml += section.outerHTML;
                        });
                        infoContact.innerHTML = contactHtml || 'None';
                    } else {
                        console.log('No contact table found in details row');
                        infoContact.textContent = 'None';
                    }
                    
                    // Update status
                    const infoStatus = document.getElementById('info-status');
                    
                    if (statusBadge) {
                        const homeId = targetRow.getAttribute('data-home-id');
                        const house = window.houses.find(h => String(h.unique_id) === String(homeId));
                        infoStatus.innerHTML = `
                            ${statusBadge.outerHTML}
                            ${house?.alert_status?.message ? `<div class="mt-2" style="color: var(--text-muted); font-size: 0.875rem; padding-top: 1rem;">Alert:${house.alert_status.message}</div>` : ''}
                            ${house?.alert_status?.message ? `<button class="btn btn-sm btn-outline-secondary mt-2" onclick="reactToAlert('${homeId}', 'ok')">Close alert</button>` : ''}
                        `;
                    } else {
                        infoStatus.textContent = 'None';
                    }
                    
                    // Update hardware
                    const infoHardware = document.getElementById('info-hardware');
                    if (hardwareLayout) {
                        infoHardware.textContent = hardwareLayout.textContent;
                    } else {
                        infoHardware.textContent = 'None';
                    }

                    // Hide the details row in the table
                    const detailsContent = detailsRow.querySelector('.row-details');
                    if (detailsContent) {
                        detailsContent.classList.remove('expanded');
                    }

                    // Scroll to the Information card
                    const infoCard = document.getElementById('information-card');
                    infoCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                });
            });
            
            // Table sorting functionality
            const tableHeaders = document.querySelectorAll('.table th[data-sort]');
            let currentSort = {
                column: 'short_alias',
                direction: 'asc'
            };
            
            // Set initial sort indicator
            document.querySelector('th[data-sort="short_alias"]').classList.add('sort-asc');
            
            // Initial sort by house alias
            const tbody = document.querySelector('.table tbody');
            const rows = Array.from(tbody.querySelectorAll('tr.expandable-row'));
            
            rows.sort((a, b) => {
                const aValue = a.cells[0].textContent.trim();
                const bValue = b.cells[0].textContent.trim();
                return aValue.localeCompare(bValue);
            });
            
            // Reorder the rows and their corresponding detail rows
            rows.forEach(row => {
                const homeId = row.getAttribute('data-home-id');
                const detailsRow = document.querySelector(`.details-row[data-home-id="${homeId}"]`);
                
                tbody.appendChild(row);
                tbody.appendChild(detailsRow);
            });
            
            tableHeaders.forEach(header => {
                header.addEventListener('click', function() {
                    const column = this.getAttribute('data-sort');
                    const tbody = document.querySelector('.table tbody');
                    const rows = Array.from(tbody.querySelectorAll('tr.expandable-row'));
                    
                    // Toggle sort direction if clicking the same column
                    if (currentSort.column === column) {
                        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.column = column;
                        currentSort.direction = 'asc';
                    }
                    
                    // Update sort indicators
                    tableHeaders.forEach(h => {
                        h.classList.remove('sort-asc', 'sort-desc');
                    });
                    this.classList.add(`sort-${currentSort.direction}`);
                    
                    // Sort the rows
                    rows.sort((a, b) => {
                        let aValue, bValue;
                        
                        if (column === 'short_alias') {
                            aValue = a.cells[0].textContent.trim();
                            bValue = b.cells[0].textContent.trim();
                        } else if (column === 'address') {
                            aValue = a.cells[1].textContent.trim();
                            bValue = b.cells[1].textContent.trim();
                        } else if (column === 'commit') {
                            aValue = a.cells[2].textContent.trim();
                            bValue = b.cells[2].textContent.trim();
                        } else if (column === 'status') {
                            aValue = a.cells[3].textContent.trim();
                            bValue = b.cells[3].textContent.trim();
                        }
                        
                        // Handle empty values
                        if (aValue === 'N/A') aValue = '';
                        if (bValue === 'N/A') bValue = '';
                        
                        // Compare values
                        if (aValue < bValue) return currentSort.direction === 'asc' ? -1 : 1;
                        if (aValue > bValue) return currentSort.direction === 'asc' ? 1 : -1;
                        return 0;
                    });
                    
                    // Reorder the rows and their corresponding detail rows
                    rows.forEach(row => {
                        const homeId = row.getAttribute('data-home-id');
                        const detailsRow = document.querySelector(`.details-row[data-home-id="${homeId}"]`);
                        
                        tbody.appendChild(row);
                        tbody.appendChild(detailsRow);
                    });
                });
            });
            
            // Search functionality
            const searchInputs = {
                alias: document.getElementById('search-alias'),
                city: document.getElementById('search-city'),
                commit: document.getElementById('search-commit'),
                // TODO: Add back in later when ready
                // status: document.getElementById('search-status')
            };
            
            const clearSearchBtn = document.getElementById('clear-search');
            const noResultsDiv = document.querySelector('.no-results');
            const tableContainer = document.querySelector('.table-responsive');
            
            // Function to filter rows based on search criteria
            function filterRows() {
                const aliasFilter = searchInputs.alias ? searchInputs.alias.value.toLowerCase() : '';
                const cityFilter = searchInputs.city ? searchInputs.city.value.toLowerCase() : '';
                const commitFilter = searchInputs.commit ? searchInputs.commit.value.toLowerCase() : '';
                // TODO: Add back in later when ready
                // const statusFilter = searchInputs.status ? searchInputs.status.value.toLowerCase() : '';
                
                const rows = document.querySelectorAll('.expandable-row');
                let visibleCount = 0;
                let visibleAliases = new Set();
                
                // Remove any existing no-results row
                const existingNoResults = document.querySelector('.no-results-row');
                if (existingNoResults) {
                    existingNoResults.remove();
                }
                
                rows.forEach(row => {
                    const alias = row.cells[0].textContent.trim().toLowerCase();
                    const city = row.cells[1].textContent.trim().toLowerCase();
                    const commit = row.cells[2].textContent.trim().toLowerCase();
                    // TODO: Add back in later when ready
                    // const statusCell = row.cells[3].textContent.trim().toLowerCase();
                    // const statusIcon = row.cells[3].querySelector('i');
                    // const status = statusIcon ? 
                    //     (statusIcon.classList.contains('bi-headphones') ? 'listeningtoatn' : 
                    //      statusIcon.classList.contains('bi-incognito') ? 'notlisteningtoatn' : 
                    //      statusCell) : 
                    //     statusCell;
                    
                    const matchesAlias = alias.startsWith(aliasFilter);
                    const matchesCity = city.startsWith(cityFilter);
                    const matchesCommit = commit.startsWith(commitFilter);
                    // TODO: Add back in later when ready
                    // const matchesStatus = status.startsWith(statusFilter);
                    if (matchesAlias && matchesCity && matchesCommit) { // && matchesStatus
                        // TODO: Add back in later when ready
                        row.style.display = '';
                        const detailsRow = document.querySelector(`.details-row[data-home-id="${row.getAttribute('data-home-id')}"]`);
                        if (detailsRow) detailsRow.style.display = '';
                        visibleCount++;
                        visibleAliases.add(row.cells[0].textContent.trim());
                    } else {
                        row.style.display = 'none';
                        const detailsRow = document.querySelector(`.details-row[data-home-id="${row.getAttribute('data-home-id')}"]`);
                        if (detailsRow) detailsRow.style.display = 'none';
                    }
                });
                
                // If no results, add a no-results row
                if (visibleCount === 0) {
                    const noResultsRow = document.createElement('tr');
                    noResultsRow.className = 'no-results-row';
                    noResultsRow.innerHTML = '<td colspan="4"><span>No results found</span></td>';
                    tableContainer.appendChild(noResultsRow);
                }
                
                // Convert current visible aliases to a sorted string for comparison
                const currentVisibleAliasesStr = Array.from(visibleAliases).sort().join(',');
                
                // Only fetch electricity plots if the visible houses have changed
                if (currentVisibleAliasesStr !== window.previousVisibleAliasesStr) {
                    window.previousVisibleAliasesStr = currentVisibleAliasesStr;
                    // fetchElectricityPlots(); // Commented out - only plot when Plot button is clicked
                }
                
                // Return the count of visible rows
                return visibleCount;
            }
            
            // Initialize the previous visible aliases string
            window.previousVisibleAliasesStr = '';
            
            // Track the previous count of visible rows
            let previousVisibleCount = -1;
            
            // Add event listeners to search inputs
            Object.values(searchInputs).forEach(input => {
                if (input) {
                input.addEventListener('input', function() {
                    const currentVisibleCount = filterRows();
                    
                    // Only update the map if the number of visible rows has changed
                    if (currentVisibleCount !== previousVisibleCount) {
                        updateMapMarkers();
                        previousVisibleCount = currentVisibleCount;
                    }
                    
                    // Toggle active class based on whether input has value
                    if (this.value.trim() !== '') {
                        this.classList.add('active');
                    } else {
                        this.classList.remove('active');
                    }
                });
                }
            });
            
            // Clear search button
            clearSearchBtn.addEventListener('click', function() {
                Object.values(searchInputs).forEach(input => {
                    if (input) {
                    input.value = '';
                    }
                });
                const currentVisibleCount = filterRows();
                updateMapMarkers();
                previousVisibleCount = currentVisibleCount;
            });
            
            // Clear filters button
            const clearFiltersBtn = document.getElementById('clear-filters');
            
            if (clearFiltersBtn) {
            clearFiltersBtn.addEventListener('click', function() {
                Object.values(searchInputs).forEach(input => {
                        if (input) {
                    input.value = '';
                    input.classList.remove('active');
                        }
                });
                const currentVisibleCount = filterRows();
                updateMapMarkers();
                previousVisibleCount = currentVisibleCount;
            });
            }

            fetch(`${api_host}/google-maps-api-key`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${getAuthToken()}`
                }
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    console.error('Failed to fetch Google Maps API key:', response.status, response.statusText);
                    // If unauthorized, redirect to login
                    if (response.status === 401) {
                        console.log('Unauthorized, redirecting to login page');
                        window.location.href = "login.html";
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
            })
            .then(data => {
                let google_maps_api_key = data.api_key;
                // Load Google Maps API with loading=async parameter and error handling
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${google_maps_api_key}&callback=initMap&libraries=marker&v=beta&loading=async`;
                script.async = true;
                script.defer = true;
                script.onerror = function() {
                    console.warn('Google Maps script failed to load. This might be due to an ad blocker.');
                };
                document.head.appendChild(script);
            })
            .catch(error => {
                console.error('Failed to fetch Google Maps API key:', error);
            });
        });

        // Function to update map focus based on row expansion state
        function updateMapFocus(row) {
            if (!map) {
                console.warn('Map not initialized');
                return;
            }
            
            const isExpanded = row.classList.contains('expanded');
            
            if (isExpanded) {
                // Get coordinates for the expanded row
                const homeId = row.getAttribute('data-home-id');
                const detailsRow = document.querySelector(`.details-row[data-home-id="${homeId}"]`);
                const addressTable = detailsRow.querySelector('.detail-table');
                
                if (addressTable) {
                    const rows = addressTable.querySelectorAll('tr');
                    let lat = null;
                    let lng = null;
                    
                    rows.forEach(row => {
                        const cells = row.querySelectorAll('th, td');
                        if (cells[0].textContent === 'Coordinates') {
                            const coords = cells[1].textContent.split(',').map(coord => parseFloat(coord.trim()));
                            if (coords.length === 2 && !isNaN(coords[0]) && !isNaN(coords[1])) {
                                lat = coords[0];
                                lng = coords[1];
                            }
                        }
                    });

                    if (lat !== null && lng !== null) {
                        // Create a bounds object with just this location
                        const position = new google.maps.LatLng(lat, lng);
                        const bounds = new google.maps.LatLngBounds();
                        bounds.extend(position);
                        
                        // Add padding to bounds
                        const ne = bounds.getNorthEast();
                        const sw = bounds.getSouthWest();
                        const latPadding = (ne.lat() - sw.lat()) * 0.5; // 50% padding
                        const lngPadding = (ne.lng() - sw.lng()) * 0.5;
                        
                        bounds.extend(new google.maps.LatLng(ne.lat() + latPadding, ne.lng() + lngPadding));
                        bounds.extend(new google.maps.LatLng(sw.lat() - latPadding, sw.lng() - lngPadding));
                        
                        // Fit map to this location
                        map.fitBounds(bounds);
                        
                        // Set a maximum zoom level for single location
                        const listener = google.maps.event.addListener(map, 'idle', function() {
                            if (map.getZoom() > 15) {
                                map.setZoom(15);
                            }
                            google.maps.event.removeListener(listener);
                        });
                    }
                }
            } else {
                // If row is collapsed, zoom out to show all visible markers
                updateMapMarkers();
            }
        }

        // Function to update selected house inputs based on all selected rows
        function updateSelectedHouseInputs() {
            const selectedRows = document.querySelectorAll('.expandable-row.expanded');
            const selectedHouses = Array.from(selectedRows).map(row => row.cells[0].textContent.trim());
            
            const selectedHouseInput = document.getElementById('selected-house');
            const infoSelectedHouseInput = document.getElementById('info-selected-house');
            const electricitySelectedHouseInput = document.getElementById('electricity-selected-house');
            const morningSelectedHouseInput = document.getElementById('morning-selected-house');
            const dataDownloadSelectedHouseInput = document.getElementById('data-download-selected-house');
            
            if (selectedHouses.length === 0) {
                // No houses selected
                selectedHouseInput.value = '';
                infoSelectedHouseInput.value = '';
                electricitySelectedHouseInput.value = '';
                morningSelectedHouseInput.value = '';
                dataDownloadSelectedHouseInput.value = '';
            } else if (selectedHouses.length === 1) {
                // Single house selected
                const houseAlias = selectedHouses[0];
                selectedHouseInput.value = houseAlias;
                infoSelectedHouseInput.value = houseAlias;
                electricitySelectedHouseInput.value = houseAlias;
                morningSelectedHouseInput.value = houseAlias;
                dataDownloadSelectedHouseInput.value = houseAlias;
            } else {
                // Multiple houses selected
                const houseList = selectedHouses.join(', ');
                selectedHouseInput.value = 'Select a single house in the table';
                infoSelectedHouseInput.value = 'Select a single house in the table';
                electricitySelectedHouseInput.value = houseList;
                morningSelectedHouseInput.value = houseList;
                dataDownloadSelectedHouseInput.value = 'Select a single house in the table';
            }
        }

        // Function to update map focus for multi-selection
        function updateMapFocusForMultiSelection() {
            if (!map) {
                console.warn('Map not initialized');
                return;
            }
            
            const selectedRows = document.querySelectorAll('.expandable-row.expanded');
            
            if (selectedRows.length === 0) {
                // No houses selected, show all markers
                updateMapMarkers();
            } else if (selectedRows.length === 1) {
                // Single house selected, focus on that house
                updateMapFocus(selectedRows[0]);
            } else {
                // Multiple houses selected, show default position (all houses)
                updateMapMarkers();
            }
        }

        let isRunningLocally = false;
        let api_host = isRunningLocally ? 'http://localhost:8000' : 'https://visualizer.electricity.works';

        function getDefaultDate(start, electricity_use) {
            const nyDate = new Date(new Date().toLocaleString("en-US", { timeZone: "America/New_York" }));
            if (electricity_use) {
                if (start) { 
                    nyDate.setDate(nyDate.getDate() - 1);
                    nyDate.setHours(0, 0, 0, 0);
                } else {
                    nyDate.setMinutes(nyDate.getMinutes() + 1);  
                } 
            } else {
                if (start) { 
                    nyDate.setDate(nyDate.getDate() - 1);
                    nyDate.setHours(20, 0, 0, 0);
                } else {
                    nyDate.setMinutes(nyDate.getMinutes() + 1);  
                } 
            }
            const year = nyDate.getFullYear();
            const month = String(nyDate.getMonth() + 1).padStart(2, '0');
            const day = String(nyDate.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getDefaultTime(start, electricity_use) {
            const nyDate = new Date(new Date().toLocaleString("en-US", { timeZone: "America/New_York" }));
            if (electricity_use) {
                if (start) { 
                    nyDate.setDate(nyDate.getDate() - 1);
                    nyDate.setHours(0, 0, 0, 0);
                } else {
                    nyDate.setMinutes(nyDate.getMinutes() + 1);  
                }
            } else {
                if (start) { 
                    nyDate.setDate(nyDate.getDate() - 1);
                    nyDate.setHours(20, 0, 0, 0);
                } else {
                    nyDate.setMinutes(nyDate.getMinutes() + 1);  
                }  
            }
            const hours = String(nyDate.getHours()).padStart(2, '0');
            const minutes = String(nyDate.getMinutes()).padStart(2, '0');

            return `${hours}:${minutes}`;
        }

        function setNow() {
            const nyDate = new Date(new Date().toLocaleString("en-US", { timeZone: "America/New_York" }));
            nyDate.setMinutes(nyDate.getMinutes() + 1);
            document.getElementById('morning-end-date').value = nyDate.toISOString().split('T')[0];
            document.getElementById('morning-end-time').value = nyDate.toTimeString().split(' ')[0].substring(0, 5);
        }

        function setDataDownloadNow() {
            const nyDate = new Date(new Date().toLocaleString("en-US", { timeZone: "America/New_York" }));
            nyDate.setMinutes(nyDate.getMinutes() + 1);
            document.getElementById('data-download-end-date').value = nyDate.toISOString().split('T')[0];
            document.getElementById('data-download-end-time').value = nyDate.toTimeString().split(' ')[0].substring(0, 5);
        }

        function setVisualizerNow() {
            // Check if the now-btn is enabled, if not return early to prevent double calls
            const nowBtn = document.getElementById('now-btn');
            if (nowBtn.disabled) {
                return;
            }
            document.getElementById('start-date').value = getDefaultDate(true);
            document.getElementById('start-time').value = getDefaultTime(true);
            document.getElementById('end-date').value = getDefaultDate(false);
            document.getElementById('end-time').value = getDefaultTime(false);
            // const nyDate = new Date(new Date().toLocaleString("en-US", { timeZone: "America/New_York" }));
            // nyDate.setMinutes(nyDate.getMinutes() + 1);
            // document.getElementById('end-date').value = nyDate.toISOString().split('T')[0];
            // document.getElementById('end-time').value = nyDate.toTimeString().split(' ')[0].substring(0, 5);
            getData();
        }

        function clearPlots() {
            const plotDivs = [
                document.getElementById('plot1'),
                document.getElementById('plot2'),
                document.getElementById('plot3'),
                document.getElementById('plot4'),
                document.getElementById('plot5'),
                document.getElementById('plot6'),
                document.getElementById('plot7'),
                document.getElementById('plot8'),
                document.getElementById('plot9'),
                document.getElementById('plot10'),
                document.getElementById('plot11'),
                document.getElementById('plot-png')
            ];
            plotDivs.forEach(div => {
                while (div.firstChild) {
                    div.removeChild(div.firstChild);
                }
            });
            const plotContainer = document.getElementById('plot-container');
            plotContainer.style.display = 'none';
        }

        function disableButton(buttonId) {
            const button = document.getElementById(buttonId);
            button.disabled = true;
            button.style.opacity = '0.5';
            const loader = document.querySelector('.card:has(#plot-container) .card-header .loader');
            if (loader) {
                loader.style.display = 'inline-block';
            }
        }

        function enableButton(buttonId) {
            const button = document.getElementById(buttonId);
            button.disabled = false;
            button.style.opacity = '1';
            const loader = document.querySelector('.card:has(#plot-container) .card-header .loader');
            if (loader) {
                loader.style.display = 'none';
            }
        }

        // Add event listener for the plot button
        document.getElementById('plot-btn').addEventListener('click', getData);

        // Add event listener for the CSV button
        document.getElementById('csv-btn').addEventListener('click', exportCSV);

        // Add event listener for the FLO button
        document.getElementById('flo-btn').addEventListener('click', downloadFLO);

        // Add event listener for the data download CSV button
        document.getElementById('data-download-csv-btn').addEventListener('click', exportDataDownloadCSV);

        // Function to export CSV
        async function exportCSV(event) {
            event.preventDefault();
            const houseAlias = document.getElementById('selected-house').value;
            
            // Check if a house is selected
            if (!houseAlias || houseAlias.trim() === '') {
                return;
            }
            
            const startDate = document.getElementById('start-date').value;
            const startTime = document.getElementById('start-time').value;
            const endDate = document.getElementById('end-date').value;
            const endTime = document.getElementById('end-time').value;

            const startDateTime = luxon.DateTime.fromFormat(`${startDate} ${startTime}`, 'yyyy-MM-dd HH:mm', { zone: 'America/New_York' });
            const endDateTime = luxon.DateTime.fromFormat(`${endDate} ${endTime}`, 'yyyy-MM-dd HH:mm', { zone: 'America/New_York' });
            
            const startUnixMilliseconds = startDateTime.toUTC().toMillis();
            const endUnixMilliseconds = endDateTime.toUTC().toMillis();

            const selectedChannels = Array.from(document.querySelectorAll('input[name="channels"]:checked'))
                .map(checkbox => checkbox.value);
            const timestep = document.getElementById('csv-timestep').value;

            disableButton('csv-btn');

            try {
                const response = await fetch(`${api_host}/csv`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify({
                        house_alias: houseAlias,
                        password: '',
                        start_ms: startUnixMilliseconds,
                        end_ms: endUnixMilliseconds,
                        selected_channels: selectedChannels,
                        timestep: timestep,
                        confirm_with_user: false
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const contentType = response.headers.get("Content-Type");
                if (contentType && contentType.includes("application/json")) {
                    const data = await response.json();
                    if ('success' in data && data.success === false) {
                        if (data.confirm_with_user) {
                            const userChoice = confirm(data.message);
                            if (userChoice) {
                                await exportCSV(event);
                            }
                        } else {
                            console.error('Error:', data.message);
                        }
                    }
                } else {
                    const startDate = new Date(startUnixMilliseconds);
                    const formattedStartDate = startDate.toISOString().slice(0, 16).replace('T', '-');
                    const endDate = new Date(endUnixMilliseconds);
                    const formattedEndDate = endDate.toISOString().slice(0, 16).replace('T', '-');
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${houseAlias}_${timestep}s_${formattedStartDate}-${formattedEndDate}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(url);
                }
            } catch (error) {
                console.error('Error getting CSV:', error);
            } finally {
                enableButton('csv-btn');
            }
        }

        // Function to export CSV for data download card
        async function exportDataDownloadCSV(event) {
            event.preventDefault();
            const houseAlias = document.getElementById('data-download-selected-house').value;
            
            // Check if a house is selected
            if (!houseAlias || houseAlias.trim() === '') {
                return;
            }
            
            const startDate = document.getElementById('data-download-start-date').value;
            const startTime = document.getElementById('data-download-start-time').value;
            const endDate = document.getElementById('data-download-end-date').value;
            const endTime = document.getElementById('data-download-end-time').value;

            const startDateTime = luxon.DateTime.fromFormat(`${startDate} ${startTime}`, 'yyyy-MM-dd HH:mm', { zone: 'America/New_York' });
            const endDateTime = luxon.DateTime.fromFormat(`${endDate} ${endTime}`, 'yyyy-MM-dd HH:mm', { zone: 'America/New_York' });
            
            const startUnixMilliseconds = startDateTime.toUTC().toMillis();
            const endUnixMilliseconds = endDateTime.toUTC().toMillis();

            const selectedChannels = Array.from(document.querySelectorAll('input[name="data-download-channels"]:checked'))
                .map(checkbox => checkbox.value);
            const timestep = document.getElementById('data-download-csv-timestep').value;

            disableButton('data-download-csv-btn');

            try {
                const response = await fetch(`${api_host}/csv`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify({
                        house_alias: houseAlias,
                        password: '',
                        start_ms: startUnixMilliseconds,
                        end_ms: endUnixMilliseconds,
                        selected_channels: selectedChannels,
                        timestep: timestep,
                        confirm_with_user: false
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const contentType = response.headers.get("Content-Type");
                if (contentType && contentType.includes("application/json")) {
                    const data = await response.json();
                    if ('success' in data && data.success === false) {
                        if (data.confirm_with_user) {
                            const userChoice = confirm(data.message);
                            if (userChoice) {
                                await exportDataDownloadCSV(event);
                            }
                        } else {
                            console.error('Error:', data.message);
                        }
                    }
                } else {
                    const startDate = new Date(startUnixMilliseconds);
                    const formattedStartDate = startDate.toISOString().slice(0, 16).replace('T', '-');
                    const endDate = new Date(endUnixMilliseconds);
                    const formattedEndDate = endDate.toISOString().slice(0, 16).replace('T', '-');
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${houseAlias}_${timestep}s_${formattedStartDate}-${formattedEndDate}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(url);
                }
            } catch (error) {
                console.error('Error getting CSV:', error);
            } finally {
                enableButton('data-download-csv-btn');
            }
        }

        // Function to download FLO
        async function downloadFLO(event) {
            event.preventDefault();
            const houseAlias = document.getElementById('selected-house').value;
            
            // Check if a house is selected
            if (!houseAlias || houseAlias.trim() === '') {
                return;
            }
            
            const endDate = document.getElementById('end-date').value;
            const endTime = document.getElementById('end-time').value;

            const endDateTime = luxon.DateTime.fromFormat(`${endDate} ${endTime}`, 'yyyy-MM-dd HH:mm', { zone: 'America/New_York' });
            const endUnixMilliseconds = endDateTime.toUTC().toMillis();

            disableButton('flo-btn');

            try {
                const response = await fetch(`${api_host}/flo`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify({
                        house_alias: houseAlias,
                        password: '',
                        time_ms: endUnixMilliseconds
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const blob = await response.blob();
                const link = document.createElement('a');
                const url = window.URL.createObjectURL(blob);
                link.href = url;
                const endDateFile = new Date(endUnixMilliseconds);
                const newYorkDate = endDateFile.toLocaleString('en-US', { 
                    timeZone: 'America/New_York', 
                    hour12: false, 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric', 
                    hour: 'numeric', 
                })
                .replace(/,/g, '')
                .replace(/\s/g, '_')
                .toLowerCase();
                link.download = `flo_${houseAlias}_${newYorkDate}.xlsx`;
                link.click();
                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error getting FLO excel file:', error);
            } finally {
                enableButton('flo-btn');
            }
        }

        // Options functionality
        const optionsBtn = document.getElementById('options-btn');
        const optionsDiv = document.getElementById('options-div');
        const closeOptionsBtn = document.getElementById('close-options-button');

        // Initialize options div display state
        optionsDiv.style.display = 'none';

        function toggleOptions() {
            optionsDiv.style.display = optionsDiv.style.display === 'none' ? 'flex' : 'none';
        }

        optionsBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            toggleOptions();
        });

        if (closeOptionsBtn) {
            closeOptionsBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                toggleOptions();
            });
        }

        // Close options when clicking outside
        optionsDiv.addEventListener('click', function(e) {
            if (e.target === optionsDiv) {
                toggleOptions();
            }
        });

        // Data download options functionality
        const dataDownloadOptionsBtn = document.getElementById('data-download-options-btn');
        const dataDownloadOptionsDiv = document.getElementById('data-download-options-div');

        // Initialize data download options div display state
        dataDownloadOptionsDiv.style.display = 'none';

        function toggleDataDownloadOptions() {
            dataDownloadOptionsDiv.style.display = dataDownloadOptionsDiv.style.display === 'none' ? 'flex' : 'none';
        }

        dataDownloadOptionsBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            toggleDataDownloadOptions();
        });

        // Close data download options when clicking outside
        dataDownloadOptionsDiv.addEventListener('click', function(e) {
            if (e.target === dataDownloadOptionsDiv) {
                toggleDataDownloadOptions();
            }
        });

        // Data download select all/unselect all functionality
        document.getElementById('data-download-select-all-btn').addEventListener('click', function() {
            const checkboxes = document.querySelectorAll('input[name="data-download-channels"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
        });

        document.getElementById('data-download-unselect-all-btn').addEventListener('click', function() {
            const checkboxes = document.querySelectorAll('input[name="data-download-channels"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
        });

        // Update getData function to use selected channels
        async function getData(event) {
            if (event) {
                event.preventDefault();
            }
            const houseAlias = document.getElementById('selected-house').value;
            
            // Check if a house is selected
            if (!houseAlias || houseAlias.trim() === '') {
                return;
            }
            
            const startDate = document.getElementById('start-date').value;
            const startTime = document.getElementById('start-time').value;
            const endDate = document.getElementById('end-date').value;
            const endTime = document.getElementById('end-time').value;

            const startDateTime = luxon.DateTime.fromFormat(`${startDate} ${startTime}`, 'yyyy-MM-dd HH:mm', { zone: 'America/New_York' });
            const endDateTime = luxon.DateTime.fromFormat(`${endDate} ${endTime}`, 'yyyy-MM-dd HH:mm', { zone: 'America/New_York' });
            
            const startUnixMilliseconds = startDateTime.toUTC().toMillis();
            const endUnixMilliseconds = endDateTime.toUTC().toMillis();

            const selectedChannels = Array.from(document.querySelectorAll('input[name="channels"]:checked'))
                .map(checkbox => checkbox.value);

            disableButton('plot-btn');
            disableButton('now-btn');
            await fetchPlots(houseAlias, startUnixMilliseconds, endUnixMilliseconds, selectedChannels);
            enableButton('plot-btn');
            enableButton('now-btn');
        }

        // Update fetchPlots function to show/hide loader
        async function fetchPlots(houseAlias, startMs, endMs, selectedChannels) {
            const plotBtn = document.getElementById('plot-btn');
            
            plotBtn.disabled = true;
            plotBtn.style.opacity = '0.5';
            
            try {
                // Check if we're in dark mode
                const isDarkMode = root.getAttribute('data-theme') === 'dark' || 
                    (root.getAttribute('data-theme') === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);

                const response = await fetch(`${api_host}/plots`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify({
                        house_alias: houseAlias,
                        password: '',
                        start_ms: startMs,
                        end_ms: endMs,
                        selected_channels: selectedChannels,
                        confirm_with_user: false,
                        darkmode: isDarkMode
                    })
                });

                const contentType = response.headers.get("Content-Type");
                if (contentType && contentType.includes("application/json")) {
                    const data = await response.json();
                    if ('success' in data && data.success === false) {
                        console.error('Error:', data.message);
                    }
                } else {
                    const blob = await response.blob();
                    const zip = await JSZip.loadAsync(blob);
                    clearPlots();
                    
                    const plotContainer = document.getElementById('plot-container');
                    plotContainer.style.display = 'block';
                    
                    let iframeCount = 0;
                    const plotDivs = [
                        document.getElementById('plot1'),
                        document.getElementById('plot2'),
                        document.getElementById('plot3'),
                        document.getElementById('plot4'),
                        document.getElementById('plot5'),
                        document.getElementById('plot6'),
                        document.getElementById('plot7'),
                        document.getElementById('plot8'),
                        document.getElementById('plot9'),
                        document.getElementById('plot10'),
                        document.getElementById('plot11'),
                        document.getElementById('plot-png')
                    ];

                    for (const filename of Object.keys(zip.files)) {
                        const fileData = await zip.files[filename].async('blob');
                        if (filename.endsWith('.html')) {
                            const blob = new Blob([await zip.files[filename].async('text')], { type: 'text/html' });
                            const htmlUrl = URL.createObjectURL(blob);
                            const iframe = document.createElement('iframe');
                            iframe.src = htmlUrl;
                            iframe.style.width = window.innerWidth < 650 ? '100%' : '97.5%';
                            iframe.style.height = '375px';
                            iframe.style.maxWidth = '1500px';
                            iframe.style.border = 'none';
                            
                            const currentDiv = plotDivs[iframeCount % plotDivs.length];
                            currentDiv.appendChild(iframe);
                            iframeCount++;
                        } else if (filename.endsWith('.png')) {
                            const imgUrl = URL.createObjectURL(fileData);
                            const img = document.createElement('img');
                            img.src = imgUrl;
                            img.alt = 'Plot Image';
                            document.getElementById('plot-png').appendChild(img);
                        }
                    }
                }
            } catch (error) {
                console.error('Error getting plots:', error);
            } finally {
                plotBtn.disabled = false;
                plotBtn.style.opacity = '1';
            }
        }

        // Function to update button states based on house selection
        function updateInfoButtonStates() {
            const houseAlias = document.getElementById('info-selected-house').value;
            const buttons = [
                document.getElementById('show-address-btn'),
                document.getElementById('show-contact-btn'),
                document.getElementById('show-status-btn'),
                document.getElementById('show-hardware-btn')
            ];
            
            // Only enable buttons if exactly one house is selected
            const hasSingleSelectedHouse = houseAlias && 
                houseAlias.trim() !== '' && 
                houseAlias.trim() !== 'Select a single house in the table';
            
            buttons.forEach(button => {
                if (button) {
                    button.disabled = !hasSingleSelectedHouse;
                    button.style.opacity = hasSingleSelectedHouse ? '1' : '0.5';
                }
            });
        }

        // Function to update visualizer button states based on house selection
        function updateVisualizerButtonStates() {
            const houseAlias = document.getElementById('selected-house').value;
            const buttons = [
                document.getElementById('plot-btn'),
                document.getElementById('csv-btn'),
                document.getElementById('flo-btn'),
                document.getElementById('now-btn')
            ];
            
            // Only enable buttons if exactly one house is selected
            const hasSingleSelectedHouse = houseAlias && 
                houseAlias.trim() !== '' && 
                houseAlias.trim() !== 'Select a single house in the table';
            
            buttons.forEach(button => {
                if (button) {
                    button.disabled = !hasSingleSelectedHouse;
                    button.style.opacity = hasSingleSelectedHouse ? '1' : '0.5';
                }
            });
        }

        // Function to update data download button states based on house selection
        function updateDataDownloadButtonStates() {
            const houseAlias = document.getElementById('data-download-selected-house').value;
            const buttons = [
                document.getElementById('data-download-csv-btn')
            ];
            
            // Only enable buttons if exactly one house is selected
            const hasSingleSelectedHouse = houseAlias && 
                houseAlias.trim() !== '' && 
                houseAlias.trim() !== 'Select a single house in the table';
            
            buttons.forEach(button => {
                if (button) {
                    button.disabled = !hasSingleSelectedHouse;
                    button.style.opacity = hasSingleSelectedHouse ? '1' : '0.5';
                }
            });
        }

        // Add event listener for the info reset button
        const infoResetBtn = document.getElementById('info-reset-btn');
        infoResetBtn.addEventListener('click', function() {
            document.getElementById('info-details').style.display = 'none';
            // Clear the selected house input
            document.getElementById('info-selected-house').value = '';
            // Update button states
            updateInfoButtonStates();
            initializeDashboard();
        });

        // Add event listener for the get info button
        document.getElementById('show-address-btn').addEventListener('click', function() {
            const houseAlias = document.getElementById('info-selected-house').value;
            if (!houseAlias) {
                return; // No house selected
            }
            
            // Find the row with this house alias
            const rows = document.querySelectorAll('.expandable-row');
            let targetRow = null;
            
            for (const row of rows) {
                if (row.cells[0].textContent.trim() === houseAlias) {
                    targetRow = row;
                    break;
                }
            }
            
            if (targetRow) {
                const homeId = targetRow.getAttribute('data-home-id');
                const detailsRow = document.querySelector(`.details-row[data-home-id="${homeId}"]`);
                const addressSection = document.getElementById('address-section');
                
                // Check if address section is already visible
                if (addressSection.style.display === 'block') {
                    // If visible, hide it and hide the container if no other sections are visible
                    addressSection.style.display = 'none';
                    if (!document.querySelector('.detail-item[style*="display: block"]')) {
                        document.getElementById('info-details').style.display = 'none';
                    }
                } else {
                    // Hide all sections first
                    document.querySelectorAll('.detail-item').forEach(item => {
                        item.style.display = 'none';
                    });
                    
                    // Show the address section
                    addressSection.style.display = 'block';
                    document.getElementById('info-details').style.display = 'grid';
                    
                    // Update address
                    const addressTable = detailsRow.querySelector('.detail-table');
                    const infoAddress = document.getElementById('info-address');
                    if (addressTable) {
                        infoAddress.innerHTML = addressTable.outerHTML;
                        const googleMapsLink = detailsRow.querySelector('a[href*="google.com/maps"]');
                        if (googleMapsLink) {
                            infoAddress.appendChild(googleMapsLink.cloneNode(true));
                        }
                    } else {
                        infoAddress.textContent = 'None';
                    }
                }
            }
        });

        document.getElementById('show-contact-btn').addEventListener('click', function() {
            const houseAlias = document.getElementById('info-selected-house').value;
            if (!houseAlias) {
                return; // No house selected
            }
            
            // Find the row with this house alias
            const rows = document.querySelectorAll('.expandable-row');
            let targetRow = null;
            
            for (const row of rows) {
                if (row.cells[0].textContent.trim() === houseAlias) {
                    targetRow = row;
                    break;
                }
            }
            
            if (targetRow) {
                const homeId = targetRow.getAttribute('data-home-id');
                const detailsRow = document.querySelector(`.details-row[data-home-id="${homeId}"]`);
                const contactSection = document.getElementById('contact-section');
                
                // Check if contact section is already visible
                if (contactSection.style.display === 'block') {
                    // If visible, hide it and hide the container if no other sections are visible
                    contactSection.style.display = 'none';
                    if (!document.querySelector('.detail-item[style*="display: block"]')) {
                        document.getElementById('info-details').style.display = 'none';
                    }
                } else {
                    // Hide all sections first
                    document.querySelectorAll('.detail-item').forEach(item => {
                        item.style.display = 'none';
                    });
                    
                    // Show the contact section
                    contactSection.style.display = 'block';
                    document.getElementById('info-details').style.display = 'grid';
                    
                    // Update contact
                    const ownerContactTable = detailsRow.querySelector('.detail-item:nth-child(2) .detail-value');
                    const infoContact = document.getElementById('info-contact');
                    if (ownerContactTable) {
                        // Get all contact sections from the details row
                        const contactSections = detailsRow.querySelectorAll('.detail-item:nth-child(2) .detail-value .contact-section');
                        let contactHtml = '';
                        contactSections.forEach(section => {
                            contactHtml += section.outerHTML;
                        });
                        infoContact.innerHTML = contactHtml || 'None';
                    } else {
                        console.log('No contact table found in details row');
                        infoContact.textContent = 'None';
                    }
                }
            }
        });

        document.getElementById('show-status-btn').addEventListener('click', function() {
            const houseAlias = document.getElementById('info-selected-house').value;
            if (!houseAlias) {
                return; // No house selected
            }
            
            // Find the row with this house alias
            const rows = document.querySelectorAll('.expandable-row');
            let targetRow = null;
            
            for (const row of rows) {
                if (row.cells[0].textContent.trim() === houseAlias) {
                    targetRow = row;
                    break;
                }
            }
            
            if (targetRow) {
                const homeId = targetRow.getAttribute('data-home-id');
                const detailsRow = document.querySelector(`.details-row[data-home-id="${homeId}"]`);
                const statusSection = document.getElementById('status-section');
                
                // Check if status section is already visible
                if (statusSection.style.display === 'block') {
                    // If visible, hide it and hide the container if no other sections are visible
                    statusSection.style.display = 'none';
                    if (!document.querySelector('.detail-item[style*="display: block"]')) {
                        document.getElementById('info-details').style.display = 'none';
                    }
                } else {
                    // Hide all sections first
                    document.querySelectorAll('.detail-item').forEach(item => {
                        item.style.display = 'none';
                    });
                    
                    // Show the status section
                    statusSection.style.display = 'block';
                    document.getElementById('info-details').style.display = 'grid';
                    
                    // Update status
                    const statusBadge = detailsRow.querySelector('.detail-item:nth-child(3) .detail-value .badge');
                    const infoStatus = document.getElementById('info-status');
                    if (statusBadge) {
                        const homeId = targetRow.getAttribute('data-home-id');
                        const house = window.houses.find(h => String(h.unique_id) === String(homeId));
                        
                        infoStatus.innerHTML = `
                            ${statusBadge.outerHTML}
                            ${house?.alert_status?.message ? `<div class="mt-2" style="color: var(--text-muted); font-size: 0.875rem; padding-top: 1rem;">Alert: ${house.alert_status.message}</div>` : ''}
                            ${house?.alert_status?.message ? `<button class="btn btn-sm btn-outline-secondary mt-2" onclick="reactToAlert('${homeId}', 'ok')">Close alert</button>` : ''}
                        `;
                    } else {
                        infoStatus.textContent = 'None';
                    }
                }
            }
        });

        document.getElementById('show-hardware-btn').addEventListener('click', function() {
            const houseAlias = document.getElementById('info-selected-house').value;
            if (!houseAlias) {
                return; // No house selected
            }
            
            // Find the row with this house alias
            const rows = document.querySelectorAll('.expandable-row');
            let targetRow = null;
            
            for (const row of rows) {
                if (row.cells[0].textContent.trim() === houseAlias) {
                    targetRow = row;
                    break;
                }
            }
            
            if (targetRow) {
                const homeId = targetRow.getAttribute('data-home-id');
                const detailsRow = document.querySelector(`.details-row[data-home-id="${homeId}"]`);
                const hardwareSection = document.getElementById('hardware-section');
                
                // Check if hardware section is already visible
                if (hardwareSection.style.display === 'block') {
                    // If visible, hide it and hide the container if no other sections are visible
                    hardwareSection.style.display = 'none';
                    if (!document.querySelector('.detail-item[style*="display: block"]')) {
                        document.getElementById('info-details').style.display = 'none';
                    }
                } else {
                    // Hide all sections first
                    document.querySelectorAll('.detail-item').forEach(item => {
                        item.style.display = 'none';
                    });
                    
                    // Show the hardware section
                    hardwareSection.style.display = 'block';
                    document.getElementById('info-details').style.display = 'grid';
                    
                    // Update hardware
                    const hardwareLayout = detailsRow.querySelector('.detail-item:nth-child(4) .detail-value');
                    const infoHardware = document.getElementById('info-hardware');
                    if (hardwareLayout) {
                        infoHardware.textContent = hardwareLayout.textContent;
                    } else {
                        infoHardware.textContent = 'None';
                    }
                }
            }
        });

        document.getElementById('clear-btn').addEventListener('click', function() {
            clearPlots();
            // Update button states but keep selected house
            updateVisualizerButtonStates();
            initializeDashboard();
        });

        document.getElementById('data-download-clear-btn').addEventListener('click', function() {
            // Clear the selected house input and update button states
            document.getElementById('data-download-selected-house').value = '';
            updateDataDownloadButtonStates();
        });

        async function login(username, password) {
            const response = await fetch(`${api_host}/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'username': username,
                    'password': password,
                })
            });
            
            if (response.ok) {
                const data = await response.json();
                // Store the token
                localStorage.setItem('token', data.access_token);
                return true;
            }
            return false;
        }

        // Electricity card fullscreen functionality
        const electricityFullscreenBtn = document.getElementById('electricity-fullscreen-btn');
        const electricityCard = document.querySelector('.card:has(#electricity-plot-container)');

        electricityFullscreenBtn.addEventListener('click', function() {
            const wasFullscreen = electricityCard.classList.contains('fullscreen');
            electricityCard.classList.toggle('fullscreen');
            const icon = this.querySelector('i');
            if (electricityCard.classList.contains('fullscreen')) {
                icon.classList.remove('bi-arrows-fullscreen');
                icon.classList.add('bi-arrows-angle-contract');
            } else {
                icon.classList.remove('bi-arrows-angle-contract');
                icon.classList.add('bi-arrows-fullscreen');
                if (wasFullscreen) {
                    electricityCard.scrollIntoView({ behavior: 'instant', block: 'start' });
                }
            }
        });

        // Electricity card clear button functionality
        document.getElementById('electricity-clear-btn').addEventListener('click', function() {
            clearElectricityPlots();
        });

        // Electricity card now button functionality
        document.getElementById('electricity-now-btn').addEventListener('click', function() {
            setElectricityNow();
        });

        // Dashboard card fullscreen functionality
        const dashboardFullscreenBtn = document.getElementById('dashboard-fullscreen-btn');
        const dashboardCard = document.getElementById('dashboard-card');

        dashboardFullscreenBtn.addEventListener('click', function() {
            const wasFullscreen = dashboardCard.classList.contains('fullscreen');
            dashboardCard.classList.toggle('fullscreen');
            const icon = this.querySelector('i');
            if (dashboardCard.classList.contains('fullscreen')) {
                icon.classList.remove('bi-arrows-fullscreen');
                icon.classList.add('bi-arrows-angle-contract');
            } else {
                icon.classList.remove('bi-arrows-angle-contract');
                icon.classList.add('bi-arrows-fullscreen');
                if (wasFullscreen) {
                    dashboardCard.scrollIntoView({ behavior: 'instant', block: 'start' });
                }
            }
        });

        // Dashboard snapshot button functionality
        const dashboardSnapshotBtn = document.getElementById('dashboard-snapshot-btn');
        dashboardSnapshotBtn.addEventListener('click', function() {
            sendRequestSnapshot();
        });

        // Dashboard JavaScript functionality
        let dashboardWebsocket = null;
        let dashboardRelays = {};
        let dashboardThermostatNames = [];
        let dashboardCurrentUserId = 'user_' + Math.random().toString(36).substr(2, 9);

        function sendRequestSnapshot() {
            if (!dashboardWebsocket || dashboardWebsocket.readyState !== WebSocket.OPEN) {
                console.error('Not connected to server');
                return;
            }

            const message = {
                type: 'request_snapshot',
                data: {}
            };

            dashboardWebsocket.send(JSON.stringify(message));
        }

        function connectDashboardWebSocket() {
            // Close any existing WebSocket connection first
            if (dashboardWebsocket) {
                dashboardWebsocket.close();
                dashboardWebsocket = null;
            }
            
            // Get the selected house to determine the correct WebSocket endpoint
            const selectedHouse = document.getElementById('selected-house').value;
            const protocol = 'wss:';
            wsUrl = `${protocol}//visualizer.electricity.works/ws${selectedHouse}`;
            
            dashboardWebsocket = new WebSocket(wsUrl);
            
            dashboardWebsocket.onopen = function(event) {
                document.getElementById('dashboard-status-left').textContent = 'Connected';
                document.getElementById('dashboard-status-right').textContent = '';
                showDashboardContent();
            };
            
            dashboardWebsocket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleDashboardMessage(data);
            };
            
            dashboardWebsocket.onerror = function(error) {
                console.error('Dashboard WebSocket error:', error);
                console.error('WebSocket readyState:', dashboardWebsocket.readyState);
                console.error('WebSocket URL:', dashboardWebsocket.url);
                document.getElementById('dashboard-status-left').textContent = 'Error, connection failed';
                document.getElementById('dashboard-status-right').textContent = '-';
                
                // More specific error information
                if (window.location.hostname.includes('github.io')) {
                    console.warn('WebSocket connection failed from GitHub Pages - checking if port 8080 is accessible');
                } else {
                    console.warn('WebSocket connection failed locally - check if WebSocket server is running on port 8080');
                }
            };

            const statusLeft = document.getElementById('dashboard-status-left');
            const snapshotTime = document.getElementById('dashboard-snapshot-timestamp');
            if (statusLeft) statusLeft.style.color = 'var(--text-color)';
            if (snapshotTime) snapshotTime.style.display = 'block';
        }

        function handleDashboardMessage(data) {
            if (data.type === 'status') {
                updateDashboardStatus(data);
            } else if (data.type === 'mqtt_message') {
                if (data.message_type === 'single.reading') {
                    updateDashboardRelayState(data.payload);
                } else if (data.message_type === 'snapshot.spaceheat') {
                    updateDashboardMonitoringTables(data.payload);
                }
            } else if (data.type === 'error') {
                console.error('Dashboard Error: ' + data.message);
            }
        }

        function updateDashboardStatus(data) {
            let leftStatus = '';
            let rightStatus = '';
            
            const gnodeParts = data.target_gnode ? data.target_gnode.split('.') : [];
            const beforeLastPart = gnodeParts.length > 1 ? gnodeParts[gnodeParts.length - 2] : '';
            const capitalizedPart = beforeLastPart.charAt(0).toUpperCase() + beforeLastPart.slice(1);
            if (data.target_gnode) {
                leftStatus = `<b>${capitalizedPart}</b>`;
            }
            
            if (data.target_gnode) {
                rightStatus = `<span style="color: var(--text-muted); font-size: 1em;">${data.target_gnode}</span>`;
            }
            
            document.getElementById('dashboard-status-left').innerHTML = leftStatus;
            document.getElementById('dashboard-status-right').innerHTML = rightStatus;
            
            if (data.relays) {
                dashboardRelays = data.relays;
                updateDashboardPipeColors(null);
            }
            
            if (data.thermostat_names) {
                dashboardThermostatNames = data.thermostat_names;
            }
        }

        function updateDashboardRelayState(payload) {
            if (payload && payload.relay_name && payload.state) {
                dashboardRelays[payload.relay_name] = {
                    ...dashboardRelays[payload.relay_name],
                    state: payload.state
                };
                updateDashboardPipeColors(null);
            }
        }

        function updateDashboardMonitoringTables(snapshotData) {
            updateDashboardSnapshotTimestamp(snapshotData);
            updateDashboardThermostatTable(snapshotData);
            updateDashboardPowerPumpTable(snapshotData);
            updateTankTemperatures(snapshotData);
            updateDashboardPipeColors(snapshotData);
        }

        function updateDashboardSnapshotTimestamp(snapshotData) {
            const timestampElement = document.getElementById('dashboard-snapshot-time');
            const lastSnapshotText = document.getElementById('dashboard-snapshot-timestamp')
            if (!timestampElement) return;
            
            if (snapshotData && snapshotData.SnapshotTimeUnixMs) {
                const timestamp = new Date(snapshotData.SnapshotTimeUnixMs);
                const formattedTime = timestamp.toLocaleString('sv-SE', {
                    timeZone: 'America/New_York',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
                timestampElement.textContent = formattedTime;
                
                // Check if timestamp is more than 5 minutes ago and apply red color
                const now = new Date();
                const twoMinutesAgo = new Date(now.getTime() - 2 * 60 * 1000);
                const dashboardLoader = document.getElementById('dashboard-loader');
                
                if (timestamp < twoMinutesAgo) {
                    lastSnapshotText.style.color = 'red';
                    lastSnapshotText.style.fontWeight = 'bold';
                    timestampElement.style.color = 'red';
                    timestampElement.style.fontWeight = 'bold';
                    // Hide the "next snapshot" text and loader when data is stale
                    if (dashboardLoader) {
                        dashboardLoader.style.display = 'none';
                    }
                } else {
                    lastSnapshotText.style.color = 'var(--text-muted)';
                    lastSnapshotText.style.fontWeight = '';
                    timestampElement.style.color = 'var(--text-muted)';
                    timestampElement.style.fontWeight = '';
                    // Show the "next snapshot" text and loader when data is fresh
                    if (dashboardLoader) {
                        dashboardLoader.style.display = 'flex';
                    }
                }
            } else {
                timestampElement.textContent = 'Unknown';
            }
        }

        function updateDashboardThermostatTable(snapshotData) {
            const tbody = document.getElementById('dashboard-thermostat-tbody');
            if (!tbody || !snapshotData.LatestReadingList) return;
            
            if (!dashboardThermostatNames || dashboardThermostatNames.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="border: 1px solid var(--border-color); padding: 8px; text-align: center;">Loading thermostat names...</td></tr>';
                return;
            }
            
            const zones = dashboardThermostatNames.map((name, index) => ({
                key: `zone${index + 1}-${name}`,
                display: `zone${index + 1}-${name}`
            }));
            
            const readingsMap = {};
            snapshotData.LatestReadingList.forEach(reading => {
                readingsMap[reading.ChannelName] = reading;
            });
            
            tbody.innerHTML = '';
            
            zones.forEach(zone => {
                const tempReading = readingsMap[`${zone.key}-temp`];
                const setPointReading = readingsMap[`${zone.key}-set`];
                const stateReading = readingsMap[`${zone.key}-state`];
                
                const tempF = tempReading ? (tempReading.Value / 1000).toFixed(1) : '-';
                const setPointF = setPointReading ? (setPointReading.Value / 1000).toFixed(1) : '-';
                const state = stateReading ? (stateReading.Value > 0 ? 'heating' : 'idle') : 'idle';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="border: 1px solid var(--border-color); padding: 6px; font-size: 0.8rem; color: var(--text-muted);">${zone.display}</td>
                    <td style="border: 1px solid var(--border-color); padding: 6px; font-size: 0.8rem; color: var(--text-muted);">${setPointF}°F</td>
                    <td style="border: 1px solid var(--border-color); padding: 6px; font-size: 0.8rem; color: var(--text-muted);">${tempF}°F</td>
                    <td style="border: 1px solid var(--border-color); padding: 6px; font-size: 0.8rem; color: var(--text-muted);">${state}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateDashboardPowerPumpTable(snapshotData) {
            if (!snapshotData.LatestReadingList) return;
            
            const readingsMap = {};
            snapshotData.LatestReadingList.forEach(reading => {
                readingsMap[reading.ChannelName] = reading;
            });
            
            updateDashboardHpPowerTable(readingsMap);
            updateDashboardPumpTable(readingsMap);
        }

        function updateDashboardHpPowerTable(readingsMap) {
            const tbody = document.getElementById('dashboard-hp-power-tbody');
            if (!tbody) return;
            
            const hpOduReading = readingsMap['hp-odu-pwr'];
            const hpIduReading = readingsMap['hp-idu-pwr'];
            const hpTotalReading = hpOduReading && hpIduReading ? 
                { Value: hpOduReading.Value + hpIduReading.Value } : null;
            
            const hpTotalKw = hpTotalReading ? (hpTotalReading.Value / 1000).toFixed(2) : '0.00';
            const hpOduKw = hpOduReading ? (hpOduReading.Value / 1000).toFixed(2) : '0.00';
            const hpIduKw = hpIduReading ? (hpIduReading.Value / 1000).toFixed(2) : '0.00';
            
            tbody.innerHTML = '';
            
            const row2 = document.createElement('tr');
            row2.innerHTML = `
                <td style="border: 1px solid var(--border-color); padding: 6px; font-size: 0.8rem; color: var(--text-muted);">Outdoor unit</td>
                <td style="border: 1px solid var(--border-color); padding: 6px; font-size: 0.8rem; color: var(--text-muted);">${hpOduKw}</td>
            `;
            tbody.appendChild(row2);
            
            const row3 = document.createElement('tr');
            row3.innerHTML = `
                <td style="border: 1px solid var(--border-color); padding: 6px; font-size: 0.8rem; color: var(--text-muted);">Indoor unit</td>
                <td style="border: 1px solid var(--border-color); padding: 6px; font-size: 0.8rem; color: var(--text-muted);">${hpIduKw}</td>
            `;
            tbody.appendChild(row3);

            const row1 = document.createElement('tr');
            row1.innerHTML = `
                <td style="border: 1px solid var(--border-color); padding: 6px; font-size: 0.8rem; color: var(--text-muted);">Total</td>
                <td style="border: 1px solid var(--border-color); padding: 6px; font-size: 0.8rem; color: var(--text-muted);">${hpTotalKw}</td>
            `;
            tbody.appendChild(row1);
        }

        function updateDashboardPumpTable(readingsMap) {
            const tbody = document.getElementById('dashboard-pump-tbody');
            if (!tbody) return;
            
            const primaryFlowReading = readingsMap['primary-flow'];
            const primaryPowerReading = readingsMap['primary-pump-pwr'];
            const distFlowReading = readingsMap['dist-flow'];
            const distPowerReading = readingsMap['dist-pump-pwr'];
            const storeFlowReading = readingsMap['store-flow'];
            const storePowerReading = readingsMap['store-pump-pwr'];
            
            tbody.innerHTML = '';
            
            const row1 = document.createElement('tr');
            row1.innerHTML = `
                <td style="border: 1px solid var(--border-color); padding: 6px; font-size: 0.8rem; color: var(--text-muted);">Primary</td>
                <td style="border: 1px solid var(--border-color); padding: 6px; font-size: 0.8rem; color: var(--text-muted);">${primaryFlowReading ? (primaryFlowReading.Value / 100).toFixed(1) : '0.0'}</td>
                <td style="border: 1px solid var(--border-color); padding: 6px; font-size: 0.8rem; color: var(--text-muted);">${primaryPowerReading && primaryPowerReading.Value > 0 ? primaryPowerReading.Value.toFixed(1) : '0.0'}</td>
            `;
            tbody.appendChild(row1);
            
            const row2 = document.createElement('tr');
            row2.innerHTML = `
                <td style="border: 1px solid var(--border-color); padding: 6px; font-size: 0.8rem; color: var(--text-muted);">Distribution</td>
                <td style="border: 1px solid var(--border-color); padding: 6px; font-size: 0.8rem; color: var(--text-muted);">${distFlowReading ? (distFlowReading.Value / 100).toFixed(1) : '0.0'}</td>
                <td style="border: 1px solid var(--border-color); padding: 6px; font-size: 0.8rem; color: var(--text-muted);">${distPowerReading && distPowerReading.Value > 0 ? distPowerReading.Value.toFixed(1) : '0.0'}</td>
            `;
            tbody.appendChild(row2);
            
            const row3 = document.createElement('tr');
            row3.innerHTML = `
                <td style="border: 1px solid var(--border-color); padding: 6px; font-size: 0.8rem; color: var(--text-muted);">Store</td>
                <td style="border: 1px solid var(--border-color); padding: 6px; font-size: 0.8rem; color: var(--text-muted);">${storeFlowReading ? (storeFlowReading.Value / 100).toFixed(1) : '0.0'}</td>
                <td style="border: 1px solid var(--border-color); padding: 6px; font-size: 0.8rem; color: var(--text-muted);">${storePowerReading && storePowerReading.Value > 0 ? storePowerReading.Value.toFixed(1) : '0.0'}</td>
            `;
            tbody.appendChild(row3);
        }

        function updateDashboardLayerBackground(temp) {
            const minTemp = 50;
            const maxTemp = 160;
            const normalizedTemp = (temp - minTemp) / (maxTemp - minTemp);
            const red = Math.min(255, Math.floor(255 * normalizedTemp));
            const blue = Math.min(255, Math.floor(255 * (1 - normalizedTemp)));
            const backgroundColor = `rgba(${red}, 0, ${blue}, 0.86)`;
            return backgroundColor;
        }

        function updateDashboardTankTemperatures(snapshotData) {
            if (!snapshotData || !snapshotData.LatestReadingList) return;
            
            const readingsMap = {};
            snapshotData.LatestReadingList.forEach(reading => {
                readingsMap[reading.ChannelName] = reading;
            });
            
            // Update each tank's temperature readings
            for (let tankNum = 1; tankNum <= 3; tankNum++) {
                for (let depth = 1; depth <= 3; depth++) {
                    const channelName = `tank${tankNum}-depth${depth}`;
                    const reading = readingsMap[channelName];
                    const elementId = `dashboard-tank${tankNum}-depth${depth}`;
                    const element = document.getElementById(elementId);
                    
                    if (element && reading) {
                        const tempC = reading.Value / 1000;
                        const tempF = (tempC * 9/5 + 32).toFixed(1);
                        element.textContent = `${tempF}°F`;
                        
                        const sectionElement = document.getElementById(`dashboard-tank${tankNum}-section${depth}`);
                        if (sectionElement) {
                            const tempFNum = parseFloat(tempF);
                            const backgroundColor = updateDashboardLayerBackground(tempFNum);
                            sectionElement.setAttribute('fill', backgroundColor);
                        }
                    } else if (element) {
                        element.textContent = '-';
                    }
                }
            }
            
            // Update buffer temperature readings
            for (let depth = 1; depth <= 3; depth++) {
                const channelName = `buffer-depth${depth}`;
                const reading = readingsMap[channelName];
                const elementId = `dashboard-buffer-depth${depth}`;
                const element = document.getElementById(elementId);
                
                if (element && reading) {
                    const tempC = reading.Value / 1000;
                    const tempF = (tempC * 9/5 + 32).toFixed(1);
                    element.textContent = `${tempF}°F`;
                    
                    const sectionElement = document.getElementById(`dashboard-buffer-section${depth}`);
                    if (sectionElement) {
                        const tempFNum = parseFloat(tempF);
                        const backgroundColor = updateDashboardLayerBackground(tempFNum);
                        sectionElement.setAttribute('fill', backgroundColor);
                    }
                } else if (element) {
                    element.textContent = '-';
                }
            }
            
            // Update heat pump temperatures
            const hpLwtReading = readingsMap['hp-lwt'];
            const hpEwtReading = readingsMap['hp-ewt'];
            let hpLwtTempF = null;
            let hpEwtTempF = null;
            
            if (hpLwtReading) {
                const tempC = hpLwtReading.Value / 1000;
                hpLwtTempF = parseFloat((tempC * 9/5 + 32).toFixed(1));
                document.getElementById('dashboard-hp-lwt').textContent = `${hpLwtTempF}°F`;
            } else {
                document.getElementById('dashboard-hp-lwt').textContent = '-';
            }
            
            if (hpEwtReading) {
                const tempC = hpEwtReading.Value / 1000;
                hpEwtTempF = parseFloat((tempC * 9/5 + 32).toFixed(1));
                document.getElementById('dashboard-hp-ewt').textContent = `${hpEwtTempF}°F`;
            } else {
                document.getElementById('dashboard-hp-ewt').textContent = '-';
            }
            
            // Calculate and update heat pump lift
            const hpLiftElement = document.getElementById('dashboard-hp-lift');
            if (hpLiftElement && hpLwtTempF !== null && hpEwtTempF !== null) {
                const lift = (hpLwtTempF - hpEwtTempF).toFixed(1);
                hpLiftElement.innerHTML = `Lift<tspan x="80" dy="1.2em">${lift}°F</tspan>`;
            } else if (hpLiftElement) {
                hpLiftElement.innerHTML = `Lift<tspan x="80" dy="1.2em">-°F</tspan>`;
            }
            
            // Update house distribution temperatures
            const distSwtReading = readingsMap['dist-swt'];
            const distRwtReading = readingsMap['dist-rwt'];
            let distSwtTempF = null;
            let distRwtTempF = null;
            
            if (distSwtReading) {
                const tempC = distSwtReading.Value / 1000;
                distSwtTempF = parseFloat((tempC * 9/5 + 32).toFixed(1));
                document.getElementById('dashboard-dist-swt').textContent = `${distSwtTempF}°F`;
            } else {
                document.getElementById('dashboard-dist-swt').textContent = '-';
            }
            
            if (distRwtReading) {
                const tempC = distRwtReading.Value / 1000;
                distRwtTempF = parseFloat((tempC * 9/5 + 32).toFixed(1));
                document.getElementById('dashboard-dist-rwt').textContent = `${distRwtTempF}°F`;
            } else {
                document.getElementById('dashboard-dist-rwt').textContent = '-';
            }
            
            // Calculate and update house drop
            const houseDropElement = document.getElementById('dashboard-house-drop');
            if (houseDropElement && distSwtTempF !== null && distRwtTempF !== null) {
                const drop = (distSwtTempF - distRwtTempF).toFixed(1);
                houseDropElement.innerHTML = `Drop<tspan x="720" dy="1.2em">${drop}°F</tspan>`;
            } else if (houseDropElement) {
                houseDropElement.innerHTML = `Drop<tspan x="720" dy="1.2em">-°F</tspan>`;
            }
        }

        function updateDashboardPipeColors(snapshotData) {
            // Check if SVG diagram is visible
            const systemDiagram = document.getElementById('dashboard-system-diagram');
            const diagramSvg = document.getElementById('dashboard-diagram-svg');
            
            // Check if SVG patterns exist
            const flowPattern = document.getElementById('dashboardFlowPattern');
            const leftFlowPattern = document.getElementById('dashboardLeftFlowPattern');
            
            // Check for distribution flow to animate House pipes
            const readingsMap = {};
            if (snapshotData && snapshotData.LatestReadingList) {
                snapshotData.LatestReadingList.forEach(reading => {
                    readingsMap[reading.ChannelName] = reading;
                });
            }
            
            const distFlowReading = readingsMap['dist-flow'];
            const hasDistFlow = distFlowReading && distFlowReading.Value && parseFloat(distFlowReading.Value) > 0;

            const primFlowReading = readingsMap['primary-flow'];
            const hasPrimFlow = primFlowReading && primFlowReading.Value && parseFloat(primFlowReading.Value) > 0;

            const storeFlowReading = readingsMap['store-flow'];
            const hasStoreFlow = storeFlowReading && storeFlowReading.Value && parseFloat(storeFlowReading.Value) > 0;

            const hpIduReading = readingsMap['hp-idu-pwr'];
            const hpOduReading = readingsMap['hp-odu-pwr'];
            const hasHpPowerReading = hpIduReading && hpOduReading && hpIduReading.Value > 0 && hpOduReading.Value > 0;
            let hpHasPower = false;
            if (hasHpPowerReading) {
                const totalHpKw = hpIduReading.Value/1000 + hpOduReading.Value/1000;
                if (totalHpKw > 0.5) {
                    hpHasPower = true;
                }
            }

            // Check for zone relay conditions: Failsf relay with state "energized" and Scada ops relay with state "energized"
            let hasZoneRelayCondition = false;
            Object.keys(dashboardRelays).forEach(relayName => {
                const relay = dashboardRelays[relayName];
                if (relay && relay.display_name) {
                    const displayName = relay.display_name.toLowerCase();
                    
                    // Check if this is a Failsf relay with state "energized"
                    if (displayName.includes('failsf') && relay.state === 'energized') {
                        // Find the corresponding Scada ops relay for the same zone
                        Object.keys(dashboardRelays).forEach(otherRelayName => {
                            const otherRelay = dashboardRelays[otherRelayName];
                            if (otherRelay && otherRelay.display_name) {
                                const otherDisplayName = otherRelay.display_name.toLowerCase();
                                
                                // Check if this is a Scada ops relay for the same zone with state "energized"
                                if (otherDisplayName.includes('scada ops') && otherRelay.state === 'energized') {
                                    // Extract zone identifier from the beginning of the display name
                                    const zoneFromFailsf = displayName.split(' zone ')[0].trim();
                                    const zoneFromScadaOps = otherDisplayName.split(' zone ')[0].trim();
                                    
                                    if (zoneFromFailsf === zoneFromScadaOps && zoneFromFailsf !== '') {
                                        hasZoneRelayCondition = true;
                                    }
                                }
                            }
                        });
                    }
                }
            });
            
            // Combined condition: dist-flow > 0 //OR zone relay condition
            const shouldAnimate = hasDistFlow //|| hasZoneRelayCondition;
            
            
            // Check relay states to determine system state
            const relay5 = dashboardRelays['relay5'];
            const relay6 = dashboardRelays['relay6'];
            const relay3 = dashboardRelays['relay3'];
            const relay9 = dashboardRelays['relay9'];
            
            let currentState = null;
            
            if (relay5 && relay6 && relay3 && relay9) {
                const relay5State = relay5.state;
                const relay6State = relay6.state;
                const relay3State = relay3.state;
                const relay9State = relay9.state;
                
                let hpOn = false;
                // if (relay5State === 'energized' && relay6State === 'deenergized' && hpHasPower) {
                if (hpHasPower) {
                    hpOn = true;
                }
                
                let storeCharge = false;
                let storeDischarge = false;
                if (relay3State === 'energized' && hasPrimFlow) {
                    storeCharge = true;
                // } else if (relay3State === 'deenergized' && relay9State === 'energized' && hasStoreFlow) {
                } else if (hasStoreFlow) {
                    storeDischarge = true;
                }
                
                if (hpOn && storeCharge) {
                    currentState = 'HpOnStoreCharge';
                } else if (hpOn && !storeCharge && !storeDischarge) {
                    currentState = 'HpOnStoreOff';
                } else if (!hpOn && storeDischarge) {
                    currentState = 'HpOffStoreDischarge';
                } else if (!hpOn && !storeCharge && !storeDischarge) {
                    currentState = 'HpOffStoreOff';
                } else {
                    currentState = 'Unknown combined state';
                }
            }
            
            // Update pipe colors and animations based on state
            if (currentState === 'HpOnStoreOff') {
                // Show heat pump animation
                const hpAnimation = document.getElementById('dashboard-hp-animation');
                if (hpAnimation) {
                    hpAnimation.style.display = 'block';
                    // Apply the heat gradient and lines pattern
                    const hpGradientRect = hpAnimation.querySelector('rect[fill*="dashboardHeatGradient"]');
                    const hpLinesRect = hpAnimation.querySelector('rect[fill*="dashboardHeatLinesPattern"]');
                }
                
                // Show buffer animation
                const bufferAnimation = document.getElementById('dashboard-buffer-animation');
                if (bufferAnimation) {
                    bufferAnimation.style.display = 'block';
                    // Apply the top-to-bottom pattern for buffer
                    const bufferRect = bufferAnimation.querySelector('rect');
                    if (bufferRect) {
                        bufferRect.setAttribute('fill', 'url(#dashboardBufferHeatLinesTopToBottom)');
                    }
                }
                
                // Update pipe colors for HpOnStoreOff state
                const hpBufferTopPipe = document.getElementById('dashboard-hp-buffer-top-pipe');
                const hpBufferBottomPipe = document.getElementById('dashboard-hp-buffer-bottom-pipe');
                                
                if (hpBufferTopPipe) {
                    hpBufferTopPipe.setAttribute('fill', 'url(#dashboardFlowPattern)');
                    hpBufferTopPipe.removeAttribute('stroke');
                    hpBufferTopPipe.parentNode.appendChild(hpBufferTopPipe);
                }
                if (hpBufferBottomPipe) {
                    hpBufferBottomPipe.setAttribute('fill', 'url(#dashboardLeftFlowPattern)');
                    hpBufferBottomPipe.removeAttribute('stroke');
                    hpBufferBottomPipe.parentNode.appendChild(hpBufferBottomPipe);
                }
                
                // Reset other pipes to gray for HpOnStoreOff state
                const otherPipes = [
                    'dashboard-tank1-hp-vertical-pipe',
                    'dashboard-tank1-buffer-horizontal-pipe',
                    'dashboard-tank1-connection-pipe',
                    'dashboard-tank3-hp-vertical-pipe',
                    'dashboard-tank3-buffer-horizontal-pipe',
                    'dashboard-tank3-connection-pipe',
                    'dashboard-tank1-hp-vertical-pipe-charge',
                    'dashboard-tank3-hp-vertical-pipe-charge',
                    'dashboard-tank1-connection-pipe-charge',
                    'dashboard-tank3-connection-pipe-charge',
                    'dashboard-tank1-hp-horizontal-pipe-charge',
                    'dashboard-tank3-hp-horizontal-pipe-charge'
                ];
                
                otherPipes.forEach(pipeId => {
                    const pipe = document.getElementById(pipeId);
                    if (pipe) {
                        pipe.setAttribute('fill', '#888');
                        pipe.removeAttribute('stroke');
                    }
                });
                
                // Animate House pipes based on distribution flow
                if (shouldAnimate) {
                    // Show house animation
                    const houseAnimation = document.getElementById('dashboard-house-animation');
                    const houseDropText = document.getElementById('dashboard-house-drop');
                    if (houseAnimation) {
                        houseAnimation.style.display = 'block';
                        houseAnimation.parentNode.appendChild(houseAnimation);
                        // Ensure drop text stays on top
                        if (houseDropText) {
                            houseDropText.parentNode.appendChild(houseDropText);
                        }
                    }
                    
                    // Get house pipe elements
                    const houseHpVerticalPipe = document.getElementById('dashboard-house-hp-vertical-pipe');
                    const houseHpVerticalPipeBottom = document.getElementById('dashboard-house-hp-vertical-pipe-bottom');
                    const houseConnectionPipe = document.getElementById('dashboard-house-connection-pipe');
                    const houseConnectionPipeBottom = document.getElementById('dashboard-house-connection-pipe-bottom');
                    const houseBufferTopPipe = document.getElementById('dashboard-house-buffer-top-pipe');
                    const houseBufferBottomPipe = document.getElementById('dashboard-house-buffer-bottom-pipe');
                    
                    // Right vertical pipe (house-hp-vertical-pipe) - downward flow
                    if (houseHpVerticalPipe) {
                        houseHpVerticalPipe.setAttribute('fill', 'url(#dashboardVerticalDownFlowPattern)');
                        houseHpVerticalPipe.removeAttribute('stroke');
                        houseHpVerticalPipe.parentNode.appendChild(houseHpVerticalPipe);
                    }
                    // Left vertical pipe (house-hp-vertical-pipe-bottom) - upward flow  
                    if (houseHpVerticalPipeBottom) {
                        houseHpVerticalPipeBottom.setAttribute('fill', 'url(#dashboardVerticalFlowPattern)');
                        houseHpVerticalPipeBottom.removeAttribute('stroke');
                        houseHpVerticalPipeBottom.parentNode.appendChild(houseHpVerticalPipeBottom);
                    }
                    // Top connection pipe - leftward flow
                    if (houseConnectionPipe) {
                        houseConnectionPipe.setAttribute('fill', 'url(#dashboardLeftFlowPattern)');
                        houseConnectionPipe.removeAttribute('stroke');
                        houseConnectionPipe.parentNode.appendChild(houseConnectionPipe);
                    }
                    // Bottom connection pipe - leftward flow
                    if (houseConnectionPipeBottom) {
                        houseConnectionPipeBottom.setAttribute('fill', 'url(#dashboardLeftFlowPattern)');
                        houseConnectionPipeBottom.removeAttribute('stroke');
                        houseConnectionPipeBottom.parentNode.appendChild(houseConnectionPipeBottom);
                    }
                    
                    // House to Buffer top pipe - rightward flow
                    if (houseBufferTopPipe) {
                        houseBufferTopPipe.setAttribute('fill', 'url(#dashboardFlowPattern)');
                        houseBufferTopPipe.removeAttribute('stroke');
                        houseBufferTopPipe.parentNode.appendChild(houseBufferTopPipe);
                    }
                    // House to Buffer bottom pipe - NOT animated in HpOnStoreOff
                    // (bottom pipe stays gray)
                } else {
                    // Hide house animation when no distribution flow and no zone relay conditions
                    const houseAnimation = document.getElementById('dashboard-house-animation');
                    if (houseAnimation) {
                        houseAnimation.style.display = 'none';
                    }
                }
                
            } else if (currentState === 'HpOffStoreDischarge') {
                // Hide heat pump animation
                const hpAnimation = document.getElementById('dashboard-hp-animation');
                if (hpAnimation) {
                    hpAnimation.style.display = 'none';
                }
                
                // Show tank animations
                const tank1Animation = document.getElementById('dashboard-tank1-animation');
                const tank2Animation = document.getElementById('dashboard-tank2-animation');
                const tank3Animation = document.getElementById('dashboard-tank3-animation');
                                
                if (tank1Animation) {
                    tank1Animation.style.display = 'block';
                    // Check if the pattern is applied to the rect inside
                    const tank1Rect = tank1Animation.querySelector('rect');
                    if (tank1Rect) {
                        // Apply the bottom-to-top pattern
                        tank1Rect.setAttribute('fill', 'url(#dashboardTankHeatLinesBottomToTop)');
                    }
                }
                if (tank2Animation) {
                    tank2Animation.style.display = 'block';
                    const tank2Rect = tank2Animation.querySelector('rect');
                    if (tank2Rect) {
                        tank2Rect.setAttribute('fill', 'url(#dashboardTankHeatLinesBottomToTop)');
                    }
                }
                if (tank3Animation) {
                    tank3Animation.style.display = 'block';
                    const tank3Rect = tank3Animation.querySelector('rect');
                    if (tank3Rect) {
                        tank3Rect.setAttribute('fill', 'url(#dashboardTankHeatLinesBottomToTop)');
                    }
                }
                
                // Show buffer animation
                const bufferAnimation = document.getElementById('dashboard-buffer-animation');
                if (bufferAnimation) {
                    bufferAnimation.style.display = 'block';
                    // Apply the top-to-bottom pattern for buffer
                    const bufferRect = bufferAnimation.querySelector('rect');
                    if (bufferRect) {
                        bufferRect.setAttribute('fill', 'url(#dashboardBufferHeatLinesTopToBottom)');
                    }
                }
                
                // Animate pipes for HpOffStoreDischarge state
                const tank1HpVerticalPipe = document.getElementById('dashboard-tank1-hp-vertical-pipe');
                const tank1BufferHorizontalPipe = document.getElementById('dashboard-tank1-buffer-horizontal-pipe');
                const tank1ConnectionPipe = document.getElementById('dashboard-tank1-connection-pipe');
                const tank3HpVerticalPipe = document.getElementById('dashboard-tank3-hp-vertical-pipe');
                const tank3BufferHorizontalPipe = document.getElementById('dashboard-tank3-buffer-horizontal-pipe');
                const tank3ConnectionPipe = document.getElementById('dashboard-tank3-connection-pipe');
                                
                if (tank1HpVerticalPipe) {
                    tank1HpVerticalPipe.setAttribute('fill', 'url(#dashboardVerticalFlowPattern)');
                    tank1HpVerticalPipe.removeAttribute('stroke');
                    tank1HpVerticalPipe.parentNode.appendChild(tank1HpVerticalPipe);
                }
                if (tank1BufferHorizontalPipe) {
                    tank1BufferHorizontalPipe.setAttribute('fill', 'url(#dashboardFlowPattern)');
                    tank1BufferHorizontalPipe.removeAttribute('stroke');
                    tank1BufferHorizontalPipe.parentNode.appendChild(tank1BufferHorizontalPipe);
                }
                if (tank1ConnectionPipe) {
                    tank1ConnectionPipe.setAttribute('fill', 'url(#dashboardFlowPattern)');
                    tank1ConnectionPipe.removeAttribute('stroke');
                    tank1ConnectionPipe.parentNode.appendChild(tank1ConnectionPipe);
                }
                if (tank3HpVerticalPipe) {
                    tank3HpVerticalPipe.setAttribute('fill', 'url(#dashboardVerticalDownFlowPattern)');
                    tank3HpVerticalPipe.removeAttribute('stroke');
                    tank3HpVerticalPipe.parentNode.appendChild(tank3HpVerticalPipe);
                }
                if (tank3BufferHorizontalPipe) {
                    tank3BufferHorizontalPipe.setAttribute('fill', 'url(#dashboardLeftFlowPattern)');
                    tank3BufferHorizontalPipe.removeAttribute('stroke');
                    tank3BufferHorizontalPipe.parentNode.appendChild(tank3BufferHorizontalPipe);
                }
                if (tank3ConnectionPipe) {
                    tank3ConnectionPipe.setAttribute('fill', 'url(#dashboardFlowPattern)');
                    tank3ConnectionPipe.removeAttribute('stroke');
                    tank3ConnectionPipe.parentNode.appendChild(tank3ConnectionPipe);
                }
                
                // Reset other pipes to gray for HpOffStoreDischarge state
                const otherPipes = [
                    'dashboard-hp-buffer-top-pipe',
                    'dashboard-hp-buffer-bottom-pipe',
                    'dashboard-tank1-hp-vertical-pipe-charge',
                    'dashboard-tank3-hp-vertical-pipe-charge',
                    'dashboard-tank1-connection-pipe-charge',
                    'dashboard-tank3-connection-pipe-charge',
                    'dashboard-tank1-hp-horizontal-pipe-charge',
                    'dashboard-tank3-hp-horizontal-pipe-charge'
                ];
                
                otherPipes.forEach(pipeId => {
                    const pipe = document.getElementById(pipeId);
                    if (pipe) {
                        pipe.setAttribute('fill', '#888');
                        pipe.removeAttribute('stroke');
                    }
                });
                
                // Animate House pipes based on distribution flow
                if (shouldAnimate) {
                    // Show house animation
                    const houseAnimation = document.getElementById('dashboard-house-animation');
                    const houseDropText = document.getElementById('dashboard-house-drop');
                    if (houseAnimation) {
                        houseAnimation.style.display = 'block';
                        houseAnimation.parentNode.appendChild(houseAnimation);
                        // Ensure drop text stays on top
                        if (houseDropText) {
                            houseDropText.parentNode.appendChild(houseDropText);
                        }
                    }
                    
                    // Get house pipe elements
                    const houseHpVerticalPipe = document.getElementById('dashboard-house-hp-vertical-pipe');
                    const houseHpVerticalPipeBottom = document.getElementById('dashboard-house-hp-vertical-pipe-bottom');
                    const houseConnectionPipe = document.getElementById('dashboard-house-connection-pipe');
                    const houseConnectionPipeBottom = document.getElementById('dashboard-house-connection-pipe-bottom');
                    
                    // Right vertical pipe (house-hp-vertical-pipe) - downward flow
                    if (houseHpVerticalPipe) {
                        houseHpVerticalPipe.setAttribute('fill', 'url(#dashboardVerticalDownFlowPattern)');
                        houseHpVerticalPipe.removeAttribute('stroke');
                        houseHpVerticalPipe.parentNode.appendChild(houseHpVerticalPipe);
                    }
                    // Left vertical pipe (house-hp-vertical-pipe-bottom) - upward flow  
                    if (houseHpVerticalPipeBottom) {
                        houseHpVerticalPipeBottom.setAttribute('fill', 'url(#dashboardVerticalFlowPattern)');
                        houseHpVerticalPipeBottom.removeAttribute('stroke');
                        houseHpVerticalPipeBottom.parentNode.appendChild(houseHpVerticalPipeBottom);
                    }
                    // Top connection pipe - leftward flow
                    if (houseConnectionPipe) {
                        houseConnectionPipe.setAttribute('fill', 'url(#dashboardLeftFlowPattern)');
                        houseConnectionPipe.removeAttribute('stroke');
                        houseConnectionPipe.parentNode.appendChild(houseConnectionPipe);
                    }
                    // Bottom connection pipe - leftward flow
                    if (houseConnectionPipeBottom) {
                        houseConnectionPipeBottom.setAttribute('fill', 'url(#dashboardLeftFlowPattern)');
                        houseConnectionPipeBottom.removeAttribute('stroke');
                        houseConnectionPipeBottom.parentNode.appendChild(houseConnectionPipeBottom);
                    }
                } else {
                    // Hide house animation when no distribution flow and no zone relay conditions
                    const houseAnimation = document.getElementById('dashboard-house-animation');
                    if (houseAnimation) {
                        houseAnimation.style.display = 'none';
                    }
                }
                
            } else if (currentState === 'HpOnStoreCharge') {
                // Show heat pump animation
                const hpAnimation = document.getElementById('dashboard-hp-animation');
                if (hpAnimation) {
                    hpAnimation.style.display = 'block';
                }
                
                // Show tank animations with top-to-bottom flow
                const tank1Animation = document.getElementById('dashboard-tank1-animation');
                const tank2Animation = document.getElementById('dashboard-tank2-animation');
                const tank3Animation = document.getElementById('dashboard-tank3-animation');
                
                if (tank1Animation) {
                    tank1Animation.style.display = 'block';
                    const tank1Rect = tank1Animation.querySelector('rect');
                    if (tank1Rect) {
                        tank1Rect.setAttribute('fill', 'url(#dashboardTankHeatLinesTopToBottom)');
                    }
                }
                if (tank2Animation) {
                    tank2Animation.style.display = 'block';
                    const tank2Rect = tank2Animation.querySelector('rect');
                    if (tank2Rect) {
                        tank2Rect.setAttribute('fill', 'url(#dashboardTankHeatLinesTopToBottom)');
                    }
                }
                if (tank3Animation) {
                    tank3Animation.style.display = 'block';
                    const tank3Rect = tank3Animation.querySelector('rect');
                    if (tank3Rect) {
                        tank3Rect.setAttribute('fill', 'url(#dashboardTankHeatLinesTopToBottom)');
                    }
                }
                
                // Animate pipes for HpOnStoreCharge state
                const tank1HpVerticalPipeCharge = document.getElementById('dashboard-tank1-hp-vertical-pipe-charge');
                const tank3HpVerticalPipeCharge = document.getElementById('dashboard-tank3-hp-vertical-pipe-charge');
                const tank1ConnectionPipeCharge = document.getElementById('dashboard-tank1-connection-pipe-charge');
                const tank3ConnectionPipeCharge = document.getElementById('dashboard-tank3-connection-pipe-charge');
                const tank1HpHorizontalPipeCharge = document.getElementById('dashboard-tank1-hp-horizontal-pipe-charge');
                const tank3HpHorizontalPipeCharge = document.getElementById('dashboard-tank3-hp-horizontal-pipe-charge');
                                
                if (tank1HpVerticalPipeCharge) {
                    tank1HpVerticalPipeCharge.setAttribute('fill', 'url(#dashboardVerticalDownFlowPattern)');
                    tank1HpVerticalPipeCharge.removeAttribute('stroke');
                    tank1HpVerticalPipeCharge.parentNode.appendChild(tank1HpVerticalPipeCharge);
                }
                if (tank3HpVerticalPipeCharge) {
                    tank3HpVerticalPipeCharge.setAttribute('fill', 'url(#dashboardVerticalFlowPattern)');
                    tank3HpVerticalPipeCharge.removeAttribute('stroke');
                    tank3HpVerticalPipeCharge.parentNode.appendChild(tank3HpVerticalPipeCharge);
                }
                if (tank1ConnectionPipeCharge) {
                    tank1ConnectionPipeCharge.setAttribute('fill', 'url(#dashboardLeftFlowPattern)');
                    tank1ConnectionPipeCharge.removeAttribute('stroke');
                    tank1ConnectionPipeCharge.parentNode.appendChild(tank1ConnectionPipeCharge);
                }
                if (tank3ConnectionPipeCharge) {
                    tank3ConnectionPipeCharge.setAttribute('fill', 'url(#dashboardLeftFlowPattern)');
                    tank3ConnectionPipeCharge.removeAttribute('stroke');
                    tank3ConnectionPipeCharge.parentNode.appendChild(tank3ConnectionPipeCharge);
                }
                if (tank1HpHorizontalPipeCharge) {
                    tank1HpHorizontalPipeCharge.setAttribute('fill', 'url(#dashboardFlowPattern)');
                    tank1HpHorizontalPipeCharge.removeAttribute('stroke');
                    tank1HpHorizontalPipeCharge.parentNode.appendChild(tank1HpHorizontalPipeCharge);
                }
                if (tank3HpHorizontalPipeCharge) {
                    tank3HpHorizontalPipeCharge.setAttribute('fill', 'url(#dashboardLeftFlowPattern)');
                    tank3HpHorizontalPipeCharge.removeAttribute('stroke');
                    tank3HpHorizontalPipeCharge.parentNode.appendChild(tank3HpHorizontalPipeCharge);
                }
                
                // Reset other pipes to gray for HpOnStoreCharge state
                const otherPipes = [
                    'dashboard-hp-buffer-top-pipe',
                    'dashboard-hp-buffer-bottom-pipe',
                    'dashboard-tank1-hp-vertical-pipe',
                    'dashboard-tank1-buffer-horizontal-pipe',
                    'dashboard-tank1-connection-pipe',
                    'dashboard-tank3-hp-vertical-pipe',
                    'dashboard-tank3-buffer-horizontal-pipe',
                    'dashboard-tank3-connection-pipe'
                ];
                
                otherPipes.forEach(pipeId => {
                    const pipe = document.getElementById(pipeId);
                    if (pipe) {
                        pipe.setAttribute('fill', '#888');
                        pipe.removeAttribute('stroke');
                    }
                });
                
                // Animate House pipes based on distribution flow
                if (shouldAnimate) {
                    // Show house animation
                    const houseAnimation = document.getElementById('dashboard-house-animation');
                    const houseDropText = document.getElementById('dashboard-house-drop');
                    if (houseAnimation) {
                        houseAnimation.style.display = 'block';
                        houseAnimation.parentNode.appendChild(houseAnimation);
                        // Ensure drop text stays on top
                        if (houseDropText) {
                            houseDropText.parentNode.appendChild(houseDropText);
                        }
                    }
                    
                    // Get house pipe elements
                    const houseHpVerticalPipe = document.getElementById('dashboard-house-hp-vertical-pipe');
                    const houseHpVerticalPipeBottom = document.getElementById('dashboard-house-hp-vertical-pipe-bottom');
                    const houseConnectionPipe = document.getElementById('dashboard-house-connection-pipe');
                    const houseConnectionPipeBottom = document.getElementById('dashboard-house-connection-pipe-bottom');
                    const houseBufferTopPipe = document.getElementById('dashboard-house-buffer-top-pipe');
                    const houseBufferBottomPipe = document.getElementById('dashboard-house-buffer-bottom-pipe');
                    
                    // House to Buffer top pipe - leftward flow (opposite direction from HpOnStoreOff)
                    if (houseBufferTopPipe) {
                        houseBufferTopPipe.setAttribute('fill', 'url(#dashboardLeftFlowPattern)');
                        houseBufferTopPipe.removeAttribute('stroke');
                        houseBufferTopPipe.parentNode.appendChild(houseBufferTopPipe);
                    }
                    // House to Buffer bottom pipe - rightward flow
                    if (houseBufferBottomPipe) {
                        houseBufferBottomPipe.setAttribute('fill', 'url(#dashboardFlowPattern)');
                        houseBufferBottomPipe.removeAttribute('stroke');
                        houseBufferBottomPipe.parentNode.appendChild(houseBufferBottomPipe);
                    }
                    
                    // Animate House vertical pipes
                    // Right vertical pipe (house-hp-vertical-pipe) - downward flow
                    if (houseHpVerticalPipe) {
                        houseHpVerticalPipe.setAttribute('fill', 'url(#dashboardVerticalDownFlowPattern)');
                        houseHpVerticalPipe.removeAttribute('stroke');
                        houseHpVerticalPipe.parentNode.appendChild(houseHpVerticalPipe);
                    }
                    // Left vertical pipe (house-hp-vertical-pipe-bottom) - upward flow  
                    if (houseHpVerticalPipeBottom) {
                        houseHpVerticalPipeBottom.setAttribute('fill', 'url(#dashboardVerticalFlowPattern)');
                        houseHpVerticalPipeBottom.removeAttribute('stroke');
                        houseHpVerticalPipeBottom.parentNode.appendChild(houseHpVerticalPipeBottom);
                    }
                    // Top connection pipe - leftward flow
                    if (houseConnectionPipe) {
                        houseConnectionPipe.setAttribute('fill', 'url(#dashboardLeftFlowPattern)');
                        houseConnectionPipe.removeAttribute('stroke');
                        houseConnectionPipe.parentNode.appendChild(houseConnectionPipe);
                    }
                    // Bottom connection pipe - leftward flow
                    if (houseConnectionPipeBottom) {
                        houseConnectionPipeBottom.setAttribute('fill', 'url(#dashboardLeftFlowPattern)');
                        houseConnectionPipeBottom.removeAttribute('stroke');
                        houseConnectionPipeBottom.parentNode.appendChild(houseConnectionPipeBottom);
                    }
                } else {
                    // Hide house animation when no distribution flow and no zone relay conditions
                    const houseAnimation = document.getElementById('dashboard-house-animation');
                    if (houseAnimation) {
                        houseAnimation.style.display = 'none';
                    }
                    
                    // Reset house-buffer pipes to gray when no animation
                    const houseBufferTopPipe = document.getElementById('dashboard-house-buffer-top-pipe');
                    const houseBufferBottomPipe = document.getElementById('dashboard-house-buffer-bottom-pipe');
                    if (houseBufferTopPipe) {
                        houseBufferTopPipe.setAttribute('fill', '#888');
                        houseBufferTopPipe.removeAttribute('stroke');
                    }
                    if (houseBufferBottomPipe) {
                        houseBufferBottomPipe.setAttribute('fill', '#888');
                        houseBufferBottomPipe.removeAttribute('stroke');
                    }
                    
                    // Reset house vertical pipes to gray when no animation
                    const houseHpVerticalPipe = document.getElementById('dashboard-house-hp-vertical-pipe');
                    const houseHpVerticalPipeBottom = document.getElementById('dashboard-house-hp-vertical-pipe-bottom');
                    const houseConnectionPipe = document.getElementById('dashboard-house-connection-pipe');
                    const houseConnectionPipeBottom = document.getElementById('dashboard-house-connection-pipe-bottom');
                    if (houseHpVerticalPipe) {
                        houseHpVerticalPipe.setAttribute('fill', '#888');
                        houseHpVerticalPipe.removeAttribute('stroke');
                    }
                    if (houseHpVerticalPipeBottom) {
                        houseHpVerticalPipeBottom.setAttribute('fill', '#888');
                        houseHpVerticalPipeBottom.removeAttribute('stroke');
                    }
                    if (houseConnectionPipe) {
                        houseConnectionPipe.setAttribute('fill', '#888');
                        houseConnectionPipe.removeAttribute('stroke');
                    }
                    if (houseConnectionPipeBottom) {
                        houseConnectionPipeBottom.setAttribute('fill', '#888');
                        houseConnectionPipeBottom.removeAttribute('stroke');
                    }
                }
                
            } else {
                // Gray pipes for other states
                // Hide heat pump animation
                const hpAnimation = document.getElementById('dashboard-hp-animation');
                if (hpAnimation) {
                    hpAnimation.style.display = 'none';
                }
                
                // Hide buffer animation for other states (not HpOffStoreOff)
                if (currentState !== 'HpOffStoreOff') {
                    const bufferAnimation = document.getElementById('dashboard-buffer-animation');
                    if (bufferAnimation) {
                        bufferAnimation.style.display = 'none';
                    }
                }
                
                // Hide tank animations for other states
                const tank1Animation = document.getElementById('dashboard-tank1-animation');
                const tank2Animation = document.getElementById('dashboard-tank2-animation');
                const tank3Animation = document.getElementById('dashboard-tank3-animation');
                
                if (tank1Animation) tank1Animation.style.display = 'none';
                if (tank2Animation) tank2Animation.style.display = 'none';
                if (tank3Animation) tank3Animation.style.display = 'none';
                
                // Reset all pipes to gray for other states
                const allPipes = [
                    'dashboard-hp-buffer-top-pipe',
                    'dashboard-hp-buffer-bottom-pipe',
                    'dashboard-tank1-hp-vertical-pipe',
                    'dashboard-tank1-buffer-horizontal-pipe',
                    'dashboard-tank1-connection-pipe',
                    'dashboard-tank3-hp-vertical-pipe',
                    'dashboard-tank3-buffer-horizontal-pipe',
                    'dashboard-tank3-connection-pipe',
                    'dashboard-tank1-hp-vertical-pipe-charge',
                    'dashboard-tank3-hp-vertical-pipe-charge',
                    'dashboard-tank1-connection-pipe-charge',
                    'dashboard-tank3-connection-pipe-charge',
                    'dashboard-tank1-hp-horizontal-pipe-charge',
                    'dashboard-tank3-hp-horizontal-pipe-charge',
                    'dashboard-house-hp-vertical-pipe',
                    'dashboard-house-connection-pipe',
                    'dashboard-house-hp-vertical-pipe-bottom',
                    'dashboard-house-connection-pipe-bottom',
                    'dashboard-house-buffer-top-pipe',
                    'dashboard-house-buffer-bottom-pipe'
                ];
                
                allPipes.forEach(pipeId => {
                    const pipe = document.getElementById(pipeId);
                    if (pipe) {
                        pipe.setAttribute('fill', '#888');
                        pipe.removeAttribute('stroke');
                    }
                });
                
                // Animate House pipes based on distribution flow
                if (shouldAnimate) {
                    // Show house animation
                    const houseAnimation = document.getElementById('dashboard-house-animation');
                    const houseDropText = document.getElementById('dashboard-house-drop');
                    if (houseAnimation) {
                        houseAnimation.style.display = 'block';
                        houseAnimation.parentNode.appendChild(houseAnimation);
                        // Ensure drop text stays on top
                        if (houseDropText) {
                            houseDropText.parentNode.appendChild(houseDropText);
                        }
                    }
                    
                    // Right vertical pipe (house-hp-vertical-pipe) - downward flow
                    const houseHpVerticalPipe = document.getElementById('dashboard-house-hp-vertical-pipe');
                    if (houseHpVerticalPipe) {
                        houseHpVerticalPipe.setAttribute('fill', 'url(#dashboardVerticalDownFlowPattern)');
                        houseHpVerticalPipe.removeAttribute('stroke');
                        houseHpVerticalPipe.parentNode.appendChild(houseHpVerticalPipe);
                    }
                    // Left vertical pipe (house-hp-vertical-pipe-bottom) - upward flow  
                    const houseHpVerticalPipeBottom = document.getElementById('dashboard-house-hp-vertical-pipe-bottom');
                    if (houseHpVerticalPipeBottom) {
                        houseHpVerticalPipeBottom.setAttribute('fill', 'url(#dashboardVerticalFlowPattern)');
                        houseHpVerticalPipeBottom.removeAttribute('stroke');
                        houseHpVerticalPipeBottom.parentNode.appendChild(houseHpVerticalPipeBottom);
                    }
                    // Top connection pipe - leftward flow
                    const houseConnectionPipe = document.getElementById('dashboard-house-connection-pipe');
                    if (houseConnectionPipe) {
                        houseConnectionPipe.setAttribute('fill', 'url(#dashboardLeftFlowPattern)');
                        houseConnectionPipe.removeAttribute('stroke');
                        houseConnectionPipe.parentNode.appendChild(houseConnectionPipe);
                    }
                    // Bottom connection pipe - leftward flow
                    const houseConnectionPipeBottom = document.getElementById('dashboard-house-connection-pipe-bottom');
                    if (houseConnectionPipeBottom) {
                        houseConnectionPipeBottom.setAttribute('fill', 'url(#dashboardLeftFlowPattern)');
                        houseConnectionPipeBottom.removeAttribute('stroke');
                        houseConnectionPipeBottom.parentNode.appendChild(houseConnectionPipeBottom);
                    }
                    
                    // Special logic for HpOffStoreOff: House to Buffer pipes when dist flow is active
                    // (same as HpOnStoreCharge)
                    if (currentState === 'HpOffStoreOff') {
                        // House to Buffer top pipe - leftward flow (same as HpOnStoreCharge)
                        const houseBufferTopPipe = document.getElementById('dashboard-house-buffer-top-pipe');
                        if (houseBufferTopPipe) {
                            houseBufferTopPipe.setAttribute('fill', 'url(#dashboardLeftFlowPattern)');
                            houseBufferTopPipe.removeAttribute('stroke');
                            houseBufferTopPipe.parentNode.appendChild(houseBufferTopPipe);
                        }
                        // House to Buffer bottom pipe - rightward flow (same as HpOnStoreCharge)
                        const houseBufferBottomPipe = document.getElementById('dashboard-house-buffer-bottom-pipe');
                        if (houseBufferBottomPipe) {
                            houseBufferBottomPipe.setAttribute('fill', 'url(#dashboardFlowPattern)');
                            houseBufferBottomPipe.removeAttribute('stroke');
                            houseBufferBottomPipe.parentNode.appendChild(houseBufferBottomPipe);
                        }
                        
                        // Show buffer animation - bottom to top flow (same as HpOnStoreCharge)
                        const bufferAnimation = document.getElementById('dashboard-buffer-animation');
                        if (bufferAnimation) {
                            bufferAnimation.style.display = 'block';
                            bufferAnimation.parentNode.appendChild(bufferAnimation);
                            // Set bottom to top flow pattern
                            const bufferRect = bufferAnimation.querySelector('rect');
                            if (bufferRect) {
                                bufferRect.setAttribute('fill', 'url(#dashboardBufferHeatLinesBottomToTop)');
                            }
                        }
                    }
                } else {
                    // Hide house animation when no distribution flow and no zone relay conditions
                    const houseAnimation = document.getElementById('dashboard-house-animation');
                    if (houseAnimation) {
                        houseAnimation.style.display = 'none';
                    }
                    
                    // Hide buffer animation when no distribution flow (for HpOffStoreOff)
                    if (currentState === 'HpOffStoreOff') {
                        const bufferAnimation = document.getElementById('dashboard-buffer-animation');
                        if (bufferAnimation) {
                            bufferAnimation.style.display = 'none';
                        }
                    }
                }
            }
        }

        function updateTankTemperatures(snapshotData) {
            if (!snapshotData || !snapshotData.LatestReadingList) return;
            
            // Create a lookup map for readings
            const readingsMap = {};
            snapshotData.LatestReadingList.forEach(reading => {
                readingsMap[reading.ChannelName] = reading;
            });
            
            
            // Detect number of depth layers for each component
            const getMaxDepth = (componentName) => {
                let maxDepth = 3; // Default to 3 layers
                for (let depth = 4; depth <= 10; depth++) { // Check up to 10 layers
                    if (readingsMap[`${componentName}-depth${depth}`]) {
                        maxDepth = depth;
                    }
                }
                return maxDepth;
            };
            
            // Update each tank's temperature readings
            for (let tankNum = 1; tankNum <= 3; tankNum++) {
                const maxDepth = getMaxDepth(`tank${tankNum}`);
                
                // Create or update sections dynamically
                createTankSections(tankNum, maxDepth);
                
                for (let depth = 1; depth <= maxDepth; depth++) {
                    const channelName = `tank${tankNum}-depth${depth}`;
                    const reading = readingsMap[channelName];
                    const elementId = `dashboard-tank${tankNum}-depth${depth}`;
                    const element = document.getElementById(elementId);
                    
                    if (element && reading) {
                        // Convert temperature from Celsius * 1000 to Fahrenheit
                        // Formula: °F = (°C * 9/5) + 32
                        const tempC = reading.Value / 1000; // Convert from degCx1000 to degC
                        const tempF = (tempC * 9/5 + 32).toFixed(1); // Convert to Fahrenheit
                        element.textContent = `${tempF}°F`;
                        
                        // Update background color based on temperature
                        const sectionElement = document.getElementById(`dashboard-tank${tankNum}-section${depth}`);
                        if (sectionElement) {
                            const tempFNum = parseFloat(tempF);
                            const backgroundColor = updateLayerBackground(tempFNum);
                            sectionElement.setAttribute('fill', backgroundColor);
                        }
                        
                    } else if (element) {
                        // If no reading available, show placeholder
                        element.textContent = '-';
                        //console.log(`No reading available for ${channelName}`);
                    }
                }
            }
            
            // Update buffer temperature readings
            const bufferMaxDepth = getMaxDepth('buffer');
            
            // Create or update buffer sections dynamically
            createBufferSections(bufferMaxDepth);
            
            for (let depth = 1; depth <= bufferMaxDepth; depth++) {
                const channelName = `buffer-depth${depth}`;
                const reading = readingsMap[channelName];
                const elementId = `dashboard-buffer-depth${depth}`;
                const element = document.getElementById(elementId);
                
                if (element && reading) {
                    // Convert temperature from Celsius * 1000 to Fahrenheit
                    // Formula: °F = (°C * 9/5) + 32
                    const tempC = reading.Value / 1000; // Convert from degCx1000 to degC
                    const tempF = (tempC * 9/5 + 32).toFixed(1); // Convert to Fahrenheit
                    element.textContent = `${tempF}°F`;
                    
                    // Update background color based on temperature
                    const sectionElement = document.getElementById(`dashboard-buffer-section${depth}`);
                    if (sectionElement) {
                        const tempFNum = parseFloat(tempF);
                        const backgroundColor = updateLayerBackground(tempFNum);
                        sectionElement.setAttribute('fill', backgroundColor);
                    }
                    
                } else if (element) {
                    // If no reading available, show placeholder
                    element.textContent = '-';
                    //console.log(`No reading available for ${channelName}`);
                }
            }
            
            // Update heat pump leaving water temperature (hp-lwt)
            const hpLwtReading = readingsMap['hp-lwt'];
            const hpLwtElement = document.getElementById('dashboard-hp-lwt');
            let hpLwtTempF = null;
            
            if (hpLwtElement && hpLwtReading) {
                // Convert temperature from Celsius * 1000 to Fahrenheit
                // Formula: °F = (°C * 9/5) + 32
                const tempC = hpLwtReading.Value / 1000; // Convert from degCx1000 to degC
                hpLwtTempF = parseFloat((tempC * 9/5 + 32).toFixed(1)); // Convert to Fahrenheit
                hpLwtElement.textContent = `${hpLwtTempF}°F`;
                
            } else if (hpLwtElement) {
                // If no reading available, show placeholder
                hpLwtElement.textContent = '-';
                //console.log(`No reading available for hp-lwt`);
            }
            
            // Update heat pump entering water temperature (hp-ewt)
            const hpEwtReading = readingsMap['hp-ewt'];
            const hpEwtElement = document.getElementById('dashboard-hp-ewt');
            let hpEwtTempF = null;
            
            if (hpEwtElement && hpEwtReading) {
                // Convert temperature from Celsius * 1000 to Fahrenheit
                // Formula: °F = (°C * 9/5) + 32
                const tempC = hpEwtReading.Value / 1000; // Convert from degCx1000 to degC
                hpEwtTempF = parseFloat((tempC * 9/5 + 32).toFixed(1)); // Convert to Fahrenheit
                hpEwtElement.textContent = `${hpEwtTempF}°F`;
                
            } else if (hpEwtElement) {
                // If no reading available, show placeholder
                hpEwtElement.textContent = '-';
                //console.log(`No reading available for hp-ewt`);
            }
            
            // Calculate and update heat pump lift (hp-lwt - hp-ewt)
            const hpLiftElement = document.getElementById('dashboard-hp-lift');
            if (hpLiftElement && hpLwtTempF !== null && hpEwtTempF !== null) {
                const lift = (hpLwtTempF - hpEwtTempF).toFixed(1);
                hpLiftElement.innerHTML = `Lift<tspan x="80" dy="1.2em">${lift}°F</tspan>`;
            } else if (hpLiftElement) {
                // If either temperature is not available, show placeholder
                hpLiftElement.innerHTML = `Lift<tspan x="80" dy="1.2em">-°F</tspan>`;
                //console.log(`Cannot calculate lift - missing temperature data`);
            }
            
            // Update heat pump gradient colors based on EWT and LWT temperatures
            const ewtStop = document.getElementById('dashboard-ewt-stop');
            const lwtStop = document.getElementById('dashboard-lwt-stop');
            if (ewtStop && lwtStop && hpEwtTempF !== null && hpLwtTempF !== null) {
                const ewtColor = updateLayerBackground(hpEwtTempF);
                const lwtColor = updateLayerBackground(hpLwtTempF);
                
                // Force update by removing and re-adding the style attribute
                ewtStop.removeAttribute('style');
                lwtStop.removeAttribute('style');
                ewtStop.setAttribute('style', `stop-color:${ewtColor};stop-opacity:1`);
                lwtStop.setAttribute('style', `stop-color:${lwtColor};stop-opacity:1`);
                
                // Also try setting the stop-color attribute directly
                ewtStop.setAttribute('stop-color', ewtColor);
                lwtStop.setAttribute('stop-color', lwtColor);
                
            } else if (ewtStop && lwtStop) {
                // Reset to default colors if temperatures are not available
                ewtStop.removeAttribute('style');
                lwtStop.removeAttribute('style');
                ewtStop.setAttribute('style', 'stop-color:#888;stop-opacity:1');
                lwtStop.setAttribute('style', 'stop-color:#888;stop-opacity:1');
                ewtStop.setAttribute('stop-color', '#888');
                lwtStop.setAttribute('stop-color', '#888');
                //console.log('Reset heat pump gradient to default colors - missing temperature data');
            } else {
                //console.log('Gradient elements not found: ewtStop=', !!ewtStop, 'lwtStop=', !!lwtStop);
            }
            
            // Update buffer hot pipe temperature (buffer-hot-pipe)
            const bufferHotPipeReading = readingsMap['buffer-hot-pipe'];
            const bufferHotPipeElement = document.getElementById('dashboard-buffer-hot-pipe');
            
            if (bufferHotPipeElement && bufferHotPipeReading) {
                // Convert temperature from Celsius * 1000 to Fahrenheit
                // Formula: °F = (°C * 9/5) + 32
                const tempC = bufferHotPipeReading.Value / 1000; // Convert from degCx1000 to degC
                const tempF = (tempC * 9/5 + 32).toFixed(1); // Convert to Fahrenheit
                bufferHotPipeElement.textContent = `${tempF}°F`;
                
            } else if (bufferHotPipeElement) {
                // If no reading available, show placeholder
                bufferHotPipeElement.textContent = '-';
                //console.log(`No reading available for buffer-hot-pipe`);
            }
            
            // Update buffer cold pipe temperature (buffer-cold-pipe)
            const bufferColdPipeReading = readingsMap['buffer-cold-pipe'];
            const bufferColdPipeElement = document.getElementById('dashboard-buffer-cold-pipe');
            
            if (bufferColdPipeElement && bufferColdPipeReading) {
                // Convert temperature from Celsius * 1000 to Fahrenheit
                // Formula: °F = (°C * 9/5) + 32
                const tempC = bufferColdPipeReading.Value / 1000; // Convert from degCx1000 to degC
                const tempF = (tempC * 9/5 + 32).toFixed(1); // Convert to Fahrenheit
                bufferColdPipeElement.textContent = `${tempF}°F`;
                
            } else if (bufferColdPipeElement) {
                // If no reading available, show placeholder
                bufferColdPipeElement.textContent = '-';
                //console.log(`No reading available for buffer-cold-pipe`);
            }
            
            // Update store hot pipe temperature (store-hot-pipe)
            const storeHotPipeReading = readingsMap['store-hot-pipe'];
            const storeHotPipeElement = document.getElementById('dashboard-store-hot-pipe');
            
            
            if (storeHotPipeElement && storeHotPipeReading) {
                // Convert temperature from Celsius * 1000 to Fahrenheit
                // Formula: °F = (°C * 9/5) + 32
                const tempC = storeHotPipeReading.Value / 1000; // Convert from degCx1000 to degC
                const tempF = (tempC * 9/5 + 32).toFixed(1); // Convert to Fahrenheit
                storeHotPipeElement.textContent = `${tempF}°F`;
                
            } else if (storeHotPipeElement) {
                // If no reading available, show placeholder
                storeHotPipeElement.textContent = '-';
                //console.log(`No reading available for store-hot-pipe`);
            }
            
            // Update store cold pipe temperature (store-cold-pipe)
            const storeColdPipeReading = readingsMap['store-cold-pipe'];
            const storeColdPipeElement = document.getElementById('dashboard-store-cold-pipe');
            
            
            if (storeColdPipeElement && storeColdPipeReading) {
                // Convert temperature from Celsius * 1000 to Fahrenheit
                // Formula: °F = (°C * 9/5) + 32
                const tempC = storeColdPipeReading.Value / 1000; // Convert from degCx1000 to degC
                const tempF = (tempC * 9/5 + 32).toFixed(1); // Convert to Fahrenheit
                storeColdPipeElement.textContent = `${tempF}°F`;
                
            } else if (storeColdPipeElement) {
                // If no reading available, show placeholder
                storeColdPipeElement.textContent = '-';
                //console.log(`No reading available for store-cold-pipe`);
            }
            
            // Update house distribution supply water temperature (dist-swt)
            const distSwtReading = readingsMap['dist-swt'];
            let distSwtTempF = null;
            
            if (distSwtReading) {
                // Convert temperature from Celsius * 1000 to Fahrenheit
                // Formula: °F = (°C * 9/5) + 32
                const tempC = distSwtReading.Value / 1000; // Convert from degCx1000 to degC
                distSwtTempF = parseFloat((tempC * 9/5 + 32).toFixed(1)); // Convert to Fahrenheit
            } else {
                //console.log(`No reading available for dist-swt`);
            }
            
            // Update house distribution return water temperature (dist-rwt)
            const distRwtReading = readingsMap['dist-rwt'];
            let distRwtTempF = null;
            
            if (distRwtReading) {
                // Convert temperature from Celsius * 1000 to Fahrenheit
                // Formula: °F = (°C * 9/5) + 32
                const tempC = distRwtReading.Value / 1000; // Convert from degCx1000 to degC
                distRwtTempF = parseFloat((tempC * 9/5 + 32).toFixed(1)); // Convert to Fahrenheit
            } else {
                //console.log(`No reading available for dist-rwt`);
            }
            
            // Calculate and update house drop (dist-swt - dist-rwt)
            const houseDropElement = document.getElementById('dashboard-house-drop');
            if (houseDropElement && distSwtTempF !== null && distRwtTempF !== null) {
                const drop = (distSwtTempF - distRwtTempF).toFixed(1);
                houseDropElement.innerHTML = `Drop<tspan x="720" dy="1.2em">${drop}°F</tspan>`;
            } else if (houseDropElement) {
                // If either temperature is not available, show placeholder
                houseDropElement.innerHTML = `Drop<tspan x="720" dy="1.2em">-°F</tspan>`;
                //console.log(`Cannot calculate drop - missing temperature data`);
            }
            
            // Update individual distribution temperature labels
            const distSwtElement = document.getElementById('dashboard-dist-swt');
            if (distSwtElement) {
                if (distSwtTempF !== null) {
                    distSwtElement.textContent = `${distSwtTempF}°F`;
                } else {
                    distSwtElement.textContent = '-';
                    //console.log(`dist-swt label: no data available`);
                }
            }
            
            const distRwtElement = document.getElementById('dashboard-dist-rwt');
            if (distRwtElement) {
                if (distRwtTempF !== null) {
                    distRwtElement.textContent = `${distRwtTempF}°F`;
                } else {
                    distRwtElement.textContent = '-';
                    //console.log(`dist-rwt label: no data available`);
                }
            }
            
            // Update house gradient colors based on dist-rwt and dist-swt temperatures
            const distRwtStop = document.getElementById('dashboard-dist-rwt-stop');
            const distSwtStop = document.getElementById('dashboard-dist-swt-stop');
            if (distRwtStop && distSwtStop && distRwtTempF !== null && distSwtTempF !== null) {
                const distRwtColor = updateLayerBackground(distRwtTempF);
                const distSwtColor = updateLayerBackground(distSwtTempF);
                
                // Force update by removing and re-adding the style attribute
                distRwtStop.removeAttribute('style');
                distSwtStop.removeAttribute('style');
                distRwtStop.setAttribute('style', `stop-color:${distRwtColor};stop-opacity:1`);
                distSwtStop.setAttribute('style', `stop-color:${distSwtColor};stop-opacity:1`);
                
                // Also try setting the stop-color attribute directly
                distRwtStop.setAttribute('stop-color', distRwtColor);
                distSwtStop.setAttribute('stop-color', distSwtColor);
                
            } else if (distRwtStop && distSwtStop) {
                // Reset to default colors if temperatures are not available
                distRwtStop.removeAttribute('style');
                distSwtStop.removeAttribute('style');
                distRwtStop.setAttribute('style', 'stop-color:#888;stop-opacity:1');
                distSwtStop.setAttribute('style', 'stop-color:#888;stop-opacity:1');
                distRwtStop.setAttribute('stop-color', '#888');
                distSwtStop.setAttribute('stop-color', '#888');
                //console.log('Reset house gradient to default colors - missing temperature data');
            } else {
                //console.log('House gradient elements not found: distRwtStop=', !!distRwtStop, 'distSwtStop=', !!distSwtStop);
            }
        }

        function updateLayerBackground(temp) {
            const minTemp = 50;
            const maxTemp = 160;
            const normalizedTemp = (temp - minTemp) / (maxTemp - minTemp);
            const red = Math.min(255, Math.floor(255 * normalizedTemp));
            const blue = Math.min(255, Math.floor(255 * (1 - normalizedTemp)));
            const backgroundColor = `rgba(${red}, 0, ${blue}, 0.86)`;
            return backgroundColor;
        }

        function createTankSections(tankNum, maxDepth) {
            // Tank positions
            const tankPositions = {
                1: { x: 460, y: 280 },
                2: { x: 330, y: 280 },
                3: { x: 200, y: 280 }
            };
            
            const pos = tankPositions[tankNum];
            if (!pos) return;
            
            const sectionHeight = 200 / maxDepth; // Divide total height by number of sections
            
            // Clear existing sections for this tank
            for (let i = 1; i <= 10; i++) {
                const existingSection = document.getElementById(`dashboard-tank${tankNum}-section${i}`);
                const existingText = document.getElementById(`dashboard-tank${tankNum}-depth${i}`);
                if (existingSection) existingSection.remove();
                if (existingText) existingText.remove();
            }
            
            // Create new sections
            for (let depth = 1; depth <= maxDepth; depth++) {
                const y = pos.y + (depth - 1) * sectionHeight;
                const height = sectionHeight;
                
                // Create section element
                let sectionElement;
                if (depth === 1) {
                    // Top section - rounded top corners only
                    sectionElement = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    const d = `M ${pos.x},${y + 10} Q ${pos.x},${y} ${pos.x + 10},${y} L ${pos.x + 110},${y} Q ${pos.x + 120},${y} ${pos.x + 120},${y + 10} L ${pos.x + 120},${y + height} L ${pos.x},${y + height} Z`;
                    sectionElement.setAttribute('d', d);
                } else if (depth === maxDepth) {
                    // Bottom section - rounded bottom corners only
                    sectionElement = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    const d = `M ${pos.x},${y} L ${pos.x + 120},${y} L ${pos.x + 120},${y + height - 10} Q ${pos.x + 120},${y + height} ${pos.x + 110},${y + height} L ${pos.x + 10},${y + height} Q ${pos.x},${y + height} ${pos.x},${y + height - 10} Z`;
                    sectionElement.setAttribute('d', d);
                } else {
                    // Middle section - no rounded corners
                    sectionElement = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    sectionElement.setAttribute('x', pos.x);
                    sectionElement.setAttribute('y', y);
                    sectionElement.setAttribute('width', 120);
                    sectionElement.setAttribute('height', height);
                }
                
                sectionElement.setAttribute('id', `dashboard-tank${tankNum}-section${depth}`);
                sectionElement.setAttribute('fill', '#444');
                
                // Insert after the tank background rectangle
                const tankRect = document.querySelector(`rect[x="${pos.x}"][y="${pos.y}"]`);
                if (tankRect) {
                    tankRect.parentNode.insertBefore(sectionElement, tankRect.nextSibling);
                }
                
                // Create text element
                const textElement = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                textElement.setAttribute('id', `dashboard-tank${tankNum}-depth${depth}`);
                textElement.setAttribute('x', pos.x + 60);
                textElement.setAttribute('y', y + height / 2 + 4);
                textElement.setAttribute('text-anchor', 'middle');
                textElement.setAttribute('fill', 'white');
                textElement.setAttribute('font-family', 'Montserrat, sans-serif');
                textElement.setAttribute('font-size', '14');
                textElement.setAttribute('font-weight', '600');
                textElement.textContent = '-';
                
                sectionElement.parentNode.insertBefore(textElement, sectionElement.nextSibling);
            }
        }

        function createBufferSections(maxDepth) {
            const pos = { x: 860, y: 50 };
            const sectionHeight = 200 / maxDepth; // Divide total height by number of sections
            
            // Clear existing sections for buffer
            for (let i = 1; i <= 10; i++) {
                const existingSection = document.getElementById(`dashboard-buffer-section${i}`);
                const existingText = document.getElementById(`dashboard-buffer-depth${i}`);
                if (existingSection) existingSection.remove();
                if (existingText) existingText.remove();
            }
            
            // Create new sections
            for (let depth = 1; depth <= maxDepth; depth++) {
                const y = pos.y + (depth - 1) * sectionHeight;
                const height = sectionHeight;
                
                // Create section element
                let sectionElement;
                if (depth === 1) {
                    // Top section - rounded top corners only
                    sectionElement = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    const d = `M ${pos.x},${y + 10} Q ${pos.x},${y} ${pos.x + 10},${y} L ${pos.x + 110},${y} Q ${pos.x + 120},${y} ${pos.x + 120},${y + 10} L ${pos.x + 120},${y + height} L ${pos.x},${y + height} Z`;
                    sectionElement.setAttribute('d', d);
                } else if (depth === maxDepth) {
                    // Bottom section - rounded bottom corners only
                    sectionElement = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    const d = `M ${pos.x},${y} L ${pos.x + 120},${y} L ${pos.x + 120},${y + height - 10} Q ${pos.x + 120},${y + height} ${pos.x + 110},${y + height} L ${pos.x + 10},${y + height} Q ${pos.x},${y + height} ${pos.x},${y + height - 10} Z`;
                    sectionElement.setAttribute('d', d);
                } else {
                    // Middle section - no rounded corners
                    sectionElement = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    sectionElement.setAttribute('x', pos.x);
                    sectionElement.setAttribute('y', y);
                    sectionElement.setAttribute('width', 120);
                    sectionElement.setAttribute('height', height);
                }
                
                sectionElement.setAttribute('id', `dashboard-buffer-section${depth}`);
                sectionElement.setAttribute('fill', '#444');
                
                // Insert after the buffer background rectangle
                const bufferRect = document.querySelector(`rect[x="860"][y="50"]`);
                if (bufferRect) {
                    bufferRect.parentNode.insertBefore(sectionElement, bufferRect.nextSibling);
                }
                
                // Create text element
                const textElement = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                textElement.setAttribute('id', `dashboard-buffer-depth${depth}`);
                textElement.setAttribute('x', pos.x + 60);
                textElement.setAttribute('y', y + height / 2 + 4);
                textElement.setAttribute('text-anchor', 'middle');
                textElement.setAttribute('fill', 'white');
                textElement.setAttribute('font-family', 'Montserrat, sans-serif');
                textElement.setAttribute('font-size', '14');
                textElement.setAttribute('font-weight', '600');
                textElement.textContent = '-';
                
                sectionElement.parentNode.insertBefore(textElement, sectionElement.nextSibling);
            }
        }

        // Initialize diagram with default 3 layers for each component
        function initializeDiagram() {
            // Initialize tanks with 3 layers each
            for (let tankNum = 1; tankNum <= 3; tankNum++) {
                createTankSections(tankNum, 3);
            }
            
            // Initialize buffer with 3 layers
            createBufferSections(3);
        }

        // Initialize dashboard when the dashboard card becomes visible and a house is selected
        function initializeDashboard() {
            const selectedHouse = document.getElementById('selected-house').value;
            const dashboardCard = document.getElementById('dashboard-card');
            
            if (dashboardCard && !dashboardCard.classList.contains('hidden')) {
                // Initialize the diagram with default tank sections
                initializeDiagram();
                
                if (selectedHouse && selectedHouse.trim() !== '') {
                    if (selectedHouse.includes('Select a single house in the table')) {
                        // Multiple houses selected, show message
                        showDashboardMultipleHousesMessage();
                    } else {
                        // A single house is selected, connect to WebSocket
                        connectDashboardWebSocket();
                    }
                } else {
                    // No house selected, show message
                    showDashboardNoHouseMessage();
                }
            }
        }

            // Show "No house selected" message in dashboard
            function showDashboardNoHouseMessage() {
                const statusLeft = document.getElementById('dashboard-status-left');
                const statusRight = document.getElementById('dashboard-status-right');
                const snapshotTime = document.getElementById('dashboard-snapshot-timestamp');
                const systemDiagram = document.getElementById('dashboard-system-diagram');
                const monitoringTables = document.getElementById('dashboard-monitoring-tables');
                
                if (statusLeft) statusLeft.textContent = 'No house selected';
                if (statusLeft) statusLeft.style.color = 'var(--text-muted)';
                if (statusRight) statusRight.textContent = '';
                if (snapshotTime) snapshotTime.style.display = 'none';
                if (systemDiagram) systemDiagram.style.display = 'none';
                if (monitoringTables) monitoringTables.style.display = 'none';
                
                // Disconnect WebSocket if connected
                if (dashboardWebsocket) {
                    dashboardWebsocket.close();
                    dashboardWebsocket = null;
                }
            }

        // Show "Multiple houses selected" message in dashboard
        function showDashboardMultipleHousesMessage() {
            const statusLeft = document.getElementById('dashboard-status-left');
            const statusRight = document.getElementById('dashboard-status-right');
            const snapshotTime = document.getElementById('dashboard-snapshot-timestamp');
            const systemDiagram = document.getElementById('dashboard-system-diagram');
            const monitoringTables = document.getElementById('dashboard-monitoring-tables');
            
            if (statusLeft) statusLeft.textContent = 'Multiple houses selected';
            if (statusLeft) statusLeft.style.color = 'var(--text-muted)';
            if (statusRight) statusRight.textContent = '';
            if (snapshotTime) snapshotTime.textContent = '-';
            if (systemDiagram) systemDiagram.style.display = 'none';
            if (monitoringTables) monitoringTables.style.display = 'none';
        }

        // Show dashboard content when house is selected
        function showDashboardContent() {
            const systemDiagram = document.getElementById('dashboard-system-diagram');
            const monitoringTables = document.getElementById('dashboard-monitoring-tables');
            
            if (systemDiagram) systemDiagram.style.display = 'block';
            if (monitoringTables) monitoringTables.style.display = 'flex';
        }

        // Function to clear electricity plots
        function clearElectricityPlots() {
            const plotDiv = document.getElementById('electricity-plot');
            while (plotDiv.firstChild) {
                plotDiv.removeChild(plotDiv.firstChild);
            }
            const plotContainer = document.getElementById('electricity-plot-container');
            plotContainer.style.display = 'none';
        }

        // Function to set now for electricity card
        function setElectricityNow() {
            const nyDate = new Date(new Date().toLocaleString("en-US", { timeZone: "America/New_York" }));
            nyDate.setMinutes(nyDate.getMinutes() + 1);
            document.getElementById('electricity-end-date').value = nyDate.toISOString().split('T')[0];
            document.getElementById('electricity-end-time').value = nyDate.toTimeString().split(' ')[0].substring(0, 5);
        }

        // Function to get selected house aliases
        function getSelectedHouseAliases() {
            const selectedHouseInput = document.getElementById('electricity-selected-house');
            const selectedHouse = selectedHouseInput.value.trim();
            
            // If a house is selected, return just that house
            if (selectedHouse && selectedHouse !== 'Aggregate of all houses in the table') {
                return [selectedHouse];
            }
            
            // Otherwise, get all visible houses from the table
            const visibleRows = Array.from(document.querySelectorAll('.expandable-row'))
                .filter(row => row.style.display !== 'none');
            
            return visibleRows.map(row => row.cells[0].textContent.trim());
        }

        // Function to fetch electricity use plots
        async function fetchElectricityPlots() {
            const plotBtn = document.getElementById('electricity-plot-btn');
            
            plotBtn.disabled = true;
            plotBtn.style.opacity = '0.5';
            
            const startDate = document.getElementById('electricity-start-date').value;
            const startTime = document.getElementById('electricity-start-time').value;
            const endDate = document.getElementById('electricity-end-date').value;
            const endTime = document.getElementById('electricity-end-time').value;

            const startDateTime = luxon.DateTime.fromFormat(`${startDate} ${startTime}`, 'yyyy-MM-dd HH:mm', { zone: 'America/New_York' });
            const endDateTime = luxon.DateTime.fromFormat(`${endDate} ${endTime}`, 'yyyy-MM-dd HH:mm', { zone: 'America/New_York' });
            
            const startUnixMilliseconds = startDateTime.toUTC().toMillis();
            const endUnixMilliseconds = endDateTime.toUTC().toMillis();
            
            try {
                // Check if we're in dark mode
                const isDarkMode = root.getAttribute('data-theme') === 'dark' || 
                    (root.getAttribute('data-theme') === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);

                const selectedAliases = getSelectedHouseAliases();
                // console.log(selectedAliases)
                
                const response = await fetch(`${api_host}/electricity-use`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify({
                        selected_short_aliases: selectedAliases,
                        darkmode: isDarkMode,
                        start_ms: startUnixMilliseconds,
                        end_ms: endUnixMilliseconds
                    })
                });

                const contentType = response.headers.get("Content-Type");
                if (contentType && contentType.includes("application/json")) {
                    const data = await response.json();
                    if ('success' in data && data.success === false) {
                        console.error('Error:', data.message);
                        clearElectricityPlots();
                        const plotContainer = document.getElementById('electricity-plot-container');
                        const plotDiv = document.getElementById('electricity-plot');
                        plotContainer.style.display = 'block';
                        plotDiv.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 2rem; font-size: 0.875rem;">Could not find data for the selected house(s) during this period.</div>';
                    }
                } else {
                    const blob = await response.blob();
                    const zip = await JSZip.loadAsync(blob);
                    clearElectricityPlots();
                    
                    const plotContainer = document.getElementById('electricity-plot-container');
                    plotContainer.style.display = 'block';
                    
                    const plotDiv = document.getElementById('electricity-plot');

                    let hasPlots = false;
                    for (const filename of Object.keys(zip.files)) {
                        const fileData = await zip.files[filename].async('blob');
                        if (filename.endsWith('.html')) {
                            hasPlots = true;
                            const blob = new Blob([await zip.files[filename].async('text')], { type: 'text/html' });
                            const htmlUrl = URL.createObjectURL(blob);
                            const iframe = document.createElement('iframe');
                            iframe.src = htmlUrl;
                            iframe.style.width = window.innerWidth < 650 ? '100%' : '97.5%';
                            iframe.style.height = '375px';
                            iframe.style.maxWidth = '1500px';
                            iframe.style.border = 'none';
                            plotDiv.appendChild(iframe);
                        }
                    }

                    if (!hasPlots) {
                        plotDiv.innerHTML = '<div style="color: var(--danger-color); text-align: center; padding: 2rem; font-size: 0.875rem;">Could not find data for this house and time frame</div>';
                    }
                }
            } catch (error) {
                console.error('Error getting electricity plots:', error);
                clearElectricityPlots();
                const plotContainer = document.getElementById('electricity-plot-container');
                const plotDiv = document.getElementById('electricity-plot');
                plotContainer.style.display = 'block';
                plotDiv.innerHTML = '<div style="color: var(--danger-color); text-align: center; padding: 2rem; font-size: 0.875rem;">Could not find data for this house and time frame</div>';
            } finally {
                plotBtn.disabled = false;
                plotBtn.style.opacity = '1';
            }
        }

        // Add event listener for the electricity plot button
        document.getElementById('electricity-plot-btn').addEventListener('click', fetchElectricityPlots);

        // Function to export electricity use CSV
        async function exportElectricityCSV() {
            const csvBtn = document.getElementById('electricity-csv-btn');
            
            csvBtn.disabled = true;
            csvBtn.style.opacity = '0.5';
            
            const startDate = document.getElementById('electricity-start-date').value;
            const startTime = document.getElementById('electricity-start-time').value;
            const endDate = document.getElementById('electricity-end-date').value;
            const endTime = document.getElementById('electricity-end-time').value;

            const startDateTime = luxon.DateTime.fromFormat(`${startDate} ${startTime}`, 'yyyy-MM-dd HH:mm', { zone: 'America/New_York' });
            const endDateTime = luxon.DateTime.fromFormat(`${endDate} ${endTime}`, 'yyyy-MM-dd HH:mm', { zone: 'America/New_York' });
            
            const startUnixMilliseconds = startDateTime.toUTC().toMillis();
            const endUnixMilliseconds = endDateTime.toUTC().toMillis();
            
            try {
                const selectedAliases = getSelectedHouseAliases();
                
                const response = await fetch(`${api_host}/electricity-use-csv`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify({
                        selected_short_aliases: selectedAliases,
                        start_ms: startUnixMilliseconds,
                        end_ms: endUnixMilliseconds
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const contentDisposition = response.headers.get('Content-Disposition');
                const filename = contentDisposition.split('filename=')[1].replace(/"/g, '');
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error getting electricity use CSV:', error);
            } finally {
                csvBtn.disabled = false;
                csvBtn.style.opacity = '1';
            }
        }

        // Add event listener for the electricity CSV button
        document.getElementById('electricity-csv-btn').addEventListener('click', exportElectricityCSV);

        // Function to acknowledge alert
        async function reactToAlert(homeId, new_status) {
            try {
                const house = window.houses.find(h => String(h.unique_id) === String(homeId));
                if (!house) {
                    console.error('House not found');
                    return;
                }

                // Disable all "Close alert" buttons
                document.querySelectorAll('button[onclick^="reactToAlert"]').forEach(button => {
                    button.disabled = true;
                    button.style.opacity = '0.5';
                });

                const response = await fetch(`${api_host}/alert-reaction`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ 
                        house_alias: house.short_alias,
                        new_status: new_status
                    })
                });
                
                if (!response.ok) {
                    console.error('Failed to acknowledge alert');
                } else {
                    // Scroll to top and reload after 1.5 seconds
                    window.scrollTo(0, 0);
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                }
            } catch (error) {
                console.error('Error acknowledging alert:', error);
            }
        }

        // Function to update SCADA code for selected houses
        async function updateScadaCode() {
            const selectedAliases = getSelectedHouseAliases();
            const updateScadaBtn = document.getElementById('update-scada-btn');
            
            if (selectedAliases.length === 0) {
                alert('Please select at least one house to update SCADA code.');
                return;
            }

            // Ask user if they want to update packages
            const updatePackages = confirm("Also update packages? This might take a few minutes. Click OK to update packages, or Cancel to update only SCADA code.");

            // Disable button and show loading state
            updateScadaBtn.disabled = true;
            updateScadaBtn.style.opacity = '0.5';
            updateScadaBtn.innerHTML = '<i class="bi bi-cloud-download fs-6"></i>';

            try {
                const response = await fetch(`${api_host}/update-scada-code`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify({
                        selected_short_aliases: selectedAliases,
                        update_packages: updatePackages
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to update SCADA code');
                }

                // Reload the page to show updated data
                window.location.reload();
            } catch (error) {
                console.error('Error updating SCADA code:', error);
                alert('Failed to update SCADA code. Please try again.');
                // Re-enable button and restore original state
                updateScadaBtn.disabled = false;
                updateScadaBtn.style.opacity = '1';
                updateScadaBtn.innerHTML = '<span>Pull</span>';
            }
        }

        // Loader functionality - synchronized with real clock time
        function updateLoaderProgress() {
            const loaderProgress = document.getElementById('loader-progress');
            if (!loaderProgress) return;
            
            const now = new Date();
            const seconds = now.getSeconds();
            const milliseconds = now.getMilliseconds();
            
            let progress;
            let nextTrigger;
            
            if (seconds < 30) {
                // We're in the first half of the minute (xx:00 to xx:30)
                // Progress from 0% to 100% over 30 seconds
                progress = (seconds + milliseconds / 1000) / 30 * 100;
                nextTrigger = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 
                                     now.getHours(), now.getMinutes(), 30, 0);
            } else {
                // We're in the second half of the minute (xx:30 to xx:00)
                // Progress from 0% to 100% over 30 seconds
                progress = ((seconds - 30) + milliseconds / 1000) / 30 * 100;
                nextTrigger = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 
                                     now.getHours(), now.getMinutes() + 1, 0, 0);
            }
            
            // Set the progress bar width
            loaderProgress.style.width = Math.min(100, Math.max(0, progress)) + '%';
            
            // Schedule next update in 100ms for smooth animation
            setTimeout(updateLoaderProgress, 100);
        }

        // Initialize loader animation when page loads
        document.addEventListener('DOMContentLoaded', function() {
            updateLoaderProgress();
        });
    </script>
</body>
</html> 